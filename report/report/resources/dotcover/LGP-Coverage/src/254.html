<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_254 = [
   [22,9,22,10,'dccv']
, [23,13,23,106,'dccv']
, [24,13,24,92,'dccv']
, [25,9,25,10,'dccv']
, [27,9,27,79,'dccv']
, [28,9,28,10,'dccv']
, [30,13,30,14,'dccv']
, [31,17,31,76,'dccv']
, [32,17,32,39,'dccv']
, [33,17,33,41,'dccv']
, [34,17,34,32,'dccv']
, [35,17,35,48,'dccv']
, [36,17,36,29,'dccv']
, [37,13,37,14,'dccv']
, [42,9,42,10,'dccv']
, [46,9,46,10,'dccv']
, [48,13,48,14,'dccv']
, [49,17,49,24,'dccv']
, [49,41,49,70,'dccv']
, [49,26,49,37,'dccv']
, [50,17,50,18,'dccv']
, [51,21,51,101,'dccv']
, [52,17,52,18,'dccv']
, [49,38,49,40,'dccv']
, [53,13,53,14,'dccv']
, [58,9,58,10,'dccv']
, [62,9,62,10,'dccv']
, [64,13,64,14,'dccv']
, [65,17,65,107,'dccv']
, [67,17,67,83,'dccv']
, [69,17,69,57,'dccv']
, [70,17,70,18,'dccv']
, [71,21,71,28,'dccv']
, [71,58,71,82,'dccv']
, [71,30,71,54,'dccv']
, [72,21,72,22,'dccv']
, [73,25,73,137,'dccv']
, [75,25,75,68,'dccv']
, [76,25,76,26,'dccv']
, [77,34,77,44,'dccv']
, [78,29,78,30,'dccv']
, [79,33,79,99,'dccv']
, [80,33,80,105,'dccv']
, [81,33,81,51,'dccv']
, [83,33,83,105,'dccv']
, [85,33,85,40,'dccv']
, [85,62,85,81,'dccv']
, [85,42,85,58,'dccv']
, [86,33,86,34,'dccv']
, [87,37,87,169,'dccv']
, [88,37,88,38,'dccv']
, [89,41,89,74,'dccv']
, [90,41,90,54,'dccv']
, [91,37,91,38,'dccv']
, [92,33,92,34,'dccv']
, [85,59,85,61,'dccv']
, [94,33,94,45,'dccv']
, [95,33,95,34,'dccv']
, [96,37,96,121,'dccv']
, [97,33,97,34,'dccv']
, [98,29,98,30,'dccv']
, [77,84,77,90,'dccv']
, [77,45,77,82,'dccv']
, [99,25,99,26,'dccv']
, [100,21,100,22,'dccv']
, [71,55,71,57,'dccv']
, [101,17,101,18,'dccv']
, [103,22,103,32,'dccv']
, [104,17,104,18,'dccv']
, [105,21,105,39,'dccv']
, [107,21,107,28,'dccv']
, [107,50,107,63,'dccv']
, [107,30,107,46,'dccv']
, [108,21,108,22,'dccv']
, [109,25,109,99,'dccv']
, [110,25,110,26,'dccv']
, [111,29,111,42,'dccv']
, [112,25,112,26,'dccv']
, [113,21,113,22,'dccv']
, [107,47,107,49,'dccv']
, [115,21,115,33,'dccv']
, [119,17,119,18,'dccv']
, [103,64,103,67,'dccv']
, [103,33,103,62,'dccv']
, [121,22,121,32,'dccv']
, [122,17,122,18,'dccv']
, [123,21,123,39,'dccv']
, [125,21,125,28,'dccv']
, [125,50,125,63,'dccv']
, [125,30,125,46,'dccv']
, [126,21,126,22,'dccv']
, [127,25,127,85,'dccv']
, [128,25,128,84,'dccv']
, [129,25,129,26,'dccv']
, [130,29,130,42,'dccv']
, [131,25,131,26,'dccv']
, [132,21,132,22,'dccv']
, [125,47,125,49,'dccv']
, [134,21,134,33,'dccv']
, [138,17,138,18,'dccv']
, [121,64,121,67,'dccv']
, [121,33,121,62,'dccv']
, [139,13,139,14,'dccv']
, [144,9,144,10,'dccv']
, [147,9,147,10,'dccv']
, [148,13,148,40,'dccv']
, [149,9,149,10,'dccv']
, [194,9,194,10,'dccv']
, [196,13,196,14,'dccv']
, [197,22,197,32,'dccv']
, [198,17,198,18,'dccv']
, [199,21,199,53,'dccv']
, [200,17,200,18,'dccv']
, [197,64,197,67,'dccv']
, [197,33,197,62,'dccv']
, [201,13,201,14,'dccv']
, [206,9,206,10,'dccv']
, [38,13,38,37,'dcuc']
, [39,13,39,14,'dcuc']
, [40,17,40,53,'dcuc']
, [41,13,41,14,'dcuc']
, [54,13,54,37,'dcuc']
, [55,13,55,14,'dcuc']
, [56,17,56,53,'dcuc']
, [57,13,57,14,'dcuc']
, [116,21,116,22,'dcuc']
, [117,25,117,69,'dcuc']
, [118,21,118,22,'dcuc']
, [135,21,135,22,'dcuc']
, [136,25,136,69,'dcuc']
, [137,21,137,22,'dcuc']
, [140,13,140,37,'dcuc']
, [141,13,141,14,'dcuc']
, [142,17,142,53,'dcuc']
, [143,13,143,14,'dcuc']
, [153,9,153,10,'dcuc']
, [155,13,155,14,'dcuc']
, [156,22,156,32,'dcuc']
, [157,17,157,18,'dcuc']
, [158,21,158,65,'dcuc']
, [159,21,159,22,'dcuc']
, [160,25,160,57,'dcuc']
, [162,17,162,18,'dcuc']
, [156,64,156,67,'dcuc']
, [156,33,156,62,'dcuc']
, [163,17,163,29,'dcuc']
, [165,13,165,37,'dcuc']
, [166,13,166,14,'dcuc']
, [167,17,167,53,'dcuc']
, [168,17,168,29,'dcuc']
, [170,9,170,10,'dcuc']
, [174,9,174,10,'dcuc']
, [176,13,176,14,'dcuc']
, [177,22,177,32,'dcuc']
, [178,17,178,18,'dcuc']
, [179,21,179,82,'dcuc']
, [180,21,180,22,'dcuc']
, [181,25,181,57,'dcuc']
, [183,17,183,18,'dcuc']
, [177,64,177,67,'dcuc']
, [177,33,177,62,'dcuc']
, [184,17,184,29,'dcuc']
, [186,13,186,37,'dcuc']
, [187,13,187,14,'dcuc']
, [188,17,188,53,'dcuc']
, [189,17,189,29,'dcuc']
, [191,9,191,10,'dcuc']
, [202,13,202,37,'dcuc']
, [203,13,203,14,'dcuc']
, [204,17,204,53,'dcuc']
, [205,13,205,14,'dcuc']
, [209,9,209,10,'dcuc']
, [211,13,211,14,'dcuc']
, [212,22,212,32,'dcuc']
, [213,17,213,18,'dcuc']
, [214,21,214,65,'dcuc']
, [215,17,215,18,'dcuc']
, [212,64,212,67,'dcuc']
, [212,33,212,62,'dcuc']
, [216,17,216,29,'dcuc']
, [217,17,217,45,'dcuc']
, [218,13,218,14,'dcuc']
, [219,13,219,37,'dcuc']
, [220,13,220,14,'dcuc']
, [221,17,221,53,'dcuc']
, [222,13,222,14,'dcuc']
, [223,9,223,10,'dcuc']
, [227,9,227,10,'dcuc']
, [229,13,229,14,'dcuc']
, [230,17,230,88,'dcuc']
, [231,17,231,52,'dcuc']
, [232,17,232,32,'dcuc']
, [234,13,234,37,'dcuc']
, [235,13,235,14,'dcuc']
, [236,17,236,53,'dcuc']
, [237,17,237,29,'dcuc']
, [239,9,239,10,'dcuc']
, [246,9,246,10,'dcuc']
, [248,13,248,14,'dcuc']
, [249,22,249,32,'dcuc']
, [250,17,250,18,'dcuc']
, [251,21,251,82,'dcuc']
, [252,21,252,22,'dcuc']
, [253,25,253,69,'dcuc']
, [254,21,254,22,'dcuc']
, [255,17,255,18,'dcuc']
, [249,64,249,67,'dcuc']
, [249,33,249,62,'dcuc']
, [256,13,256,14,'dcuc']
, [257,13,257,37,'dcuc']
, [258,13,258,14,'dcuc']
, [259,17,259,53,'dcuc']
, [260,13,260,14,'dcuc']
, [261,9,261,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src254" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.Text.RegularExpressions;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;

#endregion

namespace LGP.Modules.ModuleEditor.Internal
{
    internal class ModuleFileGrammerStateHandler
    {
        private static readonly Regex GrammerMethodRegex;
        private static readonly Regex GrammerMethodParamsRegex;
        private readonly IModule _filestate;
        private readonly List&lt; ModuleFileGrammerState &gt; _grammerStates;
        private readonly IModule _module;

        static ModuleFileGrammerStateHandler()
        {
            GrammerMethodRegex = new Regex( &quot;addGrammer\\s*\\((.*?)\\)\\s*;&quot; , RegexOptions.Singleline );
            GrammerMethodParamsRegex = new Regex( &quot;(\&quot;(.*?)\&quot;)&quot; , RegexOptions.Singleline); //  (\&quot;|&#39;)(.*?)(\&quot;|&#39;)
        }

        public ModuleFileGrammerStateHandler( IModule state , IModule module )
        {
            try
            {
                this._grammerStates = new List&lt; ModuleFileGrammerState &gt;();
                this._module = module;
                this._filestate = state;
                this.Prepare();
                this.SynchronizeDbWithStates();
                this.Save();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public void Prepare()
        {
            try
            {
                foreach( var grammer in this._module.GetAllGrammers() )
                {
                    this._grammerStates.Add( new ModuleFileGrammerState( grammer , this._module ) );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public void SynchronizeDbWithStates()
        {
            try
            {
                var grammerMethodsCollection = GrammerMethodRegex.Matches( this._filestate.FileContents );

                var foundGrammers = new List&lt; KeyValuePair&lt; string , string &gt; &gt;();

                if( grammerMethodsCollection.Count &gt; 0 )
                {
                    foreach( Match grammerMethodMatch in grammerMethodsCollection )
                    {
                        var grammerParamatersCollection = GrammerMethodParamsRegex.Matches( grammerMethodMatch.Groups[ 1 ].ToString() );

                        if( grammerParamatersCollection.Count &gt; 0 )
                        {
                            for( var h = 0; h &lt; grammerParamatersCollection.Count; h += 2 )
                            {
                                var key = grammerParamatersCollection[ h ].Groups[ 2 ].ToString();
                                var value = grammerParamatersCollection[ h + 1 ].Groups[ 2 ].ToString();
                                var found = false;

                                foundGrammers.Add( new KeyValuePair&lt; string , string &gt;( key , value ) );

                                foreach( var grammerState in this._grammerStates )
                                {
                                    if( grammerState.GetKey().CompareTo( key ) == 0 &amp;&amp; grammerState.GetValue().CompareTo( Framework.Utils.Base64Encode( value ) ) == 0 )
                                    {
                                        grammerState.SetDeleted( false );
                                        found = true;
                                    }
                                }

                                if( !found )
                                {
                                    this._grammerStates.Add( new ModuleFileGrammerState( this._module , key , value ) );
                                }
                            }
                        }
                    }
                }

                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    var found = false;

                    foreach( var foundGrammer in foundGrammers )
                    {
                        if( foundGrammer.Key.CompareTo( this._grammerStates[ g ].GetKey() ) == 0 )
                        {
                            found = true;
                        }
                    }

                    if( !found )
                    {
                        this._grammerStates[ g ].SetDeleted( true );
                    }
                }

                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    var found = false;

                    foreach( var foundGrammer in foundGrammers )
                    {
                        var temp = Framework.Utils.Base64Encode(foundGrammer.Value);
                        if (temp.CompareTo(this._grammerStates[g].GetValue()) == 0)
                        {
                            found = true;
                        }
                    }

                    if( !found )
                    {
                        this._grammerStates[ g ].SetDeleted( true );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        public List&lt; ModuleFileGrammerState &gt; GetAllGrammer()
        {
            return this._grammerStates;
        }


        public IGrammer GetGrammer( int id )
        {
            try
            {
                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    if( this._grammerStates[ g ].GetId() == id )
                    {
                        return this._grammerStates[ g ];
                    }
                }
                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        public IGrammer GetGrammer( string key )
        {
            try
            {
                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    if( this._grammerStates[ g ].GetKey().CompareTo( key ) == 0 )
                    {
                        return this._grammerStates[ g ];
                    }
                }
                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }

        public void Save()
        {
            try
            {
                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    this._grammerStates[ g ].Save();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        public void DeleteAllGrammer()
        {
            try
            {
                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    this._grammerStates[ g ].SetDeleted( true );
                }
                this.Save();
                this._grammerStates.Clear();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public IGrammer AddGrammer( string key , string value )
        {
            try
            {
                var grammer = new ModuleFileGrammerState( this._module , key , value );
                this._grammerStates.Add( grammer );
                return grammer;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }

        /// &lt;summary&gt;
        ///   Deletes a grammer given a key
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;key&quot;&gt;&lt;/param&gt;
        public void DeleteGrammer( string key )
        {
            try
            {
                for( var g = 0; g &lt; this._grammerStates.Count; g++ )
                {
                    if( this._grammerStates[ g ].GetKey().CompareTo( key ) == 0 )
                    {
                        this._grammerStates[ g ].SetDeleted( true );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }
    }
}</pre></code><script type="text/javascript">
			applyranges('src254', RANGES_254)
		</script>
	</body>
</html>