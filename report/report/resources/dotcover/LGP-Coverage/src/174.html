<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_174 = [
   [20,9,20,10,'dccv']
, [21,13,21,62,'dccv']
, [22,9,22,10,'dccv']
, [33,9,33,10,'dccv']
, [35,13,35,14,'dccv']
, [36,17,36,40,'dccv']
, [41,17,41,74,'dccv']
, [43,17,43,188,'dccv']
, [45,17,45,64,'dccv']
, [50,17,50,68,'dccv']
, [51,17,51,18,'dccv']
, [52,21,52,118,'dccv']
, [54,21,54,76,'dccv']
, [56,21,56,62,'dccv']
, [58,21,58,56,'dccv']
, [63,21,63,55,'dccv']
, [65,21,65,53,'dccv']
, [66,21,66,65,'dccv']
, [67,21,67,63,'dccv']
, [69,21,69,45,'dccv']
, [70,21,70,45,'dccv']
, [72,21,72,104,'dccv']
, [73,21,73,45,'dccv']
, [75,21,75,61,'dccv']
, [85,9,85,10,'dccv']
, [420,9,420,10,'dccv']
, [422,13,422,14,'dccv']
, [423,17,423,40,'dccv']
, [424,17,424,18,'dccv']
, [425,21,425,42,'dccv']
, [426,17,426,18,'dccv']
, [428,22,428,32,'dccv']
, [429,17,429,18,'dccv']
, [430,21,430,67,'dccv']
, [431,21,431,22,'dccv']
, [432,25,432,47,'dccv']
, [434,17,434,18,'dccv']
, [428,54,428,57,'dccv']
, [428,33,428,52,'dccv']
, [435,13,435,14,'dccv']
, [441,13,441,25,'dccv']
, [442,9,442,10,'dccv']
, [507,9,507,10,'dccv']
, [508,13,508,47,'dccv']
, [511,13,511,14,'dccv']
, [512,17,512,67,'dccv']
, [514,17,514,64,'dccv']
, [519,17,519,71,'dccv']
, [521,17,521,58,'dccv']
, [523,17,523,52,'dccv']
, [528,17,528,24,'dccv']
, [528,47,528,65,'dccv']
, [528,26,528,43,'dccv']
, [529,17,529,18,'dccv']
, [530,21,530,59,'dccv']
, [531,21,531,71,'dccv']
, [532,21,532,69,'dccv']
, [533,21,533,68,'dccv']
, [534,21,534,63,'dccv']
, [535,21,535,63,'dccv']
, [536,21,536,71,'dccv']
, [537,21,537,104,'dccv']
, [538,21,538,45,'dccv']
, [539,17,539,18,'dccv']
, [528,44,528,46,'dccv']
, [540,13,540,14,'dccv']
, [545,9,545,10,'dccv']
, [37,17,37,18,'dcuc']
, [38,21,38,42,'dcuc']
, [39,17,39,18,'dcuc']
, [46,17,46,18,'dcuc']
, [47,21,47,33,'dcuc']
, [59,21,59,22,'dcuc']
, [60,25,60,37,'dcuc']
, [78,17,78,29,'dcuc']
, [80,13,80,37,'dcuc']
, [81,13,81,14,'dcuc']
, [82,17,82,53,'dcuc']
, [83,17,83,29,'dcuc']
, [92,9,92,10,'dcuc']
, [94,13,94,14,'dcuc']
, [95,17,95,40,'dcuc']
, [96,17,96,18,'dcuc']
, [97,21,97,42,'dcuc']
, [98,17,98,18,'dcuc']
, [100,17,100,100,'dcuc']
, [102,17,102,64,'dcuc']
, [103,17,103,18,'dcuc']
, [104,21,104,28,'dcuc']
, [107,17,107,59,'dcuc']
, [109,22,109,32,'dcuc']
, [110,17,110,18,'dcuc']
, [111,21,111,67,'dcuc']
, [112,21,112,22,'dcuc']
, [113,25,113,49,'dcuc']
, [114,25,114,32,'dcuc']
, [116,17,116,18,'dcuc']
, [109,54,109,57,'dcuc']
, [109,33,109,52,'dcuc']
, [117,13,117,14,'dcuc']
, [118,13,118,37,'dcuc']
, [119,13,119,14,'dcuc']
, [120,17,120,53,'dcuc']
, [121,13,121,14,'dcuc']
, [122,9,122,10,'dcuc']
, [129,9,129,10,'dcuc']
, [131,13,131,14,'dcuc']
, [132,17,132,40,'dcuc']
, [133,17,133,18,'dcuc']
, [134,21,134,42,'dcuc']
, [135,17,135,18,'dcuc']
, [137,17,137,99,'dcuc']
, [139,17,139,64,'dcuc']
, [140,17,140,18,'dcuc']
, [141,21,141,28,'dcuc']
, [144,17,144,59,'dcuc']
, [146,17,146,44,'dcuc']
, [147,13,147,14,'dcuc']
, [148,13,148,37,'dcuc']
, [149,13,149,14,'dcuc']
, [150,17,150,53,'dcuc']
, [151,13,151,14,'dcuc']
, [152,9,152,10,'dcuc']
, [159,9,159,10,'dcuc']
, [161,13,161,14,'dcuc']
, [162,17,162,40,'dcuc']
, [163,17,163,18,'dcuc']
, [164,21,164,42,'dcuc']
, [165,17,165,18,'dcuc']
, [167,22,167,32,'dcuc']
, [168,17,168,18,'dcuc']
, [169,21,169,61,'dcuc']
, [170,21,170,22,'dcuc']
, [171,25,171,101,'dcuc']
, [173,25,173,72,'dcuc']
, [174,25,174,26,'dcuc']
, [175,29,175,36,'dcuc']
, [178,25,178,67,'dcuc']
, [180,25,180,49,'dcuc']
, [181,25,181,32,'dcuc']
, [183,17,183,18,'dcuc']
, [167,54,167,57,'dcuc']
, [167,33,167,52,'dcuc']
, [184,13,184,14,'dcuc']
, [185,13,185,37,'dcuc']
, [186,13,186,14,'dcuc']
, [187,17,187,53,'dcuc']
, [188,13,188,14,'dcuc']
, [189,9,189,10,'dcuc']
, [197,9,197,10,'dcuc']
, [199,13,199,14,'dcuc']
, [200,17,200,40,'dcuc']
, [201,17,201,18,'dcuc']
, [202,21,202,42,'dcuc']
, [203,17,203,18,'dcuc']
, [205,22,205,32,'dcuc']
, [206,17,206,18,'dcuc']
, [207,21,207,55,'dcuc']
, [208,21,208,22,'dcuc']
, [209,25,209,47,'dcuc']
, [211,17,211,18,'dcuc']
, [205,54,205,57,'dcuc']
, [205,33,205,52,'dcuc']
, [212,13,212,14,'dcuc']
, [213,13,213,37,'dcuc']
, [214,13,214,14,'dcuc']
, [215,17,215,53,'dcuc']
, [216,13,216,14,'dcuc']
, [218,13,218,25,'dcuc']
, [219,9,219,10,'dcuc']
, [227,9,227,10,'dcuc']
, [229,13,229,14,'dcuc']
, [230,17,230,40,'dcuc']
, [231,17,231,18,'dcuc']
, [232,21,232,42,'dcuc']
, [233,17,233,18,'dcuc']
, [235,22,235,32,'dcuc']
, [236,17,236,18,'dcuc']
, [237,21,237,67,'dcuc']
, [238,21,238,22,'dcuc']
, [239,25,239,47,'dcuc']
, [241,17,241,18,'dcuc']
, [235,54,235,57,'dcuc']
, [235,33,235,52,'dcuc']
, [242,13,242,14,'dcuc']
, [243,13,243,37,'dcuc']
, [244,13,244,14,'dcuc']
, [245,17,245,53,'dcuc']
, [246,13,246,14,'dcuc']
, [248,13,248,25,'dcuc']
, [249,9,249,10,'dcuc']
, [257,9,257,10,'dcuc']
, [259,13,259,14,'dcuc']
, [260,17,260,40,'dcuc']
, [261,17,261,18,'dcuc']
, [262,21,262,42,'dcuc']
, [263,17,263,18,'dcuc']
, [265,17,265,74,'dcuc']
, [267,17,267,39,'dcuc']
, [268,17,268,18,'dcuc']
, [269,21,269,33,'dcuc']
, [272,17,272,24,'dcuc']
, [272,37,272,45,'dcuc']
, [272,26,272,33,'dcuc']
, [273,17,273,18,'dcuc']
, [274,26,274,36,'dcuc']
, [275,21,275,22,'dcuc']
, [276,25,276,72,'dcuc']
, [277,25,277,26,'dcuc']
, [278,29,278,51,'dcuc']
, [280,21,280,22,'dcuc']
, [274,58,274,61,'dcuc']
, [274,37,274,56,'dcuc']
, [281,17,281,18,'dcuc']
, [272,34,272,36,'dcuc']
, [282,13,282,14,'dcuc']
, [283,13,283,37,'dcuc']
, [284,13,284,14,'dcuc']
, [285,17,285,53,'dcuc']
, [286,13,286,14,'dcuc']
, [288,13,288,25,'dcuc']
, [289,9,289,10,'dcuc']
, [297,9,297,10,'dcuc']
, [299,13,299,14,'dcuc']
, [300,17,300,40,'dcuc']
, [301,17,301,18,'dcuc']
, [302,21,302,42,'dcuc']
, [303,17,303,18,'dcuc']
, [305,17,305,70,'dcuc']
, [307,17,307,39,'dcuc']
, [308,17,308,18,'dcuc']
, [309,21,309,33,'dcuc']
, [312,17,312,24,'dcuc']
, [312,37,312,45,'dcuc']
, [312,26,312,33,'dcuc']
, [313,17,313,18,'dcuc']
, [314,26,314,36,'dcuc']
, [315,21,315,22,'dcuc']
, [316,25,316,72,'dcuc']
, [317,25,317,26,'dcuc']
, [318,29,318,51,'dcuc']
, [320,21,320,22,'dcuc']
, [314,58,314,61,'dcuc']
, [314,37,314,56,'dcuc']
, [321,17,321,18,'dcuc']
, [312,34,312,36,'dcuc']
, [322,13,322,14,'dcuc']
, [323,13,323,37,'dcuc']
, [324,13,324,14,'dcuc']
, [325,17,325,53,'dcuc']
, [326,13,326,14,'dcuc']
, [328,13,328,25,'dcuc']
, [329,9,329,10,'dcuc']
, [337,9,337,10,'dcuc']
, [339,13,339,14,'dcuc']
, [340,17,340,40,'dcuc']
, [341,17,341,18,'dcuc']
, [342,21,342,42,'dcuc']
, [343,17,343,18,'dcuc']
, [345,17,345,78,'dcuc']
, [347,17,347,39,'dcuc']
, [348,17,348,18,'dcuc']
, [349,21,349,33,'dcuc']
, [352,22,352,32,'dcuc']
, [353,17,353,18,'dcuc']
, [354,21,354,73,'dcuc']
, [355,21,355,22,'dcuc']
, [356,25,356,47,'dcuc']
, [358,17,358,18,'dcuc']
, [352,54,352,57,'dcuc']
, [352,33,352,52,'dcuc']
, [359,13,359,14,'dcuc']
, [360,13,360,37,'dcuc']
, [361,13,361,14,'dcuc']
, [362,17,362,53,'dcuc']
, [363,13,363,14,'dcuc']
, [365,13,365,25,'dcuc']
, [366,9,366,10,'dcuc']
, [374,9,374,10,'dcuc']
, [376,13,376,14,'dcuc']
, [377,17,377,40,'dcuc']
, [378,17,378,18,'dcuc']
, [379,21,379,42,'dcuc']
, [380,17,380,18,'dcuc']
, [382,17,382,51,'dcuc']
, [384,22,384,32,'dcuc']
, [385,17,385,18,'dcuc']
, [386,21,386,63,'dcuc']
, [387,21,387,22,'dcuc']
, [388,25,388,47,'dcuc']
, [390,17,390,18,'dcuc']
, [384,54,384,57,'dcuc']
, [384,33,384,52,'dcuc']
, [391,13,391,14,'dcuc']
, [392,13,392,37,'dcuc']
, [393,13,393,14,'dcuc']
, [394,17,394,53,'dcuc']
, [395,13,395,14,'dcuc']
, [397,13,397,25,'dcuc']
, [398,9,398,10,'dcuc']
, [405,9,405,10,'dcuc']
, [406,13,406,36,'dcuc']
, [407,13,407,14,'dcuc']
, [408,17,408,38,'dcuc']
, [409,13,409,14,'dcuc']
, [411,13,411,30,'dcuc']
, [412,9,412,10,'dcuc']
, [436,13,436,37,'dcuc']
, [437,13,437,14,'dcuc']
, [438,17,438,53,'dcuc']
, [439,13,439,14,'dcuc']
, [448,9,448,10,'dcuc']
, [450,13,450,14,'dcuc']
, [451,17,451,67,'dcuc']
, [453,17,453,64,'dcuc']
, [454,17,454,18,'dcuc']
, [455,21,455,28,'dcuc']
, [458,17,458,71,'dcuc']
, [460,17,460,58,'dcuc']
, [462,17,462,52,'dcuc']
, [463,17,463,18,'dcuc']
, [464,21,464,28,'dcuc']
, [466,17,466,24,'dcuc']
, [466,47,466,65,'dcuc']
, [466,26,466,43,'dcuc']
, [467,17,467,18,'dcuc']
, [468,21,468,59,'dcuc']
, [469,21,469,71,'dcuc']
, [470,21,470,69,'dcuc']
, [471,21,471,68,'dcuc']
, [472,21,472,63,'dcuc']
, [473,21,473,63,'dcuc']
, [474,21,474,71,'dcuc']
, [477,21,477,43,'dcuc']
, [479,26,479,36,'dcuc']
, [480,21,480,22,'dcuc']
, [481,25,481,60,'dcuc']
, [482,25,482,26,'dcuc']
, [483,29,483,38,'dcuc']
, [486,25,486,44,'dcuc']
, [487,25,487,31,'dcuc']
, [479,58,479,61,'dcuc']
, [479,37,479,56,'dcuc']
, [490,21,490,38,'dcuc']
, [491,21,491,22,'dcuc']
, [492,25,492,34,'dcuc']
, [495,21,495,104,'dcuc']
, [496,21,496,45,'dcuc']
, [497,17,497,18,'dcuc']
, [466,44,466,46,'dcuc']
, [498,13,498,14,'dcuc']
, [499,13,499,37,'dcuc']
, [500,13,500,14,'dcuc']
, [501,17,501,53,'dcuc']
, [502,13,502,14,'dcuc']
, [503,9,503,10,'dcuc']
, [515,17,515,18,'dcuc']
, [516,21,516,28,'dcuc']
, [524,17,524,18,'dcuc']
, [525,21,525,28,'dcuc']
, [541,13,541,37,'dcuc']
, [542,13,542,14,'dcuc']
, [543,17,543,53,'dcuc']
, [544,13,544,14,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src174" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.Data;
using LGP.Components.Database.Entities;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;

#endregion

namespace LGP.Components.Database.Gateways
{
    internal class PolicyGateway : IPolicyGateway
    {
        private static readonly IOuGateway OuGateway;
        private static List&lt; IPolicy &gt; _policies;

        static PolicyGateway()
        {
            OuGateway = Framework.Database.CreateOuGateway();
        }

        #region Implementation of IPolicyGateway

        /// &lt;summary&gt;
        ///   Create a policy for a given ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;the associated ou&lt;/param&gt;
        /// &lt;param name=&quot;defaultPolicy&quot;&gt;default policy&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy CreatePolicy( IOu ou , string defaultPolicy )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var now = DateTime.Now.ToString( &quot;yyyy-MM-dd HH:mm:ss&quot; );

                var sql = string.Format( &quot;insert into policy values( null, &#39;{1}&#39; , &#39;{1}&#39; ,&#39;1&#39; ,&#39;{2}&#39; ,&#39;{0}&#39; ,&#39;&#39;  )&quot; , ou.GetOuId() , now , Framework.Utils.Base64Encode( defaultPolicy ) );

                if( Framework.Database.IsConnected() == false )
                {
                    return null;
                }

                if( Framework.Database.ExecuteNonQuery( sql ) &gt; 0 )
                {
                    var sql2 = string.Format( &quot;select * from policy where p_id = ( select MAX(p_id) from policy )&quot; );

                    var policies = Framework.Database.ExecuteQuery( sql2 );

                    var policiesTable = policies.Tables[ 0 ];

                    if( policiesTable.Rows.Count == 0 )
                    {
                        return null;
                    }

                    var row = policiesTable.Rows[ 0 ];

                    var pid = ( int ) row[ &quot;p_id&quot; ];
                    var created = ( string ) row[ &quot;p_created&quot; ];
                    var edited = ( string ) row[ &quot;p_edited&quot; ];
                    const int enabled = 1;
                    var dsl = defaultPolicy;
                    var ouid = ou.GetOuId();
                    const string version = &quot;&quot;;
                    var policy = new Policy( pid , created , edited , enabled , dsl , ouid , version );
                    _policies.Add( policy );

                    return _policies[ _policies.Count - 1 ];
                }

                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }

        /// &lt;summary&gt;
        ///   Deletes a policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;IOu&lt;/param&gt;
        public void DeletePolicy( IOu ou )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var sql = string.Format( &quot;delete from policy where p_ou_id=&#39;{0}&#39;&quot; , ou.GetOuId() );

                if( Framework.Database.IsConnected() == false )
                {
                    return;
                }

                Framework.Database.ExecuteNonQuery( sql );

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetOuId() == ou.GetOuId() )
                    {
                        _policies.RemoveAt( h );
                        return;
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Deletes a policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;policy&quot;&gt;IPolicy&lt;/param&gt;
        public void DeletePolicy( IPolicy policy )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var sql = string.Format( &quot;delete from policy where p_id=&#39;{0}&#39;&quot; , policy.GetId() );

                if( Framework.Database.IsConnected() == false )
                {
                    return;
                }

                Framework.Database.ExecuteNonQuery( sql );

                _policies.Remove( policy );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Deletes a policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;policyid&quot;&gt;policy id&lt;/param&gt;
        public void DeletePolicy( int policyid )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetId() == policyid )
                    {
                        var sql = string.Format( &quot;delete from policy where p_id=&#39;{0}&#39;&quot; , policyid );

                        if( Framework.Database.IsConnected() == false )
                        {
                            return;
                        }

                        Framework.Database.ExecuteNonQuery( sql );

                        _policies.RemoveAt( h );
                        return;
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Gets a policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;id&quot;&gt;policy id&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetPolicy( int id )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetId() == id )
                    {
                        return _policies[ h ];
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        ///   Gets a policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;IOu&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetPolicy( IOu ou )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetOuId() == ou.GetOuId() )
                    {
                        return _policies[ h ];
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        ///   Gets an predecessor policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;policy&quot;&gt;IPolicy&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetPredecessorPolicy( IPolicy policy )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var children = OuGateway.GetChildren( policy.GetOuId() );

                if( children == null )
                {
                    return null;
                }

                foreach( var iou in children )
                {
                    for( var h = 0; h &lt; _policies.Count; h++ )
                    {
                        if( _policies[ h ].GetOuId() == iou.GetOuId() )
                        {
                            return _policies[ h ];
                        }
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        ///   Gets an predecessor policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;IOu&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetPredecessorPolicy( IOu ou )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var children = OuGateway.GetChildren( ou.GetOuId() );

                if( children == null )
                {
                    return null;
                }

                foreach( var iou in children )
                {
                    for( var h = 0; h &lt; _policies.Count; h++ )
                    {
                        if( _policies[ h ].GetOuId() == iou.GetOuId() )
                        {
                            return _policies[ h ];
                        }
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        ///   Gets an ancestor policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;policy&quot;&gt;IPolicy&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetAncestorPolicy( IPolicy policy )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var parentOu = OuGateway.GetOuParentById( policy.GetOuId() );

                if( parentOu == null )
                {
                    return null;
                }

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetOuId() == parentOu.GetOuId() )
                    {
                        return _policies[ h ];
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        ///   Gets an ancestor policy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;IOu&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetAncestorPolicy( IOu ou )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                var parentou = ou.GetParentOuId();

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetOuId() == parentou )
                    {
                        return _policies[ h ];
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        ///   Gets a list of all policies
        /// &lt;/summary&gt;
        /// &lt;returns&gt;List IPolicy&lt;/returns&gt;
        public List&lt; IPolicy &gt; GetPolicies()
        {
            if( _policies == null )
            {
                BuildPolicyListing();
            }

            return _policies;
        }

        /// &lt;summary&gt;
        ///   Get the policy in a given ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;IOu&lt;/param&gt;
        /// &lt;returns&gt;IPolicy&lt;/returns&gt;
        public IPolicy GetPolicyByOu( IOu ou )
        {
            try
            {
                if( _policies == null )
                {
                    BuildPolicyListing();
                }

                for( var h = 0; h &lt; _policies.Count; h++ )
                {
                    if( _policies[ h ].GetOuId() == ou.GetOuId() )
                    {
                        return _policies[ h ];
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return null;
        }

        /// &lt;summary&gt;
        /// Refreshes the list
        /// &lt;/summary&gt;
        public void Refresh()
        {
            try
            {
                var sql = string.Format( &quot;select * from policy&quot; );

                if( Framework.Database.IsConnected() == false )
                {
                    return;
                }

                var policies = Framework.Database.ExecuteQuery( sql );

                var policiesTable = policies.Tables[ 0 ];

                if( policiesTable.Rows.Count == 0 )
                {
                    return;
                }
                foreach( DataRow policyRow in policiesTable.Rows )
                {
                    var pid = ( int ) policyRow[ &quot;p_id&quot; ];
                    var created = ( string ) policyRow[ &quot;p_created&quot; ];
                    var edited = ( string ) policyRow[ &quot;p_edited&quot; ];
                    var enabled = ( int ) policyRow[ &quot;p_enabled&quot; ];
                    var dsl = ( string ) policyRow[ &quot;p_dsl&quot; ];
                    var ouid = ( int ) policyRow[ &quot;p_ou_id&quot; ];
                    var version = ( string ) policyRow[ &quot;p_version&quot; ];


                    var newDbEntry = true;

                    for( var y = 0; y &lt; _policies.Count; y++ )
                    {
                        if( _policies[ y ].GetId() != pid )
                        {
                            continue;
                        }

                        newDbEntry = false;
                        break;
                    }

                    if( !newDbEntry )
                    {
                        continue;
                    }

                    var policy = new Policy( pid , created , edited , enabled , dsl , ouid , version );
                    _policies.Add( policy );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private static void BuildPolicyListing()
        {
            _policies = new List&lt; IPolicy &gt;();

            try
            {
                var sql = string.Format( &quot;select * from policy&quot; );

                if( Framework.Database.IsConnected() == false )
                {
                    return;
                }

                var policies = Framework.Database.ExecuteQuery( sql );

                var policiesTable = policies.Tables[ 0 ];

                if( policiesTable.Rows.Count == 0 )
                {
                    return;
                }

                foreach( DataRow policyRow in policiesTable.Rows )
                {
                    var pid = ( int ) policyRow[ &quot;p_id&quot; ];
                    var created = ( string ) policyRow[ &quot;p_created&quot; ];
                    var edited = ( string ) policyRow[ &quot;p_edited&quot; ];
                    var enabled = ( int ) policyRow[ &quot;p_enabled&quot; ];
                    var dsl = ( string ) policyRow[ &quot;p_dsl&quot; ];
                    var ouid = ( int ) policyRow[ &quot;p_ou_id&quot; ];
                    var version = ( string ) policyRow[ &quot;p_version&quot; ];
                    var policy = new Policy( pid , created , edited , enabled , dsl , ouid , version );
                    _policies.Add( policy );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src174', RANGES_174)
		</script>
	</body>
</html>