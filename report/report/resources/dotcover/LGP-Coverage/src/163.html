<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_163 = [
   [27,9,27,10,'dccv']
, [29,13,29,14,'dccv']
, [30,17,30,35,'dccv']
, [35,17,35,117,'dccv']
, [37,17,37,64,'dccv']
, [42,17,42,68,'dccv']
, [43,17,43,18,'dccv']
, [44,21,44,111,'dccv']
, [46,21,46,69,'dccv']
, [48,21,48,50,'dccv']
, [50,21,50,50,'dccv']
, [55,21,55,49,'dccv']
, [60,21,60,22,'dccv']
, [61,25,61,66,'dccv']
, [62,21,62,22,'dccv']
, [69,21,69,141,'dccv']
, [71,21,71,36,'dccv']
, [73,21,73,51,'dccv']
, [83,9,83,10,'dccv']
, [91,9,91,10,'dccv']
, [93,13,93,14,'dccv']
, [94,17,94,35,'dccv']
, [99,17,99,89,'dccv']
, [101,17,101,55,'dccv']
, [102,17,102,18,'dccv']
, [103,21,103,63,'dccv']
, [105,26,105,36,'dccv']
, [106,21,106,22,'dccv']
, [107,25,107,58,'dccv']
, [108,25,108,26,'dccv']
, [109,29,109,60,'dccv']
, [110,29,110,48,'dccv']
, [111,29,111,35,'dccv']
, [113,21,113,22,'dccv']
, [105,53,105,56,'dccv']
, [105,37,105,51,'dccv']
, [114,17,114,18,'dccv']
, [115,13,115,14,'dccv']
, [120,9,120,10,'dccv']
, [208,9,208,10,'dccv']
, [210,13,210,14,'dccv']
, [211,17,211,35,'dccv']
, [216,17,216,50,'dccv']
, [218,22,218,32,'dccv']
, [219,17,219,18,'dccv']
, [220,21,220,112,'dccv']
, [221,21,221,22,'dccv']
, [222,25,222,51,'dccv']
, [223,21,223,22,'dccv']
, [224,17,224,18,'dccv']
, [218,49,218,52,'dccv']
, [218,33,218,47,'dccv']
, [226,17,226,33,'dccv']
, [233,9,233,10,'dccv']
, [241,9,241,10,'dccv']
, [243,13,243,14,'dccv']
, [244,17,244,35,'dccv']
, [245,17,245,18,'dccv']
, [246,21,246,38,'dccv']
, [247,17,247,18,'dccv']
, [249,17,249,47,'dccv']
, [251,22,251,32,'dccv']
, [252,17,252,18,'dccv']
, [253,21,253,75,'dccv']
, [254,21,254,22,'dccv']
, [255,25,255,48,'dccv']
, [256,21,256,22,'dccv']
, [257,17,257,18,'dccv']
, [251,49,251,52,'dccv']
, [251,33,251,47,'dccv']
, [259,17,259,30,'dccv']
, [266,9,266,10,'dccv']
, [272,9,272,10,'dccv']
, [273,13,273,30,'dccv']
, [274,9,274,10,'dccv']
, [279,9,279,10,'dccv']
, [280,13,280,32,'dccv']
, [281,13,281,31,'dccv']
, [282,13,282,14,'dccv']
, [283,17,283,42,'dccv']
, [284,17,284,33,'dccv']
, [285,13,285,14,'dccv']
, [288,13,288,14,'dccv']
, [289,17,289,64,'dccv']
, [291,17,291,64,'dccv']
, [296,17,296,65,'dccv']
, [298,17,298,46,'dccv']
, [300,17,300,46,'dccv']
, [305,17,305,24,'dccv']
, [305,41,305,53,'dccv']
, [305,26,305,37,'dccv']
, [306,17,306,18,'dccv']
, [310,21,310,22,'dccv']
, [311,25,311,66,'dccv']
, [312,21,312,22,'dccv']
, [319,21,319,141,'dccv']
, [321,21,321,34,'dccv']
, [322,21,322,22,'dccv']
, [323,25,323,54,'dccv']
, [324,25,324,26,'dccv']
, [325,29,325,44,'dccv']
, [326,25,326,26,'dccv']
, [327,21,327,22,'dccv']
, [329,21,329,22,'dccv']
, [330,25,330,40,'dccv']
, [331,21,331,22,'dccv']
, [332,17,332,18,'dccv']
, [305,38,305,40,'dccv']
, [333,13,333,14,'dccv']
, [338,9,338,10,'dccv']
, [342,9,342,10,'dccv']
, [343,13,343,20,'dccv']
, [343,32,343,36,'dccv']
, [343,22,343,28,'dccv']
, [344,13,344,14,'dccv']
, [345,17,345,52,'dccv']
, [346,17,346,18,'dccv']
, [347,21,347,33,'dccv']
, [349,13,349,14,'dccv']
, [343,29,343,31,'dccv']
, [350,13,350,26,'dccv']
, [351,9,351,10,'dccv']
, [31,17,31,18,'dcuc']
, [32,21,32,38,'dcuc']
, [33,17,33,18,'dcuc']
, [38,17,38,18,'dcuc']
, [39,21,39,33,'dcuc']
, [51,21,51,22,'dcuc']
, [52,25,52,37,'dcuc']
, [63,21,63,45,'dcuc']
, [64,21,64,22,'dcuc']
, [65,25,65,61,'dcuc']
, [66,25,66,39,'dcuc']
, [67,21,67,22,'dcuc']
, [76,17,76,29,'dcuc']
, [78,13,78,37,'dcuc']
, [79,13,79,14,'dcuc']
, [80,17,80,53,'dcuc']
, [81,17,81,29,'dcuc']
, [95,17,95,18,'dcuc']
, [96,21,96,38,'dcuc']
, [97,17,97,18,'dcuc']
, [116,13,116,37,'dcuc']
, [117,13,117,14,'dcuc']
, [118,17,118,53,'dcuc']
, [119,13,119,14,'dcuc']
, [129,9,129,10,'dcuc']
, [131,13,131,14,'dcuc']
, [132,17,132,35,'dcuc']
, [133,17,133,18,'dcuc']
, [134,21,134,38,'dcuc']
, [135,17,135,18,'dcuc']
, [137,22,137,32,'dcuc']
, [138,17,138,18,'dcuc']
, [139,21,139,54,'dcuc']
, [140,21,140,22,'dcuc']
, [141,25,141,42,'dcuc']
, [143,17,143,18,'dcuc']
, [137,49,137,52,'dcuc']
, [137,33,137,47,'dcuc']
, [145,17,145,29,'dcuc']
, [147,13,147,37,'dcuc']
, [148,13,148,14,'dcuc']
, [149,17,149,53,'dcuc']
, [150,17,150,29,'dcuc']
, [152,9,152,10,'dcuc']
, [161,9,161,10,'dcuc']
, [163,13,163,14,'dcuc']
, [164,17,164,35,'dcuc']
, [165,17,165,18,'dcuc']
, [166,21,166,38,'dcuc']
, [167,17,167,18,'dcuc']
, [169,22,169,32,'dcuc']
, [170,17,170,18,'dcuc']
, [171,21,171,54,'dcuc']
, [172,21,172,22,'dcuc']
, [173,25,173,76,'dcuc']
, [175,17,175,18,'dcuc']
, [169,49,169,52,'dcuc']
, [169,33,169,47,'dcuc']
, [177,17,177,29,'dcuc']
, [179,13,179,37,'dcuc']
, [180,13,180,14,'dcuc']
, [181,17,181,53,'dcuc']
, [182,17,182,29,'dcuc']
, [184,9,184,10,'dcuc']
, [192,9,192,10,'dcuc']
, [193,13,193,31,'dcuc']
, [194,13,194,14,'dcuc']
, [195,17,195,34,'dcuc']
, [196,13,196,14,'dcuc']
, [198,13,198,25,'dcuc']
, [199,9,199,10,'dcuc']
, [212,17,212,18,'dcuc']
, [213,21,213,38,'dcuc']
, [214,17,214,18,'dcuc']
, [228,13,228,37,'dcuc']
, [229,13,229,14,'dcuc']
, [230,17,230,53,'dcuc']
, [231,17,231,29,'dcuc']
, [261,13,261,37,'dcuc']
, [262,13,262,14,'dcuc']
, [263,17,263,53,'dcuc']
, [264,17,264,29,'dcuc']
, [292,17,292,18,'dcuc']
, [293,21,293,28,'dcuc']
, [301,17,301,18,'dcuc']
, [302,21,302,28,'dcuc']
, [313,21,313,45,'dcuc']
, [314,21,314,22,'dcuc']
, [315,25,315,61,'dcuc']
, [316,25,316,39,'dcuc']
, [317,21,317,22,'dcuc']
, [334,13,334,37,'dcuc']
, [335,13,335,14,'dcuc']
, [336,17,336,53,'dcuc']
, [337,13,337,14,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src163" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.Data;
using LGP.Components.Database.Entities;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;

#endregion

namespace LGP.Components.Database.Gateways
{
    internal class OuGateway : IOuGateway
    {
        private static List&lt; IOu &gt; _ous;

        #region IOuGateway Members

        /// &lt;summary&gt;
        ///   Adds a Ou to a given parent ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ouName&quot;&gt;The new ou name&lt;/param&gt;
        /// &lt;param name = &quot;parentId&quot;&gt;The new parent id&lt;/param&gt;
        /// &lt;returns&gt;IOu&lt;/returns&gt;
        public IOu CreateOu( string ouName , int parentId )
        {
            try
            {
                if( _ous == null )
                {
                    BuildOuListing();
                }

                var sql = string.Format( &quot;insert into ous values( null, &#39;{0}&#39; , &#39;{1}&#39; , &#39;&#39; )&quot; , ouName , parentId );

                if( Framework.Database.IsConnected() == false )
                {
                    return null;
                }

                if( Framework.Database.ExecuteNonQuery( sql ) &gt; 0 )
                {
                    sql = string.Format( &quot;select * from ous where ou_id = ( select MAX( ou_id ) from ous )&quot; );

                    var ds = Framework.Database.ExecuteQuery( sql );

                    var ouTable = ds.Tables[ 0 ];

                    if( ouTable.Rows.Count == 0 )
                    {
                        return null;
                    }

                    var row = ouTable.Rows[ 0 ];

                    int parentou;

                    try
                    {
                        parentou = ( int ) row[ &quot;ou_parent_id&quot; ];
                    }
                    catch( Exception error )
                    {
                        Framework.EventBus.Publish( error );
                        parentou = -1;
                    }

                    var ou = new Ou( ( int ) row[ &quot;ou_id&quot; ] , ( string ) row[ &quot;ou_name&quot; ] , parentou , ( string ) row[ &quot;ou_policygroup&quot; ] );

                    _ous.Add( ou );

                    return _ous[ _ous.Count - 1 ];
                }

                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Deletes an Ou to a given parent ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ouid&quot;&gt;the ou id to delete&lt;/param&gt;
        public void DeleteOu( int ouid )
        {
            try
            {
                if( _ous == null )
                {
                    BuildOuListing();
                }

                var sql = string.Format( &quot;delete from ous where ou_id = &#39;{0}&#39;&quot; , ouid );

                if( Framework.Database.IsConnected() )
                {
                    Framework.Database.ExecuteNonQuery( sql );

                    for( var y = 0; y &lt; _ous.Count; y++ )
                    {
                        if( _ous[ y ].GetOuId() == ouid )
                        {
                            _ous[ y ].Dispose( _ous[ y ] );
                            _ous.RemoveAt( y );
                            break;
                        }
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Gets an Iou given an id
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ouid&quot;&gt;int id&lt;/param&gt;
        /// &lt;returns&gt;IOu&lt;/returns&gt;
        public IOu GetOuById( int ouid )
        {
            try
            {
                if( _ous == null )
                {
                    BuildOuListing();
                }

                for( var y = 0; y &lt; _ous.Count; y++ )
                {
                    if( _ous[ y ].GetOuId() == ouid )
                    {
                        return _ous[ y ];
                    }
                }

                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Gets a parent Iou given an id
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ouid&quot;&gt;int id&lt;/param&gt;
        /// &lt;returns&gt;IOu&lt;/returns&gt;
        public IOu GetOuParentById( int ouid )
        {
            try
            {
                if( _ous == null )
                {
                    BuildOuListing();
                }

                for( var y = 0; y &lt; _ous.Count; y++ )
                {
                    if( _ous[ y ].GetOuId() == ouid )
                    {
                        return this.GetOuById( _ous[ y ].GetParentOuId() );
                    }
                }

                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Gets a listing of Ous
        /// &lt;/summary&gt;
        /// &lt;returns&gt;IOu List&lt;/returns&gt;
        public List&lt; IOu &gt; GetOuListing()
        {
            if( _ous == null )
            {
                BuildOuListing();
            }

            return _ous;
        }


        /// &lt;summary&gt;
        ///   Get the children of a ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ouid&quot;&gt;int outid&lt;/param&gt;
        /// &lt;returns&gt;IOu List&lt;/returns&gt;
        public List&lt; IOu &gt; GetChildren( int ouid )
        {
            try
            {
                if( _ous == null )
                {
                    BuildOuListing();
                }

                var children = new List&lt; IOu &gt;();

                for( var y = 0; y &lt; _ous.Count; y++ )
                {
                    if( _ous[ y ].GetParentOuId() == ouid &amp;&amp; _ous[ y ].GetOuId() != _ous[ y ].GetParentOuId() )
                    {
                        children.Add( _ous[ y ] );
                    }
                }

                return children;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Get the parents with no parents
        /// &lt;/summary&gt;
        /// &lt;returns&gt;IOu List&lt;/returns&gt;
        public List&lt; IOu &gt; GetRoots()
        {
            try
            {
                if( _ous == null )
                {
                    BuildOuListing();
                }

                var roots = new List&lt; IOu &gt;();

                for( var y = 0; y &lt; _ous.Count; y++ )
                {
                    if( _ous[ y ].GetOuId() == _ous[ y ].GetParentOuId() )
                    {
                        roots.Add( _ous[ y ] );
                    }
                }

                return roots;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }

        /// &lt;summary&gt;
        ///   Refreshes the ou list
        /// &lt;/summary&gt;
        public void Refresh()
        {
            BuildOuListing();
        }

        #endregion

        private static void BuildOuListing()
        {
            var refresh = true;
            if( _ous == null )
            {
                _ous = new List&lt; IOu &gt;();
                refresh = false;
            }

            try
            {
                var sql = string.Format( &quot;select * from ous&quot; );

                if( Framework.Database.IsConnected() == false )
                {
                    return;
                }

                var ds = Framework.Database.ExecuteQuery( sql );

                var ouTable = ds.Tables[ 0 ];

                if( ouTable.Rows.Count == 0 )
                {
                    return;
                }

                foreach( DataRow row in ouTable.Rows )
                {
                    int parentou;

                    try
                    {
                        parentou = ( int ) row[ &quot;ou_parent_id&quot; ];
                    }
                    catch( Exception error )
                    {
                        Framework.EventBus.Publish( error );
                        parentou = -1;
                    }

                    var ou = new Ou( ( int ) row[ &quot;ou_id&quot; ] , ( string ) row[ &quot;ou_name&quot; ] , parentou , ( string ) row[ &quot;ou_policygroup&quot; ] );

                    if( refresh )
                    {
                        if( Contains( ou ) == false )
                        {
                            _ous.Add( ou );
                        }
                    }
                    else
                    {
                        _ous.Add( ou );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private static bool Contains( Ou ou )
        {
            foreach( Ou cou in _ous )
            {
                if( cou.GetOuId() == ou.GetOuId() )
                {
                    return true;
                }
            }
            return false;
        }
    }
}</pre></code><script type="text/javascript">
			applyranges('src163', RANGES_163)
		</script>
	</body>
</html>