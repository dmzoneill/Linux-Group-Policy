<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_319 = [
   [47,9,47,38,'dccv']
, [48,9,48,10,'dccv']
, [50,13,50,14,'dccv']
, [51,17,51,44,'dccv']
, [53,17,53,31,'dccv']
, [54,17,54,41,'dccv']
, [55,17,55,83,'dccv']
, [56,17,56,68,'dccv']
, [58,17,58,62,'dccv']
, [59,17,59,43,'dccv']
, [60,17,60,18,'dccv']
, [61,21,61,75,'dccv']
, [62,21,62,74,'dccv']
, [63,17,63,18,'dccv']
, [65,17,65,104,'dccv']
, [66,17,66,86,'dccv']
, [67,17,67,32,'dccv']
, [68,17,68,83,'dccv']
, [70,17,70,83,'dccv']
, [71,13,71,14,'dccv']
, [76,9,76,10,'dccv']
, [79,9,79,10,'dccv']
, [81,13,81,14,'dccv']
, [82,17,82,107,'dccv']
, [83,17,83,105,'dccv']
, [84,17,84,111,'dccv']
, [85,17,85,109,'dccv']
, [86,17,86,107,'dccv']
, [87,17,87,107,'dccv']
, [88,17,88,108,'dccv']
, [89,17,89,107,'dccv']
, [90,17,90,111,'dccv']
, [91,17,91,128,'dccv']
, [92,17,92,120,'dccv']
, [93,13,93,14,'dccv']
, [98,9,98,10,'dccv']
, [101,9,101,10,'dccv']
, [103,13,103,14,'dccv']
, [104,17,104,74,'dccv']
, [105,13,105,14,'dccv']
, [110,9,110,10,'dccv']
, [113,9,113,10,'dccv']
, [115,13,115,14,'dccv']
, [116,17,116,49,'dccv']
, [117,17,117,38,'dccv']
, [118,17,118,18,'dccv']
, [119,21,119,114,'dccv']
, [120,21,120,47,'dccv']
, [121,21,121,22,'dccv']
, [122,25,122,72,'dccv']
, [123,21,123,22,'dccv']
, [124,17,124,18,'dccv']
, [125,13,125,14,'dccv']
, [130,9,130,10,'dccv']
, [133,9,133,10,'dccv']
, [134,13,134,36,'dccv']
, [135,9,135,10,'dccv']
, [138,9,138,10,'dccv']
, [139,13,139,48,'dccv']
, [140,9,140,10,'dccv']
, [143,9,143,10,'dccv']
, [144,13,144,38,'dccv']
, [145,13,145,14,'dccv']
, [146,17,146,61,'dccv']
, [147,13,147,14,'dccv']
, [148,9,148,10,'dccv']
, [156,9,156,10,'dccv']
, [158,13,158,14,'dccv']
, [159,17,159,41,'dccv']
, [160,17,160,67,'dccv']
, [161,17,161,55,'dccv']
, [162,13,162,14,'dccv']
, [167,9,167,10,'dccv']
, [173,9,173,10,'dccv']
, [174,13,174,79,'dccv']
, [175,9,175,10,'dccv']
, [181,9,181,10,'dccv']
, [183,13,183,14,'dccv']
, [184,13,184,14,'dccv']
, [188,9,188,10,'dccv']
, [194,9,194,10,'dccv']
, [196,13,196,14,'dccv']
, [197,13,197,14,'dccv']
, [201,9,201,10,'dccv']
, [30,9,30,30,'dcuc']
, [31,9,31,10,'dcuc']
, [33,13,33,14,'dcuc']
, [34,17,34,44,'dcuc']
, [35,17,35,32,'dcuc']
, [36,13,36,14,'dcuc']
, [37,13,37,37,'dcuc']
, [38,13,38,14,'dcuc']
, [39,17,39,53,'dcuc']
, [40,13,40,14,'dcuc']
, [41,9,41,10,'dcuc']
, [72,13,72,37,'dcuc']
, [73,13,73,14,'dcuc']
, [74,17,74,53,'dcuc']
, [75,13,75,14,'dcuc']
, [94,13,94,37,'dcuc']
, [95,13,95,14,'dcuc']
, [96,17,96,53,'dcuc']
, [97,13,97,14,'dcuc']
, [106,13,106,37,'dcuc']
, [107,13,107,14,'dcuc']
, [108,17,108,53,'dcuc']
, [109,13,109,14,'dcuc']
, [126,13,126,37,'dcuc']
, [127,13,127,14,'dcuc']
, [128,17,128,53,'dcuc']
, [129,13,129,14,'dcuc']
, [163,13,163,37,'dcuc']
, [164,13,164,14,'dcuc']
, [165,17,165,53,'dcuc']
, [166,13,166,14,'dcuc']
, [185,13,185,31,'dcuc']
, [186,13,186,14,'dcuc']
, [187,13,187,14,'dcuc']
, [198,13,198,31,'dcuc']
, [199,13,199,14,'dcuc']
, [200,13,200,14,'dcuc']
, [213,9,213,10,'dcuc']
, [215,13,215,14,'dcuc']
, [216,17,216,31,'dcuc']
, [217,17,217,59,'dcuc']
, [218,13,218,14,'dcuc']
, [219,13,219,37,'dcuc']
, [220,13,220,14,'dcuc']
, [221,17,221,53,'dcuc']
, [222,13,222,14,'dcuc']
, [223,9,223,10,'dcuc']
, [230,9,230,10,'dcuc']
, [232,13,232,14,'dcuc']
, [233,13,233,14,'dcuc']
, [234,13,234,37,'dcuc']
, [235,13,235,14,'dcuc']
, [236,17,236,53,'dcuc']
, [237,13,237,14,'dcuc']
, [238,9,238,10,'dcuc']
, [245,9,245,10,'dcuc']
, [247,13,247,14,'dcuc']
, [248,13,248,14,'dcuc']
, [249,13,249,37,'dcuc']
, [250,13,250,14,'dcuc']
, [251,17,251,53,'dcuc']
, [252,13,252,14,'dcuc']
, [253,9,253,10,'dcuc']
, [259,9,259,10,'dcuc']
, [261,13,261,14,'dcuc']
, [262,13,262,14,'dcuc']
, [263,13,263,37,'dcuc']
, [264,13,264,14,'dcuc']
, [265,17,265,53,'dcuc']
, [266,13,266,14,'dcuc']
, [267,9,267,10,'dcuc']
, [274,9,274,10,'dcuc']
, [276,13,276,14,'dcuc']
, [277,13,277,14,'dcuc']
, [278,13,278,37,'dcuc']
, [279,13,279,14,'dcuc']
, [280,17,280,53,'dcuc']
, [281,13,281,14,'dcuc']
, [282,9,282,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src319" class="dotCoverSource"><pre>#region

using System;
using System.IO;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;
using LGP.Components.Factory.Interfaces.Module;
using LGP.Modules.PolicyEditor.Internal;
using LGP.Modules.PolicyEditor.Internal.CustomControls;

#endregion

namespace LGP.Modules.PolicyEditor
{
    /// &lt;summary&gt;
    ///   Interaction logic for PolicyEditor.xaml
    /// &lt;/summary&gt;
    public partial class PolicyEditor : IUserControl , IOuObserver
    {
        private readonly IPolicy _policy;
        private readonly PolicyHandler _policyHandler;
        private IOu _ou;

        /// &lt;summary&gt;
        ///   Constructor
        /// &lt;/summary&gt;
        public PolicyEditor()
        {
            try
            {
                this.InitializeComponent();
                this.Prepare();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Constructor
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;&lt;/param&gt;
        public PolicyEditor( IOu ou )
        {
            try
            {
                this.InitializeComponent();

                this._ou = ou;
                this._ou.Attach( this );
                this.PolicyOverviewContainer.Child = new OuPolicyPane( this._ou );
                var pgw = Framework.Database.CreatePolicyGateway();

                this._policy = pgw.GetPolicyByOu( this._ou );
                if( this._policy == null )
                {
                    var policy = File.ReadAllText( &quot;PolicyTemplate.txt&quot; );
                    this._policy = pgw.CreatePolicy( this._ou , policy );
                }

                this._policyHandler = new PolicyHandler( this , this.PolicyDSLEditor1 , this._policy );
                this.VPEditor.SetPolicy( this._policy , this , this._policyHandler );
                this.Prepare();
                this.Tag = this._ou.GetName() + &quot; &quot; + Properties.Resources.Policy;

                this.PolicyOverviewContainer.Child = new OuPolicyPane( this._ou );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void Prepare()
        {
            try
            {
                this.ImageCopy.Source = Framework.Images.GetImage( &quot;Copy&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageCut.Source = Framework.Images.GetImage( &quot;Cut&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageDelete.Source = Framework.Images.GetImage( &quot;Delete&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImagePaste.Source = Framework.Images.GetImage( &quot;Paste&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageRedo.Source = Framework.Images.GetImage( &quot;Redo&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageSave.Source = Framework.Images.GetImage( &quot;Save&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageSave1.Source = Framework.Images.GetImage( &quot;Save&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageUndo.Source = Framework.Images.GetImage( &quot;Undo&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageWrap.Source = Framework.Images.GetImage( &quot;WordWrap&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageDeleteRule.Source = Framework.Images.GetImage( &quot;Delete-PermissionHH&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
                this.ImageAddRule.Source = Framework.Images.GetImage( &quot;New-Permission&quot; , &quot;VS2010ImageLibrary&quot; ).Source;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void SaveMenuItemClick( object sender , RoutedEventArgs e )
        {
            try
            {
                this._policy.SetDsl( this._policyHandler.Document.Text );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void ToolBarLoaded( object sender , RoutedEventArgs e )
        {
            try
            {
                var toolBar = sender as ToolBar;
                if( toolBar != null )
                {
                    var overflowGrid = toolBar.Template.FindName( &quot;OverflowGrid&quot; , toolBar ) as FrameworkElement;
                    if( overflowGrid != null )
                    {
                        overflowGrid.Visibility = Visibility.Collapsed;
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void AddRowButtonClick( object sender , RoutedEventArgs e )
        {
            this.VPEditor.AddRow();
        }

        private void DeleteRowButtonClick( object sender , RoutedEventArgs e )
        {
            this.VPEditor.DeleteSelectedRows();
        }

        private void PolicyDslEditor1KeyUp( object sender , KeyEventArgs e )
        {
            if( e.Key == Key.Return )
            {
                this.VPEditor.Update( this._policy , null );
            }
        }

        #region Implementation of IUserControl

        /// &lt;summary&gt;
        ///   Aks the UserControl to do some clean up!
        /// &lt;/summary&gt;
        public void Dispose()
        {
            try
            {
                this._ou.Detach( this );
                this._policyHandler.Detach( this._policyHandler );
                this.VPEditor.Detach( this.VPEditor );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        /// Asks the Usercontrol to refresh itself
        /// &lt;/summary&gt;
        public void Refresh()
        {
            this.Tag = this._ou.GetName() + &quot; &quot; + Properties.Resources.Policy;
        }

        /// &lt;summary&gt;
        /// When the control is no longer in focus, asks it to pause ( heavy duty non critical, ie threads updating graphs )
        /// &lt;/summary&gt;
        public void Pause()
        {
            try
            {
            }
            catch( Exception )
            {
            }
        }

        /// &lt;summary&gt;
        /// When the tab comes back into focus, resume ( heavy duty non critical, ie threads updating graphs )
        /// &lt;/summary&gt;
        public void Resume()
        {
            try
            {
            }
            catch( Exception )
            {
            }
        }

        #endregion

        #region Implementation of IOuObserver

        /// &lt;summary&gt;
        ///   Update this observer with a refernece to the ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;Iou&lt;/param&gt;
        /// &lt;param name = &quot;source&quot;&gt;source observer&lt;/param&gt;
        public void Update( IOu ou , IOuObserver source )
        {
            try
            {
                this._ou = ou;
                this.Tag = this._ou.GetName() + &quot; Policy&quot;;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Attach objewcts that observer this IOu
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IOuObserver&lt;/param&gt;
        public void Attach( IOuObserver obj )
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Detach objewcts that observer this IOu
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IOuObserver&lt;/param&gt;
        public void Detach( IOuObserver obj )
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Notify observers of this IOu
        /// &lt;/summary&gt;
        public void Notify()
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Dispose this object and all the observers
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IOuObserver&lt;/param&gt;
        public void Dispose( IOuObserver obj )
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src319', RANGES_319)
		</script>
	</body>
</html>