<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_166 = [
   [31,9,31,29,'dccv']
, [32,9,32,10,'dccv']
, [34,13,34,14,'dccv']
, [35,17,35,44,'dccv']
, [36,17,36,53,'dccv']
, [37,13,37,14,'dccv']
, [42,9,42,10,'dccv']
, [46,9,46,10,'dccv']
, [48,13,48,14,'dccv']
, [49,17,49,149,'dccv']
, [50,13,50,14,'dccv']
, [55,9,55,10,'dccv']
, [59,9,59,10,'dccv']
, [61,13,61,14,'dccv']
, [62,17,62,67,'dccv']
, [63,17,63,18,'dccv']
, [64,21,64,118,'dccv']
, [65,21,65,77,'dccv']
, [67,21,67,65,'dccv']
, [68,21,68,60,'dccv']
, [69,21,69,60,'dccv']
, [70,21,70,56,'dccv']
, [71,21,71,60,'dccv']
, [72,21,72,79,'dccv']
, [74,21,74,254,'dccv']
, [76,21,76,84,'dccv']
, [77,17,77,18,'dccv']
, [82,13,82,14,'dccv']
, [87,9,87,10,'dccv']
, [91,9,91,10,'dccv']
, [93,13,93,14,'dccv']
, [94,17,94,68,'dccv']
, [96,17,96,64,'dccv']
, [97,17,97,18,'dccv']
, [98,21,98,33,'dccv']
, [108,9,108,10,'dccv']
, [112,9,112,10,'dccv']
, [114,13,114,14,'dccv']
, [115,17,115,107,'dccv']
, [117,17,117,88,'dccv']
, [117,116,117,121,'dccv']
, [118,13,118,14,'dccv']
, [123,9,123,10,'dccv']
, [127,9,127,10,'dccv']
, [129,13,129,14,'dccv']
, [130,17,130,29,'dccv']
, [131,17,131,18,'dccv']
, [132,21,132,33,'dccv']
, [133,21,133,81,'dccv']
, [134,17,134,18,'dccv']
, [140,17,140,60,'dccv']
, [141,17,141,55,'dccv']
, [142,17,142,55,'dccv']
, [143,17,143,51,'dccv']
, [144,17,144,55,'dccv']
, [145,13,145,14,'dccv']
, [150,9,150,10,'dccv']
, [171,9,171,10,'dccv']
, [172,13,172,50,'dccv']
, [173,9,173,10,'dccv']
, [188,9,188,10,'dccv']
, [190,13,190,14,'dccv']
, [191,17,191,37,'dccv']
, [192,17,192,50,'dccv']
, [194,17,194,67,'dccv']
, [195,17,195,18,'dccv']
, [196,21,196,118,'dccv']
, [197,21,197,70,'dccv']
, [198,21,198,82,'dccv']
, [199,21,199,82,'dccv']
, [200,21,200,78,'dccv']
, [201,21,201,78,'dccv']
, [202,17,202,18,'dccv']
, [203,13,203,14,'dccv']
, [208,9,208,10,'dccv']
, [216,9,216,10,'dccv']
, [218,13,218,14,'dccv']
, [219,17,219,47,'dccv']
, [220,17,220,90,'dccv']
, [222,17,222,50,'dccv']
, [223,17,223,58,'dccv']
, [225,17,225,24,'dccv']
, [225,38,225,70,'dccv']
, [225,26,225,34,'dccv']
, [226,17,226,18,'dccv']
, [227,21,227,34,'dccv']
, [228,21,228,64,'dccv']
, [229,21,229,22,'dccv']
, [230,25,230,71,'dccv']
, [231,21,231,22,'dccv']
, [232,17,232,18,'dccv']
, [225,35,225,37,'dccv']
, [234,17,234,77,'dccv']
, [235,17,235,77,'dccv']
, [236,17,236,73,'dccv']
, [237,17,237,73,'dccv']
, [238,13,238,14,'dccv']
, [243,9,243,10,'dccv']
, [250,9,250,10,'dccv']
, [251,13,251,40,'dccv']
, [252,9,252,10,'dccv']
, [259,9,259,10,'dccv']
, [260,13,260,89,'dccv']
, [261,9,261,10,'dccv']
, [117,88,117,116,'dccv']
, [38,13,38,37,'dcuc']
, [39,13,39,14,'dcuc']
, [40,17,40,53,'dcuc']
, [41,13,41,14,'dcuc']
, [51,13,51,37,'dcuc']
, [52,13,52,14,'dcuc']
, [53,17,53,53,'dcuc']
, [54,13,54,14,'dcuc']
, [79,17,79,18,'dcuc']
, [80,21,80,82,'dcuc']
, [81,17,81,18,'dcuc']
, [83,13,83,37,'dcuc']
, [84,13,84,14,'dcuc']
, [85,17,85,53,'dcuc']
, [86,13,86,14,'dcuc']
, [101,17,101,30,'dcuc']
, [103,13,103,37,'dcuc']
, [104,13,104,14,'dcuc']
, [105,17,105,53,'dcuc']
, [106,17,106,30,'dcuc']
, [119,13,119,37,'dcuc']
, [120,13,120,14,'dcuc']
, [121,17,121,53,'dcuc']
, [122,13,122,14,'dcuc']
, [136,17,136,18,'dcuc']
, [137,21,137,88,'dcuc']
, [138,17,138,18,'dcuc']
, [146,13,146,37,'dcuc']
, [147,13,147,14,'dcuc']
, [148,17,148,53,'dcuc']
, [149,13,149,14,'dcuc']
, [180,9,180,10,'dcuc']
, [181,13,181,25,'dcuc']
, [182,9,182,10,'dcuc']
, [204,13,204,37,'dcuc']
, [205,13,205,14,'dcuc']
, [206,17,206,53,'dcuc']
, [207,13,207,14,'dcuc']
, [239,13,239,37,'dcuc']
, [240,13,240,14,'dcuc']
, [241,17,241,53,'dcuc']
, [242,13,242,14,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src166" class="dotCoverSource"><pre>#region

using System;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using System.Windows.Threading;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Component;
using LGP.Components.Factory.Interfaces.Database;
using LGP.Components.Factory.Interfaces.Module;

#endregion

namespace LGP.Components.Database
{
    /// &lt;summary&gt;
    ///   Interaction logic for Preferences.xaml
    /// &lt;/summary&gt;
    public partial class Preferences : IPreferences
    {
        private IAsyncResult _aSyncResult;
        private ConnectionAttemptDelegate _attemptDelegate;
        private ISettings _parent;


        /// &lt;summary&gt;
        ///   Constructor
        /// &lt;/summary&gt;
        public Preferences()
        {
            try
            {
                this.InitializeComponent();
                this.passwordBox.PasswordChar = &#39;*&#39;;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

       
        private void DatabaseTypeComboBoxSelectionChanged( object sender , SelectionChangedEventArgs e )
        {
            try
            {
                this.suggestionDatabaseType.Foreground = this.databaseTypeComboBox.SelectedIndex &gt; -1 ? Brushes.DarkSlateGray : Brushes.DarkMagenta;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void ConnectButtonClick( object sender , RoutedEventArgs e )
        {
            try
            {
                if( this.databaseTypeComboBox.SelectedIndex &gt; -1 )
                {
                    var dbType = ( Type ) this.databaseTypeComboBox.Items[ this.databaseTypeComboBox.SelectedIndex ];
                    this._attemptDelegate = this.AtttemptDatabaseConnection;

                    this.databaseTypeComboBox.IsEnabled = false;
                    this.hostnameTextBox.IsEnabled = false;
                    this.usernameTextBox.IsEnabled = false;
                    this.passwordBox.IsEnabled = false;
                    this.databaseTextBox.IsEnabled = false;
                    this.connectButton.Content = Properties.Resources.Standby;

                    this._aSyncResult = this._attemptDelegate.BeginInvoke( dbType , this.usernameTextBox.Text , this.passwordBox.Password , this.hostnameTextBox.Text , this.databaseTextBox.Text , this.ConnectionAttemptCallback , this._attemptDelegate );

                    this.suggestionDatabaseType.Foreground = Brushes.DarkSlateGray;
                }
                else
                {
                    this.suggestionDatabaseType.Foreground = Brushes.DarkMagenta;
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private bool AtttemptDatabaseConnection( Type type , string user , string pass , string host , string dbname )
        {
            try
            {
                var db = Framework.Database.ChangeStrategy( type );

                if( db.Connect( user , pass , host , dbname ) )
                {
                    return true;
                }

                return false;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return false;
            }
        }


        private void ConnectionAttemptCallback( IAsyncResult result )
        {
            try
            {
                var returnValue = ( ( ConnectionAttemptDelegate ) result.AsyncState ).EndInvoke( result );

                this.Dispatcher.Invoke( DispatcherPriority.Normal , ( Action ) ( () =&gt; this.UpdateUi( returnValue ) ) );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void UpdateUi( bool result )
        {
            try
            {
                if( result )
                {
                    this.Save();
                    this.connectButton.Content = Properties.Resources.Connected;
                }
                else
                {
                    this.connectButton.Content = Properties.Resources.ConnectionFailed;
                }

                this.databaseTypeComboBox.IsEnabled = true;
                this.hostnameTextBox.IsEnabled = true;
                this.usernameTextBox.IsEnabled = true;
                this.passwordBox.IsEnabled = true;
                this.databaseTextBox.IsEnabled = true;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #region Nested type: ConnectionAttemptDelegate

        internal delegate bool ConnectionAttemptDelegate( Type type , string user , string pass , string host , string dbname );

        #endregion

        #region Nested type: ConnectionTimedOutDelegate

        internal delegate void ConnectionTimedOutDelegate();

        #endregion

        #region Implementation of IPreferences

        /// &lt;summary&gt;
        ///   Gets the name of the preferences Pane
        /// &lt;/summary&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string GetName()
        {
            return Properties.Resources.Database;
        }

        /// &lt;summary&gt;
        ///   Gets the preferences window
        /// &lt;/summary&gt;
        /// &lt;returns&gt;UserControl&lt;/returns&gt;
        public UserControl GetControl()
        {
            return this;
        }

        /// &lt;summary&gt;
        ///   Aks the preferences panel to save its entries
        /// &lt;/summary&gt;
        public void Save()
        {
            try
            {
                this._parent = null;
                var regedit = Framework.Registry;

                if( this.databaseTypeComboBox.SelectedIndex &gt; -1 )
                {
                    var dbType = ( Type ) this.databaseTypeComboBox.Items[ this.databaseTypeComboBox.SelectedIndex ];
                    regedit.WriteKey( &quot;dbtype&quot; , dbType.ToString() );
                    regedit.WriteKey( &quot;dbusername&quot; , this.usernameTextBox.Text );
                    regedit.WriteKey( &quot;dbpassword&quot; , this.passwordBox.Password );
                    regedit.WriteKey( &quot;dbname&quot; , this.databaseTextBox.Text );
                    regedit.WriteKey( &quot;dbhost&quot; , this.hostnameTextBox.Text );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Asks the preferences to load its settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;settingsParent&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public void Load( ISettings settingsParent )
        {
            try
            {
                this._parent = settingsParent;
                this.databaseTypeComboBox.DataContext = Framework.DatabaseTypes.ToList();

                var regedit = Framework.Registry;
                var dbType = regedit.ReadKey( &quot;dbtype&quot; );

                foreach( var item in Framework.DatabaseTypes.ToList() )
                {
                    var t = item;
                    if( t.ToString().CompareTo( dbType ) == 0 )
                    {
                        this.databaseTypeComboBox.SelectedItem = item;
                    }
                }

                this.usernameTextBox.Text = regedit.ReadKey( &quot;dbusername&quot; );
                this.passwordBox.Password = regedit.ReadKey( &quot;dbpassword&quot; );
                this.databaseTextBox.Text = regedit.ReadKey( &quot;dbname&quot; );
                this.hostnameTextBox.Text = regedit.ReadKey( &quot;dbhost&quot; );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        /// Gets the type it Controls
        /// &lt;/summary&gt;
        /// &lt;returns&gt;Type&lt;/returns&gt;
        public Type GetControlType()
        {
            return typeof( IDatabase );
        }

        /// &lt;summary&gt;
        ///   Gets the image that represents the module
        /// &lt;/summary&gt;
        /// &lt;returns&gt;An image&lt;/returns&gt;
        public Image GetIcon()
        {
            return Framework.Images.GetImage( &quot;database2&quot; , &quot;VS2010ImageLibrary&quot; , 14 );
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src166', RANGES_166)
		</script>
	</body>
</html>