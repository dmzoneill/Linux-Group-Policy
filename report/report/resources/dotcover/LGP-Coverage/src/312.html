<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_312 = [
   [48,9,48,91,'dccv']
, [49,9,49,10,'dccv']
, [51,13,51,14,'dccv']
, [52,17,52,39,'dccv']
, [53,17,53,42,'dccv']
, [54,17,54,39,'dccv']
, [55,17,55,45,'dccv']
, [57,17,60,19,'dccv']
, [61,17,64,19,'dccv']
, [65,17,68,19,'dccv']
, [69,17,72,19,'dccv']
, [73,17,76,19,'dccv']
, [78,17,78,41,'dccv']
, [79,17,79,46,'dccv']
, [80,17,80,57,'dccv']
, [81,17,81,36,'dccv']
, [82,17,82,29,'dccv']
, [84,17,84,60,'dccv']
, [85,17,85,72,'dccv']
, [86,13,86,14,'dccv']
, [91,9,91,10,'dccv']
, [100,13,100,14,'dccv']
, [101,17,101,39,'dccv']
, [102,13,102,14,'dccv']
, [104,13,104,14,'dccv']
, [105,17,105,40,'dccv']
, [106,17,106,61,'dccv']
, [107,13,107,14,'dccv']
, [117,13,117,14,'dccv']
, [118,17,118,36,'dccv']
, [119,13,119,14,'dccv']
, [129,13,129,14,'dccv']
, [130,17,130,37,'dccv']
, [131,13,131,14,'dccv']
, [141,13,141,14,'dccv']
, [142,17,142,34,'dccv']
, [143,13,143,14,'dccv']
, [153,13,153,14,'dccv']
, [154,17,154,34,'dccv']
, [155,13,155,14,'dccv']
, [180,13,180,14,'dccv']
, [181,17,181,40,'dccv']
, [182,13,182,14,'dccv']
, [193,9,193,10,'dccv']
, [195,13,195,14,'dccv']
, [196,17,196,39,'dccv']
, [197,17,197,61,'dccv']
, [198,13,198,14,'dccv']
, [203,9,203,10,'dccv']
, [225,9,225,10,'dccv']
, [227,13,227,14,'dccv']
, [228,17,228,45,'dccv']
, [229,13,229,14,'dccv']
, [234,9,234,10,'dccv']
, [270,9,270,10,'dccv']
, [272,13,272,14,'dccv']
, [273,17,273,54,'dccv']
, [274,17,274,71,'dccv']
, [275,17,275,66,'dccv']
, [276,17,276,68,'dccv']
, [277,17,277,63,'dccv']
, [278,17,278,73,'dccv']
, [279,17,279,65,'dccv']
, [280,17,280,59,'dccv']
, [281,17,281,73,'dccv']
, [282,17,282,74,'dccv']
, [283,17,283,55,'dccv']
, [285,17,285,136,'dccv']
, [287,17,287,92,'dccv']
, [288,13,288,14,'dccv']
, [293,9,293,10,'dccv']
, [296,9,296,10,'dccv']
, [297,13,297,55,'dccv']
, [298,9,298,10,'dccv']
, [301,9,301,10,'dccv']
, [303,13,303,14,'dccv']
, [304,17,307,19,'dccv']
, [308,17,308,111,'dccv']
, [310,17,313,21,'dccv']
, [314,17,317,21,'dccv']
, [318,17,321,21,'dccv']
, [322,17,325,21,'dccv']
, [326,17,329,21,'dccv']
, [330,13,330,14,'dccv']
, [335,9,335,10,'dccv']
, [339,9,339,10,'dccv']
, [341,13,341,14,'dccv']
, [342,17,342,71,'dccv']
, [343,17,343,92,'dccv']
, [344,17,344,83,'dccv']
, [345,17,345,81,'dccv']
, [346,13,346,14,'dccv']
, [351,9,351,10,'dccv']
, [355,9,355,10,'dccv']
, [357,13,357,14,'dccv']
, [358,17,358,83,'dccv']
, [359,17,359,66,'dccv']
, [360,17,360,64,'dccv']
, [361,17,361,66,'dccv']
, [362,17,362,59,'dccv']
, [363,17,363,56,'dccv']
, [364,13,364,14,'dccv']
, [369,9,369,10,'dccv']
, [373,9,373,10,'dccv']
, [375,13,375,14,'dccv']
, [376,17,376,52,'dccv']
, [377,17,377,38,'dccv']
, [381,13,381,14,'dccv']
, [386,9,386,10,'dccv']
, [390,9,390,10,'dccv']
, [392,13,392,14,'dccv']
, [393,17,393,71,'dccv']
, [395,17,395,84,'dccv']
, [397,17,397,86,'dccv']
, [399,17,399,58,'dccv']
, [400,17,400,104,'dccv']
, [401,17,401,32,'dccv']
, [403,17,403,72,'dccv']
, [404,13,404,14,'dccv']
, [409,9,409,10,'dccv']
, [412,9,412,10,'dccv']
, [413,13,413,64,'dccv']
, [414,13,414,28,'dccv']
, [415,13,415,44,'dccv']
, [417,18,417,28,'dccv']
, [418,13,418,14,'dccv']
, [420,17,420,18,'dccv']
, [421,21,421,61,'dccv']
, [422,21,422,35,'dccv']
, [423,17,423,18,'dccv']
, [428,13,428,14,'dccv']
, [417,53,417,56,'dccv']
, [417,29,417,51,'dccv']
, [430,13,430,14,'dccv']
, [431,17,431,66,'dccv']
, [432,13,432,14,'dccv']
, [439,13,439,26,'dccv']
, [440,9,440,10,'dccv']
, [443,9,443,10,'dccv']
, [445,13,445,14,'dccv']
, [446,17,449,19,'dccv']
, [451,17,451,63,'dccv']
, [452,17,452,65,'dccv']
, [453,13,453,14,'dccv']
, [458,9,458,10,'dccv']
, [462,9,462,10,'dccv']
, [464,13,464,14,'dccv']
, [465,17,465,63,'dccv']
, [466,17,466,65,'dccv']
, [467,13,467,14,'dccv']
, [472,9,472,10,'dccv']
, [475,9,475,10,'dccv']
, [476,13,476,53,'dccv']
, [477,9,477,10,'dccv']
, [480,9,480,10,'dccv']
, [482,13,482,14,'dccv']
, [483,17,483,89,'dccv']
, [484,17,484,37,'dccv']
, [487,17,487,53,'dccv']
, [488,17,488,40,'dccv']
, [491,17,491,18,'dccv']
, [492,21,492,70,'dccv']
, [493,21,493,102,'dccv']
, [494,21,494,22,'dccv']
, [495,25,495,32,'dccv']
, [496,21,496,22,'dccv']
, [498,21,498,22,'dccv']
, [499,25,499,81,'dccv']
, [500,25,500,29,'dccv']
, [501,21,501,22,'dccv']
, [502,17,502,18,'dccv']
, [490,17,490,62,'dccv']
, [504,17,504,44,'dccv']
, [505,17,505,18,'dccv']
, [506,21,509,23,'dccv']
, [510,21,511,21,'dccv']
, [512,55,513,23,'dccv']
, [515,21,515,85,'dccv']
, [517,21,517,72,'dccv']
, [518,21,518,52,'dccv']
, [520,21,520,28,'dccv']
, [520,40,520,48,'dccv']
, [520,30,520,36,'dccv']
, [521,21,521,22,'dccv']
, [522,25,522,67,'dccv']
, [523,25,523,26,'dccv']
, [524,29,524,92,'dccv']
, [525,25,525,26,'dccv']
, [526,21,526,22,'dccv']
, [520,37,520,39,'dccv']
, [528,21,528,41,'dccv']
, [529,21,529,22,'dccv']
, [530,25,530,55,'dccv']
, [531,21,531,22,'dccv']
, [532,17,532,18,'dccv']
, [534,17,534,72,'dccv']
, [535,13,535,14,'dccv']
, [540,9,540,10,'dccv']
, [544,9,544,10,'dccv']
, [545,13,545,36,'dccv']
, [546,9,546,10,'dccv']
, [549,9,549,10,'dccv']
, [551,13,551,14,'dccv']
, [552,17,552,74,'dccv']
, [553,17,553,18,'dccv']
, [554,21,554,63,'dccv']
, [555,21,555,22,'dccv']
, [556,25,556,85,'dccv']
, [557,21,557,22,'dccv']
, [558,17,558,18,'dccv']
, [559,13,559,14,'dccv']
, [564,9,564,10,'dccv']
, [511,21,511,22,'dccv']
, [512,25,512,55,'dccv']
, [87,13,87,37,'dcuc']
, [88,13,88,14,'dcuc']
, [89,17,89,53,'dcuc']
, [90,13,90,14,'dcuc']
, [164,13,164,14,'dcuc']
, [165,17,165,42,'dcuc']
, [166,13,166,14,'dcuc']
, [168,13,168,14,'dcuc']
, [169,17,169,51,'dcuc']
, [170,17,170,43,'dcuc']
, [171,13,171,14,'dcuc']
, [199,13,199,37,'dcuc']
, [200,13,200,14,'dcuc']
, [201,17,201,53,'dcuc']
, [202,13,202,14,'dcuc']
, [210,9,210,10,'dcuc']
, [212,13,212,14,'dcuc']
, [213,13,213,14,'dcuc']
, [214,13,214,37,'dcuc']
, [215,13,215,14,'dcuc']
, [216,17,216,53,'dcuc']
, [217,13,217,14,'dcuc']
, [218,9,218,10,'dcuc']
, [230,13,230,37,'dcuc']
, [231,13,231,14,'dcuc']
, [232,17,232,53,'dcuc']
, [233,13,233,14,'dcuc']
, [240,9,240,10,'dcuc']
, [242,13,242,14,'dcuc']
, [243,13,243,14,'dcuc']
, [244,13,244,37,'dcuc']
, [245,13,245,14,'dcuc']
, [246,17,246,53,'dcuc']
, [247,13,247,14,'dcuc']
, [248,9,248,10,'dcuc']
, [255,9,255,10,'dcuc']
, [257,13,257,14,'dcuc']
, [258,17,258,45,'dcuc']
, [259,17,259,37,'dcuc']
, [260,13,260,14,'dcuc']
, [261,13,261,37,'dcuc']
, [262,13,262,14,'dcuc']
, [263,17,263,53,'dcuc']
, [264,13,264,14,'dcuc']
, [265,9,265,10,'dcuc']
, [289,13,289,37,'dcuc']
, [290,13,290,14,'dcuc']
, [291,17,291,53,'dcuc']
, [292,13,292,14,'dcuc']
, [331,13,331,37,'dcuc']
, [332,13,332,14,'dcuc']
, [333,17,333,53,'dcuc']
, [334,13,334,14,'dcuc']
, [347,13,347,37,'dcuc']
, [348,13,348,14,'dcuc']
, [349,17,349,53,'dcuc']
, [350,13,350,14,'dcuc']
, [365,13,365,37,'dcuc']
, [366,13,366,14,'dcuc']
, [367,17,367,53,'dcuc']
, [368,13,368,14,'dcuc']
, [378,17,378,18,'dcuc']
, [379,21,379,76,'dcuc']
, [380,17,380,18,'dcuc']
, [382,13,382,37,'dcuc']
, [383,13,383,14,'dcuc']
, [384,17,384,53,'dcuc']
, [385,13,385,14,'dcuc']
, [405,13,405,37,'dcuc']
, [406,13,406,14,'dcuc']
, [407,17,407,53,'dcuc']
, [408,13,408,14,'dcuc']
, [424,17,424,41,'dcuc']
, [425,17,425,18,'dcuc']
, [426,21,426,65,'dcuc']
, [427,17,427,18,'dcuc']
, [433,13,433,37,'dcuc']
, [434,13,434,14,'dcuc']
, [435,17,435,65,'dcuc']
, [436,17,436,61,'dcuc']
, [437,13,437,14,'dcuc']
, [454,13,454,37,'dcuc']
, [455,13,455,14,'dcuc']
, [456,17,456,53,'dcuc']
, [457,13,457,14,'dcuc']
, [468,13,468,37,'dcuc']
, [469,13,469,14,'dcuc']
, [470,17,470,53,'dcuc']
, [471,13,471,14,'dcuc']
, [536,13,536,37,'dcuc']
, [537,13,537,14,'dcuc']
, [538,17,538,53,'dcuc']
, [539,13,539,14,'dcuc']
, [560,13,560,37,'dcuc']
, [561,13,561,14,'dcuc']
, [562,17,562,53,'dcuc']
, [563,13,563,14,'dcuc']
, [571,9,571,10,'dcuc']
, [572,13,572,39,'dcuc']
, [573,9,573,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src312" class="dotCoverSource"><pre>#region

using System;
using System.ComponentModel;
using System.IO;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Input;
using System.Xml;
using ICSharpCode.AvalonEdit;
using ICSharpCode.AvalonEdit.CodeCompletion;
using ICSharpCode.AvalonEdit.Document;
using ICSharpCode.AvalonEdit.Highlighting;
using ICSharpCode.AvalonEdit.Highlighting.Xshd;
using ICSharpCode.AvalonEdit.Rendering;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;

#endregion

namespace LGP.Modules.PolicyEditor.Internal
{
    /// &lt;summary&gt;
    /// &lt;/summary&gt;
    public class PolicyHandler : IPolicyObserver , INotifyPropertyChanged
    {
        private static IHighlightingDefinition _highLightDefintion;
        private readonly Label _col;
        private readonly TextEditor _editor1;
        private readonly Label _length;
        private readonly Label _lines;
        private readonly PolicyEditor _parent;
        private readonly Label _row;
        private readonly Label _selection;
        private int _caretoffset;
        private CompletionWindow _completionWindow;
        private TextDocument _document;
        private int _hashContents;
        private IPolicy _policy;

        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;parent&quot;&gt;&lt;/param&gt;
        /// &lt;param name = &quot;aeditor1&quot;&gt;&lt;/param&gt;
        /// &lt;param name = &quot;policy&quot;&gt;&lt;/param&gt;
        public PolicyHandler( PolicyEditor parent , TextEditor aeditor1 , IPolicy policy )
        {
            try
            {
                this._parent = parent;
                this._editor1 = aeditor1;
                this._policy = policy;
                this._policy.Attach( this );

                this._col = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._length = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._lines = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._row = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._selection = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };

                this.SetUpLookAndFeel();
                this.PrepareEditorContents();
                this.LoadGrammerKeyHighLightDefintion();
                this.SetHandlers();
                this.Bind();

                this._document.UndoStack = new UndoStack();
                this._hashContents = this._document.Text.GetHashCode();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Document associated with this object
        /// &lt;/summary&gt;
        public TextDocument Document
        {
            get
            {
                return this._document;
            }
            set
            {
                this._document = value;
                this.OnPropertyChanged( &quot;DocumentChanged&quot; );
            }
        }


        /// &lt;summary&gt;
        ///   Get the lines count
        /// &lt;/summary&gt;
        public Label LineCount
        {
            get
            {
                return this._lines;
            }
        }


        /// &lt;summary&gt;
        ///   Get the module lenght
        /// &lt;/summary&gt;
        public Label FileLength
        {
            get
            {
                return this._length;
            }
        }


        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public Label CaretRow
        {
            get
            {
                return this._row;
            }
        }


        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public Label CaretCol
        {
            get
            {
                return this._col;
            }
        }

        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public int CaretOffset
        {
            get
            {
                return this._caretoffset;
            }
            set
            {
                this._editor1.CaretOffset = value;
                this._caretoffset = value;
            }
        }

        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public Label SelectionLength
        {
            get
            {
                return this._selection;
            }
        }

        #region Implementation of IPolicyObserver

        /// &lt;summary&gt;
        ///   Update this observer with a refernece to the ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;policy&quot;&gt;IPolicy&lt;/param&gt;
        /// &lt;param name = &quot;source&quot;&gt;source observer&lt;/param&gt;
        public void Update( IPolicy policy , IPolicyObserver source )
        {
            try
            {
                this._policy = policy;
                this._document.Text = this._policy.GetDsl();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Attach objects that observer this IPolicy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IPolicyObserver&lt;/param&gt;
        public void Attach( IPolicyObserver obj )
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Detach objects that observer this IPolicy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IPolicyObserver&lt;/param&gt;
        public void Detach( IPolicyObserver obj )
        {
            try
            {
                this._policy.Detach( this );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Notify observers of this IPolicy
        /// &lt;/summary&gt;
        public void Notify()
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Dispose this object and all the observers
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IPolicyObserver&lt;/param&gt;
        public void Dispose( IPolicyObserver obj )
        {
            try
            {
                this._policy.Detach( this );
                this._policy = null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion

        private void SetUpLookAndFeel()
        {
            try
            {
                this._editor1.ShowLineNumbers = true;
                this._editor1.Options.AllowScrollBelowDocument = true;
                this._editor1.Options.ConvertTabsToSpaces = true;
                this._editor1.Options.EnableEmailHyperlinks = true;
                this._editor1.Options.EnableHyperlinks = true;
                this._editor1.Options.EnableRectangularSelection = true;
                this._editor1.Options.EnableTextDragDrop = true;
                this._editor1.Options.IndentationSize = 4;
                this._editor1.Options.InheritWordWrapIndentation = true;
                this._editor1.Options.ShowBoxForControlCharacters = true;
                this._editor1.Options.ShowTabs = true;

                this._editor1.TextArea.TextView.BackgroundRenderers.Add( new HighlightCurrentLineBackgroundRenderer( this._editor1 ) );

                this._editor1.TextArea.Caret.PositionChanged += this.CaretPositionChanged1;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void CaretPositionChanged1( object sender , EventArgs e )
        {
            this.CaretChangedUpdater( this._editor1 );
        }

        private void Bind()
        {
            try
            {
                var documentBinding = new Binding( &quot;Document&quot; )
                {
                    Source = this
                };
                BindingOperations.SetBinding( this._editor1 , TextEditor.DocumentProperty , documentBinding );

                BindingOperations.SetBinding( this._parent.FileLine , ContentControl.ContentProperty , new Binding( &quot;CaretRow&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileColumn , ContentControl.ContentProperty , new Binding( &quot;CaretCol&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileSelection , ContentControl.ContentProperty , new Binding( &quot;SelectionLength&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileLength , ContentControl.ContentProperty , new Binding( &quot;FileLength&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileLines , ContentControl.ContentProperty , new Binding( &quot;LineCount&quot; )
                {
                    Source = this
                } );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void SetHandlers()
        {
            try
            {
                this.Document.TextChanged += this.DocumentTextChanged;
                this._editor1.TextArea.Caret.PositionChanged += this.CaretPositionChanged1;
                this._editor1.TextArea.TextEntering += this.TextAreaTextEntering1;
                this._editor1.TextArea.TextEntered += this.TextAreaTextEntered1;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void CaretChangedUpdater( TextEditor editor )
        {
            try
            {
                editor.TextArea.TextView.InvalidateLayer( KnownLayer.Background );
                this._col.Content = editor.TextArea.Caret.Column;
                this._row.Content = editor.TextArea.Caret.Line;
                this._selection.Content = editor.SelectionLength;
                this._length.Content = editor.Text.Length;
                this._caretoffset = editor.CaretOffset;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void OnPropertyChanged( string info )
        {
            try
            {
                var handler = this.PropertyChanged;
                if( handler != null )
                {
                    handler( this , new PropertyChangedEventArgs( info ) );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void LoadGrammerKeyHighLightDefintion()
        {
            try
            {
                var template = File.ReadAllText( &quot;dsltemplate.xshd&quot; );

                template = template.Replace( &quot;{words}&quot; , this.BuildGrammerKeys() );

                var stream = new MemoryStream( Encoding.ASCII.GetBytes( template ) );

                var reader = new XmlTextReader( stream );
                _highLightDefintion = HighlightingLoader.Load( reader , HighlightingManager.Instance );
                reader.Close();

                this._editor1.SyntaxHighlighting = _highLightDefintion;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private string BuildGrammerKeys()
        {
            var gw = Framework.Database.CreateGrammerGateway();
            var names = &quot;&quot;;
            var grammers = gw.GetGrammer();

            for( var k = 0; k &lt; grammers.Count - 1; k++ )
            {
                try
                {
                    var next = grammers[ k ].GetKey() + &quot;|&quot;;
                    names += next;
                }
                catch( Exception error )
                {
                    Framework.EventBus.Publish( error.Message );
                }
            }
            try
            {
                names += grammers[ grammers.Count - 1 ].GetKey();
            }
            catch( Exception error )
            {
                names = names.Substring( 0 , names.Length - 1 );
                Framework.EventBus.Publish( error.Message );
            }

            return names;
        }

        private void PrepareEditorContents()
        {
            try
            {
                this.Document = new TextDocument
                {
                    Text = this._policy.GetDsl()
                };

                this._lines.Content = this.Document.LineCount;
                this._length.Content = this.Document.TextLength;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DocumentTextChanged( object sender , EventArgs e )
        {
            try
            {
                this._lines.Content = this.Document.LineCount;
                this._length.Content = this.Document.TextLength;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void TextAreaTextEntered1( object sender , TextCompositionEventArgs e )
        {
            this.HandleTextEntered( this._editor1 );
        }

        private void HandleTextEntered( TextEditor editor )
        {
            try
            {
                var currentline = editor.Document.GetLineByOffset( editor.CaretOffset );
                var startswith = &quot;&quot;;
                const char space = &#39; &#39;;

                var currentPos = editor.CaretOffset;
                var i = currentPos - 1;

                while( i &gt; -1 &amp;&amp; i &gt; currentline.Offset - 1 )
                {
                    var previousChar = this._document.GetCharAt( i );
                    if( previousChar.CompareTo( space ) == 0 || previousChar.CompareTo( &#39;\t&#39; ) == 0 )
                    {
                        i = -2;
                    }
                    else
                    {
                        startswith = this._document.GetCharAt( i ) + startswith;
                        i--;
                    }
                }

                if( startswith.Length &gt; 0 )
                {
                    this._completionWindow = new CompletionWindow( editor.TextArea )
                    {
                        WindowStyle = WindowStyle.None , Background = null , AllowsTransparency = true
                    };
                    this._completionWindow.Closed += delegate
                    {
                        this._completionWindow = null;
                    };

                    var data = this._completionWindow.CompletionList.CompletionData;

                    var gw = Framework.Database.CreateGrammerGateway();
                    var grammers = gw.GetGrammer();

                    foreach( var gr in grammers )
                    {
                        if( gr.GetKey().StartsWith( startswith ) )
                        {
                            data.Add( new CompletionData( gr.GetKey() , startswith , 0 ) );
                        }
                    }

                    if( data.Count &gt; 0 )
                    {
                        this._completionWindow.Show();
                    }
                }

                this._hashContents = this._document.Text.GetHashCode();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void TextAreaTextEntering1( object sender , TextCompositionEventArgs e )
        {
            this.TextEntering( e );
        }

        private void TextEntering( TextCompositionEventArgs e )
        {
            try
            {
                if( e.Text.Length &gt; 0 &amp;&amp; this._completionWindow != null )
                {
                    if( !char.IsLetterOrDigit( e.Text[ 0 ] ) )
                    {
                        this._completionWindow.CompletionList.RequestInsertion( e );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Gets the has of the document
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public int GetHash()
        {
            return this._hashContents;
        }

        #region Implementation of INotifyPropertyChanged

        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src312', RANGES_312)
		</script>
	</body>
</html>