<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_253 = [
   [26,9,26,10,'dccv']
, [27,13,27,90,'dccv']
, [28,9,28,10,'dccv']
, [38,9,38,10,'dccv']
, [39,13,39,34,'dccv']
, [40,13,40,14,'dccv']
, [41,17,41,60,'dccv']
, [43,17,43,38,'dccv']
, [44,17,44,18,'dccv']
, [45,21,45,63,'dccv']
, [46,21,46,39,'dccv']
, [47,21,47,44,'dccv']
, [48,21,48,42,'dccv']
, [49,17,49,18,'dccv']
, [50,13,50,14,'dccv']
, [52,13,52,28,'dccv']
, [53,9,53,10,'dccv']
, [56,9,56,10,'dccv']
, [58,13,58,14,'dccv']
, [59,17,59,44,'dccv']
, [60,17,60,18,'dccv']
, [61,21,62,21,'dccv']
, [72,48,73,27,'dccv']
, [74,17,74,18,'dccv']
, [76,17,76,101,'dccv']
, [78,17,78,63,'dccv']
, [80,17,80,24,'dccv']
, [80,39,80,45,'dccv']
, [80,26,80,35,'dccv']
, [81,17,81,18,'dccv']
, [82,21,82,121,'dccv']
, [83,17,83,18,'dccv']
, [80,36,80,38,'dccv']
, [85,17,86,17,'dccv']
, [92,22,93,23,'dccv']
, [94,13,94,14,'dccv']
, [99,9,99,10,'dccv']
, [103,9,103,10,'dccv']
, [105,13,105,14,'dccv']
, [108,17,108,57,'dccv']
, [110,17,110,24,'dccv']
, [110,49,110,62,'dccv']
, [110,26,110,45,'dccv']
, [111,17,111,18,'dccv']
, [112,21,112,87,'dccv']
, [117,17,117,18,'dccv']
, [110,46,110,48,'dccv']
, [119,17,119,69,'dccv']
, [121,17,121,57,'dccv']
, [122,17,122,18,'dccv']
, [123,21,123,77,'dccv']
, [125,21,125,46,'dccv']
, [126,21,126,38,'dccv']
, [127,21,127,68,'dccv']
, [128,21,128,41,'dccv']
, [130,21,130,83,'dccv']
, [131,21,131,49,'dccv']
, [132,21,132,81,'dccv']
, [133,17,133,18,'dccv']
, [134,13,134,14,'dccv']
, [139,9,139,10,'dccv']
, [143,9,143,10,'dccv']
, [145,13,145,14,'dccv']
, [146,22,146,32,'dccv']
, [147,17,147,18,'dccv']
, [148,21,148,110,'dccv']
, [149,21,149,22,'dccv']
, [150,25,150,77,'dccv']
, [151,25,151,79,'dccv']
, [152,25,152,62,'dccv']
, [153,25,153,86,'dccv']
, [154,25,154,66,'dccv']
, [156,25,156,50,'dccv']
, [157,25,157,42,'dccv']
, [158,25,158,57,'dccv']
, [159,25,159,45,'dccv']
, [161,25,161,53,'dccv']
, [163,25,163,31,'dccv']
, [165,17,165,18,'dccv']
, [146,58,146,61,'dccv']
, [146,33,146,56,'dccv']
, [166,13,166,14,'dccv']
, [171,9,171,10,'dccv']
, [175,9,175,10,'dccv']
, [177,13,177,14,'dccv']
, [178,17,178,42,'dccv']
, [179,17,179,37,'dccv']
, [180,17,180,18,'dccv']
, [181,21,181,39,'dccv']
, [182,21,182,44,'dccv']
, [183,21,183,42,'dccv']
, [184,17,184,18,'dccv']
, [185,13,185,14,'dccv']
, [190,9,190,10,'dccv']
, [62,21,62,22,'dccv']
, [63,25,63,58,'dccv']
, [66,25,66,26,'dccv']
, [67,29,67,86,'dccv']
, [68,29,68,46,'dccv']
, [69,29,69,58,'dccv']
, [70,25,70,26,'dccv']
, [65,25,65,40,'dccv']
, [72,25,72,48,'dccv']
, [86,17,86,18,'dccv']
, [87,21,87,44,'dccv']
, [89,26,89,36,'dccv']
, [90,21,90,22,'dccv']
, [91,25,91,101,'dccv']
, [92,21,92,22,'dccv']
, [89,62,89,65,'dccv']
, [89,37,89,60,'dccv']
, [95,13,95,37,'dcuc']
, [96,13,96,14,'dcuc']
, [97,17,97,53,'dcuc']
, [98,13,98,14,'dcuc']
, [113,21,113,22,'dcuc']
, [114,25,114,103,'dcuc']
, [115,25,115,32,'dcuc']
, [135,13,135,37,'dcuc']
, [136,13,136,14,'dcuc']
, [137,17,137,53,'dcuc']
, [138,13,138,14,'dcuc']
, [167,13,167,37,'dcuc']
, [168,13,168,14,'dcuc']
, [169,17,169,53,'dcuc']
, [170,13,170,14,'dcuc']
, [186,13,186,37,'dcuc']
, [187,13,187,14,'dcuc']
, [188,17,188,53,'dcuc']
, [189,13,189,14,'dcuc']
, [194,9,194,10,'dcuc']
, [196,13,196,14,'dcuc']
, [197,22,197,32,'dcuc']
, [198,17,198,18,'dcuc']
, [199,21,199,84,'dcuc']
, [200,21,200,22,'dcuc']
, [201,25,201,51,'dcuc']
, [203,17,203,18,'dcuc']
, [197,58,197,61,'dcuc']
, [197,33,197,56,'dcuc']
, [204,17,204,29,'dcuc']
, [206,13,206,37,'dcuc']
, [207,13,207,14,'dcuc']
, [208,17,208,53,'dcuc']
, [209,17,209,29,'dcuc']
, [211,9,211,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src253" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;
using System.Windows.Controls;
using System.Windows.Threading;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;
using LGP.Components.Factory.Interfaces.Network;
using LGP.Modules.ModuleEditor.Internal.CustomControls;
using Newtonsoft.Json;

#endregion

namespace LGP.Modules.ModuleEditor.Internal
{
    internal class ModuleHandler
    {
        private static IServerController _client;
        private static readonly Regex UseModuleRegex;
        private static List&lt; ModuleFileState &gt; _modulesFiles;

        static ModuleHandler()
        {
            UseModuleRegex = new Regex( &quot;use(\\s+)base(\\s+)(\&quot;|&#39;)Module(\&quot;|&#39;)(\\s*);&quot; );
        }

        public static StackPanel Panel
        {
            get;
            set;
        }


        public static IServerController GetClient()
        {
            if( _client == null )
            {
                _client = Framework.Network.CreateClient();

                if( _client != null )
                {
                    _client.OnDataReceived += ModulesReceived;
                    _client.Connect();
                    _client.FetchModules();
                    _client.Disconnect();
                }
            }

            return _client;
        }

        private static void ModulesReceived( string data )
        {
            try
            {
                if( _modulesFiles != null )
                {
                    Panel.Dispatcher.BeginInvoke( DispatcherPriority.Normal , ( Action ) ( delegate
                    {
                        var g = Panel.Children.Count - 1;

                        while( g &gt; -1 )
                        {
                            var el = ( StackPanelModuleElement ) Panel.Children[ g ];
                            el.Dispose( el );
                            g = Panel.Children.Count - 1;
                        }

                        Panel.Children.Clear();
                    } ) );
                }

                var values = JsonConvert.DeserializeObject&lt; Dictionary&lt; string , string &gt; &gt;( data );

                _modulesFiles = new List&lt; ModuleFileState &gt;();

                foreach( var value in values )
                {
                    _modulesFiles.Add( new ModuleFileState( value.Key , Framework.Utils.Base64Decode( value.Value ) ) );
                }

                Panel.Dispatcher.BeginInvoke( DispatcherPriority.Normal , ( Action ) ( delegate
                {
                    Panel.Children.Clear();

                    for( var h = 0; h &lt; _modulesFiles.Count; h++ )
                    {
                        Panel.Children.Add( new StackPanelModuleElement( _modulesFiles[ h ] , h ) );
                    }
                } ) );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public static void CreateModule( string moduleName , StackPanel panel )
        {
            try
            {
                const string templateLocation = @&quot;Module.template&quot;;

                var moduleFullName = moduleName + &quot;.pm&quot;;

                foreach( var moduleFileState in _modulesFiles )
                {
                    if( moduleFileState.GetModuleName().CompareTo( moduleName ) == 0 )
                    {
                        Framework.Notification.Display( Properties.Resources.DuplicateModule , 5000 );
                        return;
                    }
                }

                var contents = File.ReadAllText( templateLocation );

                if( UseModuleRegex.IsMatch( contents ) )
                {
                    contents = contents.Replace( &quot;{PACKAGE}&quot; , moduleName );

                    var client = GetClient();
                    client.Connect();
                    client.SaveModule( moduleFullName , contents );
                    client.Disconnect();

                    var module = new ModuleFileState( moduleFullName , contents );
                    _modulesFiles.Add( module );
                    panel.Children.Add( new StackPanelModuleElement( module ) );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public static void DeleteModule( IModule module )
        {
            try
            {
                for( var g = 0; g &lt; _modulesFiles.Count; g++ )
                {
                    if( _modulesFiles[ g ].GetModuleLocation().CompareTo( module.GetModuleLocation() ) == 0 )
                    {
                        var modulename = _modulesFiles[ g ].GetModuleName();
                        var location = _modulesFiles[ g ].GetModuleLocation();
                        _modulesFiles[ g ].Dispose( module );
                        var moduleGateway = Framework.Database.CreateModuleGateway();
                        moduleGateway.DeleteModule( modulename );

                        var client = GetClient();
                        client.Connect();
                        client.DeleteModule( location );
                        client.Disconnect();

                        _modulesFiles.RemoveAt( g );

                        break;
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public static void RefreshModuleFiles()
        {
            try
            {
                var client = GetClient();
                if( client != null )
                {
                    _client.Connect();
                    _client.FetchModules();
                    _client.Disconnect();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public static ModuleFileState GetModuleFileByPackageName( string name )
        {
            try
            {
                for( var g = 0; g &lt; _modulesFiles.Count; g++ )
                {
                    if( _modulesFiles[ g ].GetModuleName().CompareTo( name ) == 0 )
                    {
                        return _modulesFiles[ g ];
                    }
                }
                return null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }
    }
}</pre></code><script type="text/javascript">
			applyranges('src253', RANGES_253)
		</script>
	</body>
</html>