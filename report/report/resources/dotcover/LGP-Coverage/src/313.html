<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_313 = [
   [43,9,43,36,'dccv']
, [50,9,50,36,'dccv']
, [51,9,51,10,'dccv']
, [53,13,53,14,'dccv']
, [54,17,54,44,'dccv']
, [55,17,55,78,'dccv']
, [56,17,56,102,'dccv']
, [57,17,57,58,'dccv']
, [58,17,58,48,'dccv']
, [59,13,59,14,'dccv']
, [64,9,64,10,'dccv']
, [100,9,100,10,'dccv']
, [102,13,102,14,'dccv']
, [103,17,103,63,'dccv']
, [104,17,104,18,'dccv']
, [105,21,105,28,'dccv']
, [132,9,132,10,'dccv']
, [185,9,185,10,'dccv']
, [187,13,187,14,'dccv']
, [188,17,188,39,'dccv']
, [189,17,189,45,'dccv']
, [190,17,190,39,'dccv']
, [191,17,191,41,'dccv']
, [192,17,192,36,'dccv']
, [193,13,193,14,'dccv']
, [198,9,198,10,'dccv']
, [201,9,201,10,'dccv']
, [203,13,203,14,'dccv']
, [204,17,204,36,'dccv']
, [205,17,205,71,'dccv']
, [207,17,207,55,'dccv']
, [208,17,208,132,'dccv']
, [210,17,210,102,'dccv']
, [212,17,212,48,'dccv']
, [213,17,213,18,'dccv']
, [214,21,214,28,'dccv']
, [217,17,217,64,'dccv']
, [219,17,219,24,'dccv']
, [219,41,219,49,'dccv']
, [219,26,219,37,'dccv']
, [220,17,220,18,'dccv']
, [221,21,221,117,'dccv']
, [222,21,222,95,'dccv']
, [223,21,223,122,'dccv']
, [224,21,224,72,'dccv']
, [225,21,225,37,'dccv']
, [227,21,227,66,'dccv']
, [229,21,229,28,'dccv']
, [229,47,229,60,'dccv']
, [229,30,229,43,'dccv']
, [230,21,230,22,'dccv']
, [231,25,231,60,'dccv']
, [232,25,232,42,'dccv']
, [234,25,234,32,'dccv']
, [234,49,234,63,'dccv']
, [234,34,234,45,'dccv']
, [235,25,235,26,'dccv']
, [236,29,236,65,'dccv']
, [238,29,238,61,'dccv']
, [239,29,239,30,'dccv']
, [240,33,240,42,'dccv']
, [243,29,243,57,'dccv']
, [244,29,244,30,'dccv']
, [245,33,245,42,'dccv']
, [248,29,248,84,'dccv']
, [249,29,249,30,'dccv']
, [250,33,250,42,'dccv']
, [253,29,253,47,'dccv']
, [255,29,255,59,'dccv']
, [256,29,256,30,'dccv']
, [257,33,257,40,'dccv']
, [257,57,257,71,'dccv']
, [257,42,257,53,'dccv']
, [258,33,258,34,'dccv']
, [259,37,259,68,'dccv']
, [260,33,260,34,'dccv']
, [257,54,257,56,'dccv']
, [261,29,261,30,'dccv']
, [263,29,263,30,'dccv']
, [264,33,264,61,'dccv']
, [265,29,265,30,'dccv']
, [267,29,267,51,'dccv']
, [268,29,268,40,'dccv']
, [270,29,270,61,'dccv']
, [271,29,271,30,'dccv']
, [272,33,272,42,'dccv']
, [275,29,275,55,'dccv']
, [276,25,276,26,'dccv']
, [234,46,234,48,'dccv']
, [278,25,278,109,'dccv']
, [279,25,279,61,'dccv']
, [280,25,280,51,'dccv']
, [281,21,281,22,'dccv']
, [229,44,229,46,'dccv']
, [282,17,282,18,'dccv']
, [219,38,219,40,'dccv']
, [284,17,284,57,'dccv']
, [286,17,286,24,'dccv']
, [286,40,286,62,'dccv']
, [286,26,286,36,'dccv']
, [287,17,287,18,'dccv']
, [289,21,289,22,'dccv']
, [290,25,290,81,'dccv']
, [291,25,291,55,'dccv']
, [292,25,292,26,'dccv']
, [293,29,293,93,'dccv']
, [294,25,294,26,'dccv']
, [295,21,295,22,'dccv']
, [299,17,299,18,'dccv']
, [286,37,286,39,'dccv']
, [300,13,300,14,'dccv']
, [305,9,305,10,'dccv']
, [309,9,309,10,'dccv']
, [310,13,310,64,'dccv']
, [311,9,311,10,'dccv']
, [315,9,315,10,'dccv']
, [316,13,316,30,'dccv']
, [319,13,319,14,'dccv']
, [320,17,320,27,'dccv']
, [321,17,321,44,'dccv']
, [324,17,324,18,'dccv']
, [325,21,325,48,'dccv']
, [326,21,326,51,'dccv']
, [327,21,327,22,'dccv']
, [328,25,328,39,'dccv']
, [329,25,329,31,'dccv']
, [331,21,331,25,'dccv']
, [332,17,332,18,'dccv']
, [323,17,323,33,'dccv']
, [334,17,334,64,'dccv']
, [335,17,335,61,'dccv']
, [337,17,337,29,'dccv']
, [338,17,338,18,'dccv']
, [339,21,339,48,'dccv']
, [340,21,340,22,'dccv']
, [341,25,341,96,'dccv']
, [342,21,342,22,'dccv']
, [343,17,343,18,'dccv']
, [345,17,345,18,'dccv']
, [346,21,346,38,'dccv']
, [347,17,347,18,'dccv']
, [348,13,348,14,'dccv']
, [354,13,354,26,'dccv']
, [355,9,355,10,'dccv']
, [362,9,362,10,'dccv']
, [364,13,364,14,'dccv']
, [365,17,365,38,'dccv']
, [370,17,370,51,'dccv']
, [372,17,372,77,'dccv']
, [373,17,373,52,'dccv']
, [375,17,375,55,'dccv']
, [376,17,376,43,'dccv']
, [378,17,378,44,'dccv']
, [379,17,379,45,'dccv']
, [380,17,380,40,'dccv']
, [382,17,382,48,'dccv']
, [384,17,384,55,'dccv']
, [386,17,386,34,'dccv']
, [387,13,387,14,'dccv']
, [392,9,392,10,'dccv']
, [400,9,400,10,'dccv']
, [402,13,402,14,'dccv']
, [403,17,403,38,'dccv']
, [408,17,408,77,'dccv']
, [410,17,410,27,'dccv']
, [411,17,411,44,'dccv']
, [414,17,414,18,'dccv']
, [415,21,415,48,'dccv']
, [416,21,416,42,'dccv']
, [417,21,417,22,'dccv']
, [418,25,418,50,'dccv']
, [419,25,419,48,'dccv']
, [420,25,420,29,'dccv']
, [421,21,421,22,'dccv']
, [422,21,422,25,'dccv']
, [423,17,423,18,'dccv']
, [413,17,413,33,'dccv']
, [425,17,425,34,'dccv']
, [427,17,427,48,'dccv']
, [428,13,428,14,'dccv']
, [433,9,433,10,'dccv']
, [437,9,437,10,'dccv']
, [439,13,439,14,'dccv']
, [440,17,440,46,'dccv']
, [441,17,441,18,'dccv']
, [442,21,442,67,'dccv']
, [443,17,443,18,'dccv']
, [445,17,445,69,'dccv']
, [446,17,446,18,'dccv']
, [447,21,447,47,'dccv']
, [448,21,448,22,'dccv']
, [449,25,449,76,'dccv']
, [451,25,451,69,'dccv']
, [457,30,457,61,'dccv']
, [458,25,458,26,'dccv']
, [459,29,459,104,'dccv']
, [460,29,460,56,'dccv']
, [461,29,461,60,'dccv']
, [462,25,462,26,'dccv']
, [464,25,464,54,'dccv']
, [466,25,466,60,'dccv']
, [467,21,467,22,'dccv']
, [469,21,469,22,'dccv']
, [470,25,470,45,'dccv']
, [471,25,471,35,'dccv']
, [472,25,472,52,'dccv']
, [475,25,475,26,'dccv']
, [476,29,476,56,'dccv']
, [477,29,477,72,'dccv']
, [484,29,484,33,'dccv']
, [485,25,485,26,'dccv']
, [474,25,474,41,'dccv']
, [487,25,487,38,'dccv']
, [497,25,497,46,'dccv']
, [498,25,498,26,'dccv']
, [499,29,499,36,'dccv']
, [501,21,501,22,'dccv']
, [503,21,503,67,'dccv']
, [504,17,504,18,'dccv']
, [506,17,506,32,'dccv']
, [507,13,507,14,'dccv']
, [508,13,508,37,'dccv']
, [509,13,509,14,'dccv']
, [510,17,510,53,'dccv']
, [511,13,511,14,'dccv']
, [512,9,512,10,'dccv']
, [515,9,515,10,'dccv']
, [517,13,517,14,'dccv']
, [518,17,518,47,'dccv']
, [519,17,519,18,'dccv']
, [520,21,520,28,'dccv']
, [523,17,523,55,'dccv']
, [524,17,524,49,'dccv']
, [526,17,526,38,'dccv']
, [528,17,528,24,'dccv']
, [528,51,528,61,'dccv']
, [528,26,528,47,'dccv']
, [529,17,529,18,'dccv']
, [530,21,530,81,'dccv']
, [532,21,532,77,'dccv']
, [533,21,533,22,'dccv']
, [534,25,534,73,'dccv']
, [535,21,535,22,'dccv']
, [537,21,537,77,'dccv']
, [538,21,538,22,'dccv']
, [539,25,539,73,'dccv']
, [540,21,540,22,'dccv']
, [542,21,542,77,'dccv']
, [547,21,547,77,'dccv']
, [552,21,552,77,'dccv']
, [557,21,557,77,'dccv']
, [562,21,562,77,'dccv']
, [567,21,567,77,'dccv']
, [572,21,572,77,'dccv']
, [577,21,577,78,'dccv']
, [582,21,582,78,'dccv']
, [587,21,587,43,'dccv']
, [588,17,588,18,'dccv']
, [528,48,528,50,'dccv']
, [590,17,590,38,'dccv']
, [592,17,592,132,'dccv']
, [593,17,593,71,'dccv']
, [594,17,594,95,'dccv']
, [596,17,596,51,'dccv']
, [597,13,597,14,'dccv']
, [602,9,602,10,'dccv']
, [605,9,605,10,'dccv']
, [607,13,607,14,'dccv']
, [608,17,608,63,'dccv']
, [613,17,613,77,'dccv']
, [614,17,614,18,'dccv']
, [615,21,615,48,'dccv']
, [616,17,616,18,'dccv']
, [618,17,618,77,'dccv']
, [619,17,619,18,'dccv']
, [620,21,620,48,'dccv']
, [621,17,621,18,'dccv']
, [623,17,623,73,'dccv']
, [624,17,624,18,'dccv']
, [625,21,625,48,'dccv']
, [626,17,626,18,'dccv']
, [627,13,627,14,'dccv']
, [632,9,632,10,'dccv']
, [635,9,635,10,'dccv']
, [637,13,637,14,'dccv']
, [638,17,638,61,'dccv']
, [639,17,639,39,'dccv']
, [640,17,640,18,'dccv']
, [641,21,641,62,'dccv']
, [642,17,642,18,'dccv']
, [643,13,643,14,'dccv']
, [648,9,648,10,'dccv']
, [651,9,651,10,'dccv']
, [653,13,653,14,'dccv']
, [654,17,654,50,'dccv']
, [655,17,655,34,'dccv']
, [657,17,657,61,'dccv']
, [658,17,658,39,'dccv']
, [659,17,659,18,'dccv']
, [660,21,660,81,'dccv']
, [661,21,661,57,'dccv']
, [662,21,662,22,'dccv']
, [663,25,663,74,'dccv']
, [664,21,664,22,'dccv']
, [665,17,665,18,'dccv']
, [667,17,667,59,'dccv']
, [668,17,668,68,'dccv']
, [669,17,669,38,'dccv']
, [670,17,670,18,'dccv']
, [671,21,671,81,'dccv']
, [672,21,672,48,'dccv']
, [673,21,673,22,'dccv']
, [674,25,674,61,'dccv']
, [677,33,677,60,'dccv']
, [678,33,678,39,'dccv']
, [680,33,680,60,'dccv']
, [681,33,681,39,'dccv']
, [683,33,683,60,'dccv']
, [684,33,684,39,'dccv']
, [686,33,686,60,'dccv']
, [687,33,687,39,'dccv']
, [689,33,689,60,'dccv']
, [690,33,690,39,'dccv']
, [710,21,710,22,'dccv']
, [711,17,711,18,'dccv']
, [712,13,712,14,'dccv']
, [717,9,717,10,'dccv']
, [721,9,721,10,'dccv']
, [722,13,722,45,'dccv']
, [723,9,723,10,'dccv']
, [733,9,733,10,'dccv']
, [735,13,735,14,'dccv']
, [736,17,736,37,'dccv']
, [741,17,741,39,'dccv']
, [742,17,742,36,'dccv']
, [743,13,743,14,'dccv']
, [748,9,748,10,'dccv']
, [767,9,767,10,'dccv']
, [769,13,769,14,'dccv']
, [770,17,770,45,'dccv']
, [771,13,771,14,'dccv']
, [776,9,776,10,'dccv']
, [60,13,60,37,'dcuc']
, [61,13,61,14,'dcuc']
, [62,17,62,53,'dcuc']
, [63,13,63,14,'dcuc']
, [67,9,67,10,'dcuc']
, [69,13,69,14,'dcuc']
, [70,17,70,41,'dcuc']
, [71,17,71,18,'dcuc']
, [72,21,72,28,'dcuc']
, [75,17,75,70,'dcuc']
, [77,17,77,88,'dcuc']
, [78,17,78,18,'dcuc']
, [79,21,79,28,'dcuc']
, [82,17,82,60,'dcuc']
, [83,17,83,55,'dcuc']
, [84,17,84,54,'dcuc']
, [86,17,86,48,'dcuc']
, [88,17,88,50,'dcuc']
, [90,17,90,34,'dcuc']
, [91,13,91,14,'dcuc']
, [92,13,92,37,'dcuc']
, [93,13,93,14,'dcuc']
, [94,17,94,53,'dcuc']
, [95,13,95,14,'dcuc']
, [96,9,96,10,'dcuc']
, [108,17,108,77,'dcuc']
, [110,17,110,75,'dcuc']
, [112,17,112,81,'dcuc']
, [113,17,113,18,'dcuc']
, [114,21,114,28,'dcuc']
, [117,17,117,118,'dcuc']
, [118,17,118,34,'dcuc']
, [119,17,119,18,'dcuc']
, [121,21,121,51,'dcuc']
, [122,21,122,93,'dcuc']
, [123,21,123,118,'dcuc']
, [124,17,124,18,'dcuc']
, [126,17,126,57,'dcuc']
, [127,13,127,14,'dcuc']
, [128,13,128,37,'dcuc']
, [129,13,129,14,'dcuc']
, [130,17,130,53,'dcuc']
, [131,13,131,14,'dcuc']
, [136,9,136,10,'dcuc']
, [137,13,137,74,'dcuc']
, [138,13,138,65,'dcuc']
, [139,13,139,43,'dcuc']
, [140,9,140,10,'dcuc']
, [144,9,144,10,'dcuc']
, [145,13,145,102,'dcuc']
, [146,13,146,14,'dcuc']
, [147,17,147,29,'dcuc']
, [150,13,150,101,'dcuc']
, [151,9,151,10,'dcuc']
, [155,9,155,10,'dcuc']
, [156,13,156,31,'dcuc']
, [159,13,159,14,'dcuc']
, [160,22,160,32,'dcuc']
, [161,17,161,18,'dcuc']
, [162,21,162,52,'dcuc']
, [163,21,163,62,'dcuc']
, [164,21,164,22,'dcuc']
, [165,25,165,38,'dcuc']
, [166,25,166,31,'dcuc']
, [168,17,168,18,'dcuc']
, [160,65,160,68,'dcuc']
, [160,33,160,63,'dcuc']
, [169,13,169,14,'dcuc']
, [170,13,170,37,'dcuc']
, [171,13,171,14,'dcuc']
, [172,17,172,53,'dcuc']
, [173,13,173,14,'dcuc']
, [175,13,175,29,'dcuc']
, [176,9,176,10,'dcuc']
, [194,13,194,37,'dcuc']
, [195,13,195,14,'dcuc']
, [196,17,196,53,'dcuc']
, [197,13,197,14,'dcuc']
, [296,21,296,39,'dcuc']
, [297,21,297,22,'dcuc']
, [298,21,298,22,'dcuc']
, [301,13,301,37,'dcuc']
, [302,13,302,14,'dcuc']
, [303,17,303,53,'dcuc']
, [304,13,304,14,'dcuc']
, [349,13,349,37,'dcuc']
, [350,13,350,14,'dcuc']
, [351,17,351,53,'dcuc']
, [352,13,352,14,'dcuc']
, [366,17,366,18,'dcuc']
, [367,21,367,28,'dcuc']
, [388,13,388,37,'dcuc']
, [389,13,389,14,'dcuc']
, [390,17,390,53,'dcuc']
, [391,13,391,14,'dcuc']
, [404,17,404,18,'dcuc']
, [405,21,405,28,'dcuc']
, [429,13,429,37,'dcuc']
, [430,13,430,14,'dcuc']
, [431,17,431,53,'dcuc']
, [432,13,432,14,'dcuc']
, [452,25,452,26,'dcuc']
, [453,29,453,105,'dcuc']
, [454,29,454,56,'dcuc']
, [455,29,455,60,'dcuc']
, [456,25,456,26,'dcuc']
, [478,29,478,30,'dcuc']
, [479,33,479,48,'dcuc']
, [480,33,480,58,'dcuc']
, [481,33,481,56,'dcuc']
, [482,33,482,37,'dcuc']
, [483,29,483,30,'dcuc']
, [488,25,488,26,'dcuc']
, [489,29,489,60,'dcuc']
, [491,29,491,95,'dcuc']
, [492,29,492,30,'dcuc']
, [493,33,493,79,'dcuc']
, [494,29,494,30,'dcuc']
, [495,25,495,26,'dcuc']
, [543,21,543,22,'dcuc']
, [544,25,544,73,'dcuc']
, [545,21,545,22,'dcuc']
, [548,21,548,22,'dcuc']
, [549,25,549,73,'dcuc']
, [550,21,550,22,'dcuc']
, [553,21,553,22,'dcuc']
, [554,25,554,73,'dcuc']
, [555,21,555,22,'dcuc']
, [558,21,558,22,'dcuc']
, [559,25,559,73,'dcuc']
, [560,21,560,22,'dcuc']
, [563,21,563,22,'dcuc']
, [564,25,564,73,'dcuc']
, [565,21,565,22,'dcuc']
, [568,21,568,22,'dcuc']
, [569,25,569,73,'dcuc']
, [570,21,570,22,'dcuc']
, [573,21,573,22,'dcuc']
, [574,25,574,73,'dcuc']
, [575,21,575,22,'dcuc']
, [578,21,578,22,'dcuc']
, [579,25,579,74,'dcuc']
, [580,21,580,22,'dcuc']
, [583,21,583,22,'dcuc']
, [584,25,584,74,'dcuc']
, [585,21,585,22,'dcuc']
, [598,13,598,37,'dcuc']
, [599,13,599,14,'dcuc']
, [600,17,600,53,'dcuc']
, [601,13,601,14,'dcuc']
, [609,17,609,18,'dcuc']
, [610,21,610,28,'dcuc']
, [628,13,628,37,'dcuc']
, [629,13,629,14,'dcuc']
, [630,17,630,53,'dcuc']
, [631,13,631,14,'dcuc']
, [644,13,644,37,'dcuc']
, [645,13,645,14,'dcuc']
, [646,17,646,53,'dcuc']
, [647,13,647,14,'dcuc']
, [692,33,692,60,'dcuc']
, [693,33,693,39,'dcuc']
, [695,33,695,60,'dcuc']
, [696,33,696,39,'dcuc']
, [698,33,698,60,'dcuc']
, [699,33,699,39,'dcuc']
, [701,33,701,60,'dcuc']
, [702,33,702,39,'dcuc']
, [704,33,704,61,'dcuc']
, [705,33,705,39,'dcuc']
, [707,33,707,61,'dcuc']
, [708,33,708,39,'dcuc']
, [713,13,713,37,'dcuc']
, [714,13,714,14,'dcuc']
, [715,17,715,53,'dcuc']
, [716,13,716,14,'dcuc']
, [737,17,737,18,'dcuc']
, [738,21,738,28,'dcuc']
, [744,13,744,37,'dcuc']
, [745,13,745,14,'dcuc']
, [746,17,746,53,'dcuc']
, [747,13,747,14,'dcuc']
, [755,9,755,10,'dcuc']
, [756,13,756,30,'dcuc']
, [757,13,757,14,'dcuc']
, [758,17,758,24,'dcuc']
, [760,9,760,10,'dcuc']
, [772,13,772,37,'dcuc']
, [773,13,773,14,'dcuc']
, [774,17,774,53,'dcuc']
, [775,13,775,14,'dcuc']
, [782,9,782,10,'dcuc']
, [783,9,783,10,'dcuc']
, [790,9,790,10,'dcuc']
, [791,13,791,30,'dcuc']
, [792,13,792,14,'dcuc']
, [793,17,793,24,'dcuc']
, [795,9,795,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src313" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Text;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Input;
using System.Windows.Media;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;

#endregion

namespace LGP.Modules.PolicyEditor.Internal.CustomControls
{
    /// &lt;summary&gt;
    /// Interaction logic for VisualPolicyEditor.xaml
    /// &lt;/summary&gt;
    public partial class VisualPolicyEditor : IPolicyObserver
    {
        #region Delegates

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;element&quot;&gt;&lt;/param&gt;
        public delegate Point Position( IInputElement element );

        #endregion

        private readonly ObservableCollection&lt; VisualPolicyEntry &gt; _list;
        private object _addedEntry;
        private bool _addingNewEntry;
        private int _colCount;
        private IGrammerGateway _ggw;
        private PolicyHandler _handler;
        private PolicyEditor _parent;
        private IPolicy _policy;
        private int _rowIndex = -1;
        private object _selection;
        private bool _updatingFromEditor;

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        public VisualPolicyEditor()
        {
            try
            {
                this.InitializeComponent();
                this._list = new ObservableCollection&lt; VisualPolicyEntry &gt;();
                this.dataGrid1.PreviewMouseLeftButtonDown += this.DataGridPreviewMouseLeftButtonDown;
                this.dataGrid1.Drop += this.DataGridDrop;
                this.Tag = &quot;Statistics Viewer&quot;;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void DataGridDrop( object sender , DragEventArgs e )
        {
            try
            {
                if( this._rowIndex &lt; 0 )
                {
                    return;
                }

                var index = this.GetCurrentRowIndex( e.GetPosition );

                if( index &lt; 0 || index == this._rowIndex || index &gt;= this._list.Count )
                {
                    return;
                }

                var changed = this._list[ this._rowIndex ];
                this._list.RemoveAt( this._rowIndex );
                this._list.Insert( index , changed );

                this.dataGrid1.Items.Refresh();

                this._updatingFromEditor = false;

                this.UpdateDsl();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DataGridPreviewMouseLeftButtonDown( object sender , MouseButtonEventArgs e )
        {
            try
            {
                if( Keyboard.Modifiers != ModifierKeys.Shift )
                {
                    return;
                }

                this.dataGrid1.CommitEdit( DataGridEditingUnit.Row , true );

                this._rowIndex = this.GetCurrentRowIndex( e.GetPosition );

                if( this._rowIndex &gt;= this._list.Count || this._rowIndex == -1 )
                {
                    return;
                }

                var row = ( DataGridRow ) this.dataGrid1.ItemContainerGenerator.ContainerFromIndex( this._rowIndex );
                if( row == null )
                {
                    // May be virtualized, bring into view and try again.
                    this.dataGrid1.UpdateLayout();
                    this.dataGrid1.ScrollIntoView( this.dataGrid1.Items[ this._rowIndex ] );
                    row = ( DataGridRow ) this.dataGrid1.ItemContainerGenerator.ContainerFromIndex( this._rowIndex );
                }

                Framework.DragDrop.StartDrag( row , e );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private bool GetMouseTargetRow( Visual theTarget , Position position )
        {
            var rect = VisualTreeHelper.GetDescendantBounds( theTarget );
            var point = position( ( IInputElement ) theTarget );
            return rect.Contains( point );
        }


        private DataGridRow GetRowItem( int index )
        {
            if( this.dataGrid1.ItemContainerGenerator.Status != GeneratorStatus.ContainersGenerated )
            {
                return null;
            }

            return this.dataGrid1.ItemContainerGenerator.ContainerFromIndex( index ) as DataGridRow;
        }


        private int GetCurrentRowIndex( Position pos )
        {
            var curIndex = -1;

            try
            {
                for( var i = 0; i &lt; this.dataGrid1.Items.Count; i++ )
                {
                    var itm = this.GetRowItem( i );
                    if( this.GetMouseTargetRow( itm , pos ) )
                    {
                        curIndex = i;
                        break;
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return curIndex;
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;policy&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;editor&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;handler&quot;&gt;&lt;/param&gt;
        public void SetPolicy( IPolicy policy , PolicyEditor editor , PolicyHandler handler )
        {
            try
            {
                this._policy = policy;
                this._policy.Attach( this );
                this._parent = editor;
                this._handler = handler;
                this.PrepareRows();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void PrepareRows()
        {
            try
            {
                this._list.Clear();
                this._ggw = Framework.Database.CreateGrammerGateway();

                var grammers = this._ggw.GetGrammer();
                var dslActionsStructureRegex = new Regex( &quot;#(\\s*)ACTION(\\s*):(.*?):(\\s*)END(\\s*)#&quot; , RegexOptions.Singleline );

                var structureMatch = dslActionsStructureRegex.Matches( this._handler.Document.Text );

                if( structureMatch.Count &lt;= 0 )
                {
                    return;
                }

                var structure = structureMatch[ 0 ].ToString();

                foreach( var grammer in grammers )
                {
                    var decodedrvalue = Framework.Utils.Base64Decode( grammer.GetValue() ).Replace( &quot;\\\\&quot; , &quot;\\&quot; );
                    var regstr = &quot;\\s*&quot; + grammer.GetKey() + &quot;\\s*:&quot; + decodedrvalue + &quot;\\s*&quot;;
                    var dslAction = new Regex( regstr , RegexOptions.IgnorePatternWhitespace | RegexOptions.Singleline );
                    var rvaluematches = dslAction.Matches( structure );
                    var lastpos = 0;

                    VisualPolicyEntry.AddKey( grammer.GetKey() );

                    foreach( Match matched in rvaluematches )
                    {
                        var sparams = new List&lt; string &gt;();
                        var colcount = 0;

                        foreach( Group group in matched.Groups )
                        {
                            var entry = group.ToString().Trim();

                            if( entry.CompareTo( &quot;&quot; ) == 0 )
                            {
                                continue;
                            }

                            if( group.Index == lastpos )
                            {
                                continue;
                            }

                            if( matched.ToString().Trim().CompareTo( entry ) == 0 )
                            {
                                continue;
                            }

                            sparams.Add( &quot;&quot; );

                            if( group.Captures.Count &gt; 1 )
                            {
                                foreach( var capture in group.Captures )
                                {
                                    sparams[ colcount ] += capture;
                                }
                            }
                            else
                            {
                                sparams[ colcount ] = entry;
                            }

                            lastpos = group.Index;
                            colcount++;

                            if( colcount &lt;= this._colCount )
                            {
                                continue;
                            }

                            this._colCount = colcount;
                        }

                        var vpentry = new VisualPolicyEntry( false , grammer.GetKey() , sparams.ToArray() );
                        vpentry.SetValidationRule( regstr );
                        this._list.Add( vpentry );
                    }
                }

                this.dataGrid1.ItemsSource = this._list;

                foreach( var column in this.dataGrid1.Columns )
                {
                    try
                    {
                        var dataGridComboBox = column as DataGridComboBoxColumn;
                        if( dataGridComboBox != null )
                        {
                            dataGridComboBox.ItemsSource = VisualPolicyEntry.Keys.ToArray();
                        }
                    }
                    catch( Exception )
                    {
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DataGridLoadingRow( object sender , DataGridRowEventArgs e )
        {
            e.Row.Header = ( e.Row.GetIndex() + 1 ).ToString();
        }


        private bool IsValid()
        {
            var valid = true;

            try
            {
                var i = 0;
                var end = this._list.Count;

                while( i &lt; end )
                {
                    var item = this._list[ i ];
                    if( item.Validate() == false )
                    {
                        valid = false;
                        break;
                    }
                    i++;
                }

                this._parent.DeleteRowButton.IsEnabled = valid;
                this._parent.AddRowButton.IsEnabled = valid;

                if( !valid )
                {
                    if( !this._addingNewEntry )
                    {
                        Framework.Notification.Display( Properties.Resources.FixError , 3000 );
                    }
                }
                else
                {
                    this.UpdateDsl();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }

            return valid;
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void AddRow()
        {
            try
            {
                if( !this.IsValid() )
                {
                    return;
                }

                RowValidationRule.Override = true;

                this.dataGrid1.CommitEdit( DataGridEditingUnit.Row , true );
                this.dataGrid1.SelectedItem = null;

                var vpentry = new VisualPolicyEntry();
                this._list.Add( vpentry );

                this._addedEntry = vpentry;
                this._addingNewEntry = true;
                this._selection = null;

                this.dataGrid1.Items.Refresh();

                this.dataGrid1.SelectedItem = vpentry;

                this.UpdateDsl();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;NotImplementedException&quot;&gt;&lt;/exception&gt;
        public void DeleteSelectedRows()
        {
            try
            {
                if( !this.IsValid() )
                {
                    return;
                }

                this.dataGrid1.CommitEdit( DataGridEditingUnit.Row , true );

                var i = 0;
                var end = this._list.Count;

                while( i &lt; end )
                {
                    var item = this._list[ i ];
                    if( item.IsSelected )
                    {
                        this._list.RemoveAt( i );
                        end = this._list.Count;
                        i--;
                    }
                    i++;
                }

                this.UpdateDsl();

                this.dataGrid1.Items.Refresh();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DataGrid1SelectionChanged( object sender , SelectionChangedEventArgs e )
        {
            try
            {
                if( this._selection == null )
                {
                    this._selection = this.dataGrid1.SelectedItem;
                }

                if( this._selection != this.dataGrid1.SelectedItem )
                {
                    if( this._addingNewEntry )
                    {
                        var entry = ( VisualPolicyEntry ) this._addedEntry;

                        if( string.IsNullOrEmpty( entry.EntryKey ) )
                        {
                            Framework.Notification.Display( Properties.Resources.RemovingBlank , 5000 );
                            this._list.Remove( entry );
                            this.dataGrid1.Items.Refresh();
                        }
                        else if( entry.Validate() == false )
                        {
                            Framework.Notification.Display( Properties.Resources.InvalidEntry , 5000 );
                            this._list.Remove( entry );
                            this.dataGrid1.Items.Refresh();
                        }

                        this._addingNewEntry = false;

                        RowValidationRule.Override = false;
                    }
                    else
                    {
                        var changed = false;
                        var i = 0;
                        var end = this._list.Count;

                        while( i &lt; end )
                        {
                            var item = this._list[ i ];
                            if( string.IsNullOrEmpty( item.EntryKey ) )
                            {
                                changed = true;
                                this._list.RemoveAt( i );
                                end = this._list.Count;
                                i--;
                            }
                            i++;
                        }

                        if( changed )
                        {
                            this.dataGrid1.Items.Refresh();

                            if( this._list.Contains( ( VisualPolicyEntry ) this._selection ) )
                            {
                                this.dataGrid1.SelectedItem = this._selection;
                            }
                        }

                        if( !this.IsValid() )
                        {
                            return;
                        }
                    }

                    this._selection = this.dataGrid1.SelectedItem;
                }

                this.IsValid();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void UpdateDsl()
        {
            try
            {
                if( this._updatingFromEditor )
                {
                    return;
                }

                var dsl = this._handler.Document.Text;
                var rules = new StringBuilder();

                rules.Append( &quot;\n&quot; );

                foreach( var visualPolicyEntry in this._list )
                {
                    rules.Append( &quot;    &quot; + visualPolicyEntry.EntryKey + &quot; : &quot; );

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue1 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue1 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue2 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue2 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue3 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue3 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue4 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue4 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue5 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue5 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue6 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue6 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue7 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue7 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue8 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue8 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue9 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue9 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue10 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue10 + &quot; &quot; );
                    }

                    if( !string.IsNullOrEmpty( visualPolicyEntry.Rvalue11 ) )
                    {
                        rules.Append( visualPolicyEntry.Rvalue11 + &quot; &quot; );
                    }

                    rules.Append( &quot; \n&quot; );
                }

                rules.Append( &quot;\n&quot; );

                var dslActionsStructureRegex = new Regex( &quot;#(\\s*)ACTION(\\s*):(.*?):(\\s*)END(\\s*)#&quot; , RegexOptions.Singleline );
                var matches = dslActionsStructureRegex.Matches( dsl );
                dsl = dsl.Replace( matches[ 0 ].ToString() , &quot;#ACTION:\n&quot; + rules + &quot;:END#&quot; );

                this._handler.Document.Text = dsl;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void DataGrid1CurrentCellChanged( object sender , EventArgs e )
        {
            try
            {
                if( Keyboard.Modifiers == ModifierKeys.Shift )
                {
                    return;
                }

                if( this.dataGrid1.CurrentColumn is DataGridCheckBoxColumn )
                {
                    this.dataGrid1.BeginEdit();
                }

                if( this.dataGrid1.CurrentColumn is DataGridComboBoxColumn )
                {
                    this.dataGrid1.BeginEdit();
                }

                if( this.dataGrid1.CurrentColumn is DataGridTextColumn )
                {
                    this.dataGrid1.BeginEdit();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void DataGrid1PreparingCellForEdit( object sender , DataGridPreparingCellForEditEventArgs e )
        {
            try
            {
                var checkBox = e.EditingElement as CheckBox;
                if( checkBox != null )
                {
                    checkBox.IsChecked = !checkBox.IsChecked;
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void DataGrid1CellEditEnding( object sender , DataGridCellEditEndingEventArgs e )
        {
            try
            {
                this._updatingFromEditor = false;
                this.UpdateDsl();

                var comboBox = e.EditingElement as ComboBox;
                if( comboBox != null )
                {
                    var row = ( VisualPolicyEntry ) this.dataGrid1.SelectedItem;
                    if( comboBox.SelectedValue != null )
                    {
                        row.EntryKey = comboBox.SelectedValue.ToString();
                    }
                }

                var textBox = e.EditingElement as TextBox;
                var textBoxColumn = e.Column as DataGridTextColumn;
                if( textBox != null )
                {
                    var row = ( VisualPolicyEntry ) this.dataGrid1.SelectedItem;
                    if( textBoxColumn != null )
                    {
                        switch( textBoxColumn.DisplayIndex )
                        {
                            case 2 :
                                row.Rvalue1 = textBox.Text;
                                break;
                            case 3 :
                                row.Rvalue2 = textBox.Text;
                                break;
                            case 4 :
                                row.Rvalue3 = textBox.Text;
                                break;
                            case 5 :
                                row.Rvalue4 = textBox.Text;
                                break;
                            case 6 :
                                row.Rvalue5 = textBox.Text;
                                break;
                            case 7 :
                                row.Rvalue6 = textBox.Text;
                                break;
                            case 8 :
                                row.Rvalue7 = textBox.Text;
                                break;
                            case 9 :
                                row.Rvalue8 = textBox.Text;
                                break;
                            case 10 :
                                row.Rvalue9 = textBox.Text;
                                break;
                            case 11 :
                                row.Rvalue10 = textBox.Text;
                                break;
                            case 12 :
                                row.Rvalue11 = textBox.Text;
                                break;
                        }
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DataGrid1MouseLeave( object sender , MouseEventArgs e )
        {
            this._updatingFromEditor = true;
        }

        #region Implementation of IPolicyObserver

        /// &lt;summary&gt;
        ///   Update this observer with a refernece to the ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;policy&quot;&gt;IPolicy&lt;/param&gt;
        /// &lt;param name = &quot;source&quot;&gt;source observer&lt;/param&gt;
        public void Update( IPolicy policy , IPolicyObserver source )
        {
            try
            {
                if( source == this )
                {
                    return;
                }

                this._policy = policy;
                this.PrepareRows();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Attach objects that observer this IPolicy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IPolicyObserver&lt;/param&gt;
        public void Attach( IPolicyObserver obj )
        {
            if( obj == this )
            {
                return;
            }
        }

        /// &lt;summary&gt;
        ///   Detach objects that observer this IPolicy
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IPolicyObserver&lt;/param&gt;
        public void Detach( IPolicyObserver obj )
        {
            try
            {
                this._policy.Detach( this );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Notify observers of this IPolicy
        /// &lt;/summary&gt;
        public void Notify()
        {
        }

        /// &lt;summary&gt;
        ///   Dispose this object and all the observers
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IPolicyObserver&lt;/param&gt;
        public void Dispose( IPolicyObserver obj )
        {
            if( obj == this )
            {
                return;
            }
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src313', RANGES_313)
		</script>
	</body>
</html>