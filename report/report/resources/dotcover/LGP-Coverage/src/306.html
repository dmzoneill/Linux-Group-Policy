<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_306 = [
   [33,9,33,10,'dccv']
, [34,13,34,53,'dccv']
, [35,9,35,10,'dccv']
, [38,9,38,50,'dccv']
, [39,9,39,10,'dccv']
, [41,13,41,14,'dccv']
, [42,17,42,35,'dccv']
, [43,17,43,41,'dccv']
, [44,17,44,41,'dccv']
, [45,17,45,39,'dccv']
, [47,17,47,64,'dccv']
, [48,17,48,87,'dccv']
, [50,17,50,40,'dccv']
, [51,17,51,69,'dccv']
, [53,17,53,63,'dccv']
, [55,17,58,19,'dccv']
, [60,17,60,57,'dccv']
, [61,17,61,58,'dccv']
, [62,17,62,61,'dccv']
, [64,17,64,43,'dccv']
, [66,17,66,33,'dccv']
, [67,13,67,14,'dccv']
, [72,9,72,10,'dccv']
, [75,9,75,59,'dccv']
, [76,9,76,10,'dccv']
, [78,13,78,14,'dccv']
, [79,17,79,42,'dccv']
, [80,17,80,41,'dccv']
, [81,17,81,39,'dccv']
, [83,17,83,33,'dccv']
, [84,17,84,31,'dccv']
, [85,17,85,32,'dccv']
, [86,13,86,14,'dccv']
, [91,9,91,10,'dccv']
, [94,9,94,80,'dccv']
, [95,9,95,10,'dccv']
, [97,13,97,14,'dccv']
, [98,17,98,35,'dccv']
, [99,17,99,35,'dccv']
, [101,17,101,32,'dccv']
, [103,17,103,42,'dccv']
, [104,17,104,41,'dccv']
, [105,17,105,39,'dccv']
, [107,17,107,33,'dccv']
, [108,17,108,31,'dccv']
, [109,17,109,32,'dccv']
, [111,17,111,182,'dccv']
, [113,17,113,52,'dccv']
, [114,17,114,35,'dccv']
, [115,17,115,18,'dccv']
, [116,21,116,61,'dccv']
, [117,21,117,59,'dccv']
, [118,21,118,94,'dccv']
, [120,21,120,57,'dccv']
, [121,21,121,62,'dccv']
, [122,21,122,107,'dccv']
, [124,21,124,57,'dccv']
, [125,21,125,60,'dccv']
, [126,21,126,97,'dccv']
, [128,21,128,57,'dccv']
, [129,21,129,62,'dccv']
, [130,21,130,101,'dccv']
, [132,21,132,45,'dccv']
, [133,21,133,76,'dccv']
, [134,17,134,18,'dccv']
, [135,13,135,14,'dccv']
, [140,9,140,10,'dccv']
, [150,9,150,10,'dccv']
, [152,13,152,14,'dccv']
, [153,17,153,57,'dccv']
, [158,17,158,31,'dccv']
, [159,17,159,32,'dccv']
, [160,17,160,40,'dccv']
, [161,17,161,40,'dccv']
, [164,17,164,29,'dccv']
, [165,13,165,14,'dccv']
, [170,9,170,10,'dccv']
, [216,9,216,10,'dccv']
, [217,13,217,35,'dccv']
, [222,13,222,14,'dccv']
, [223,17,223,38,'dccv']
, [224,17,224,35,'dccv']
, [225,17,225,64,'dccv']
, [226,17,226,45,'dccv']
, [227,13,227,14,'dccv']
, [232,9,232,10,'dccv']
, [237,9,237,10,'dccv']
, [238,13,238,56,'dccv']
, [239,13,239,14,'dccv']
, [240,17,240,24,'dccv']
, [243,13,243,41,'dccv']
, [244,13,244,113,'dccv']
, [245,9,245,10,'dccv']
, [248,9,248,10,'dccv']
, [249,13,249,35,'dccv']
, [254,13,254,14,'dccv']
, [255,17,255,64,'dccv']
, [256,17,256,47,'dccv']
, [258,17,258,39,'dccv']
, [259,17,259,18,'dccv']
, [260,21,260,73,'dccv']
, [272,21,272,28,'dccv']
, [275,17,275,75,'dccv']
, [276,17,276,18,'dccv']
, [277,21,277,73,'dccv']
, [278,21,278,22,'dccv']
, [279,25,279,53,'dccv']
, [280,25,280,97,'dccv']
, [281,25,281,32,'dccv']
, [284,21,284,28,'dccv']
, [284,41,284,46,'dccv']
, [284,30,284,37,'dccv']
, [285,21,285,22,'dccv']
, [286,25,286,80,'dccv']
, [287,25,287,26,'dccv']
, [288,29,288,57,'dccv']
, [289,29,289,51,'dccv']
, [290,25,290,26,'dccv']
, [291,21,291,22,'dccv']
, [284,38,284,40,'dccv']
, [292,17,292,18,'dccv']
, [293,13,293,14,'dccv']
, [298,9,298,10,'dccv']
, [302,9,302,10,'dccv']
, [303,13,303,35,'dccv']
, [308,13,308,14,'dccv']
, [309,17,309,64,'dccv']
, [310,17,310,57,'dccv']
, [311,17,311,40,'dccv']
, [312,17,312,60,'dccv']
, [313,17,313,63,'dccv']
, [314,17,317,19,'dccv']
, [319,17,319,57,'dccv']
, [320,17,320,58,'dccv']
, [321,17,321,61,'dccv']
, [323,17,323,43,'dccv']
, [324,13,324,14,'dccv']
, [329,9,329,10,'dccv']
, [333,9,333,10,'dccv']
, [334,13,334,35,'dccv']
, [335,13,335,14,'dccv']
, [336,17,336,29,'dccv']
, [338,13,338,29,'dccv']
, [339,9,339,10,'dccv']
, [357,9,357,10,'dccv']
, [358,13,358,46,'dccv']
, [360,13,360,56,'dccv']
, [361,13,361,14,'dccv']
, [362,17,362,24,'dccv']
, [365,13,365,36,'dccv']
, [366,9,366,10,'dccv']
, [374,9,374,10,'dccv']
, [375,13,375,53,'dccv']
, [377,13,377,84,'dccv']
, [378,13,378,14,'dccv']
, [379,17,379,40,'dccv']
, [380,13,380,14,'dccv']
, [381,9,381,10,'dccv']
, [389,9,389,10,'dccv']
, [390,13,390,42,'dccv']
, [393,13,393,14,'dccv']
, [394,17,394,39,'dccv']
, [395,17,395,18,'dccv']
, [396,21,396,28,'dccv']
, [399,17,399,60,'dccv']
, [400,17,400,18,'dccv']
, [401,21,401,28,'dccv']
, [405,17,405,18,'dccv']
, [406,21,406,61,'dccv']
, [407,21,407,83,'dccv']
, [408,17,408,18,'dccv']
, [413,13,413,14,'dccv']
, [418,9,418,10,'dccv']
, [422,9,422,10,'dccv']
, [423,13,423,56,'dccv']
, [428,13,428,14,'dccv']
, [429,17,429,46,'dccv']
, [430,17,430,87,'dccv']
, [431,17,431,39,'dccv']
, [432,17,432,38,'dccv']
, [433,13,433,14,'dccv']
, [438,9,438,10,'dccv']
, [442,9,442,10,'dccv']
, [443,13,443,56,'dccv']
, [448,13,448,14,'dccv']
, [449,17,449,46,'dccv']
, [450,17,450,95,'dccv']
, [451,17,451,39,'dccv']
, [452,17,452,38,'dccv']
, [453,13,453,14,'dccv']
, [458,9,458,10,'dccv']
, [462,9,462,10,'dccv']
, [463,13,463,56,'dccv']
, [468,13,468,14,'dccv']
, [469,17,469,46,'dccv']
, [470,17,470,87,'dccv']
, [471,17,471,39,'dccv']
, [472,17,472,38,'dccv']
, [473,13,473,14,'dccv']
, [478,9,478,10,'dccv']
, [482,9,482,10,'dccv']
, [483,13,483,56,'dccv']
, [488,13,488,14,'dccv']
, [489,17,489,46,'dccv']
, [490,17,490,85,'dccv']
, [491,17,491,39,'dccv']
, [492,17,492,38,'dccv']
, [493,13,493,14,'dccv']
, [498,9,498,10,'dccv']
, [502,9,502,10,'dccv']
, [504,13,504,14,'dccv']
, [505,17,505,51,'dccv']
, [506,17,506,76,'dccv']
, [507,13,507,14,'dccv']
, [512,9,512,10,'dccv']
, [516,9,516,10,'dccv']
, [518,13,518,14,'dccv']
, [519,17,519,121,'dccv']
, [521,17,521,24,'dccv']
, [521,37,521,42,'dccv']
, [521,26,521,33,'dccv']
, [522,17,522,18,'dccv']
, [523,21,523,78,'dccv']
, [524,21,524,22,'dccv']
, [525,25,525,49,'dccv']
, [526,21,526,22,'dccv']
, [527,17,527,18,'dccv']
, [521,34,521,36,'dccv']
, [528,13,528,14,'dccv']
, [533,9,533,10,'dccv']
, [541,9,541,10,'dccv']
, [542,13,542,45,'dccv']
, [545,13,545,14,'dccv']
, [546,17,546,60,'dccv']
, [547,17,547,18,'dccv']
, [548,21,548,28,'dccv']
, [551,17,551,63,'dccv']
, [552,17,552,18,'dccv']
, [553,21,553,62,'dccv']
, [554,17,554,18,'dccv']
, [555,13,555,14,'dccv']
, [560,9,560,10,'dccv']
, [564,9,564,10,'dccv']
, [565,13,565,72,'dccv']
, [567,13,567,40,'dccv']
, [572,13,572,48,'dccv']
, [573,13,573,14,'dccv']
, [574,17,574,30,'dccv']
, [577,13,577,147,'dccv']
, [578,9,578,10,'dccv']
, [586,9,586,10,'dccv']
, [587,13,587,30,'dccv']
, [589,13,589,14,'dccv']
, [590,17,590,72,'dccv']
, [591,17,591,18,'dccv']
, [592,21,592,100,'dccv']
, [593,21,593,39,'dccv']
, [594,21,594,22,'dccv']
, [595,25,595,47,'dccv']
, [596,25,596,26,'dccv']
, [597,29,597,82,'dccv']
, [598,29,598,36,'dccv']
, [601,25,601,143,'dccv']
, [602,25,602,26,'dccv']
, [603,29,603,36,'dccv']
, [606,25,606,74,'dccv']
, [607,25,607,43,'dccv']
, [608,21,608,22,'dccv']
, [610,21,610,102,'dccv']
, [611,21,611,39,'dccv']
, [629,21,629,110,'dccv']
, [630,21,630,39,'dccv']
, [631,21,631,22,'dccv']
, [632,25,632,72,'dccv']
, [633,25,633,43,'dccv']
, [634,25,634,39,'dccv']
, [635,21,635,22,'dccv']
, [636,17,636,18,'dccv']
, [637,13,637,14,'dccv']
, [642,9,642,10,'dccv']
, [662,9,662,10,'dccv']
, [663,13,663,35,'dccv']
, [665,13,665,88,'dccv']
, [666,13,666,14,'dccv']
, [667,17,667,24,'dccv']
, [669,13,669,36,'dccv']
, [670,9,670,10,'dccv']
, [674,9,674,10,'dccv']
, [675,13,675,37,'dccv']
, [678,13,678,14,'dccv']
, [679,17,679,58,'dccv']
, [680,17,680,37,'dccv']
, [681,13,681,14,'dccv']
, [677,13,677,28,'dccv']
, [682,9,682,10,'dccv']
, [686,9,686,10,'dccv']
, [687,13,687,36,'dccv']
, [692,13,692,60,'dccv']
, [693,13,693,65,'dccv']
, [694,13,694,59,'dccv']
, [695,13,695,57,'dccv']
, [696,9,696,10,'dccv']
, [700,9,700,10,'dccv']
, [701,13,701,36,'dccv']
, [702,9,702,10,'dccv']
, [68,13,68,37,'dcuc']
, [69,13,69,14,'dcuc']
, [70,17,70,53,'dcuc']
, [71,13,71,14,'dcuc']
, [87,13,87,37,'dcuc']
, [88,13,88,14,'dcuc']
, [89,17,89,53,'dcuc']
, [90,13,90,14,'dcuc']
, [136,13,136,37,'dcuc']
, [137,13,137,14,'dcuc']
, [138,17,138,53,'dcuc']
, [139,13,139,14,'dcuc']
, [154,17,154,18,'dcuc']
, [155,21,155,28,'dcuc']
, [166,13,166,37,'dcuc']
, [167,13,167,14,'dcuc']
, [168,17,168,53,'dcuc']
, [169,13,169,14,'dcuc']
, [178,9,178,10,'dcuc']
, [179,13,179,35,'dcuc']
, [180,13,180,14,'dcuc']
, [181,17,181,24,'dcuc']
, [183,9,183,10,'dcuc']
, [191,9,191,10,'dcuc']
, [192,13,192,35,'dcuc']
, [193,13,193,14,'dcuc']
, [194,17,194,24,'dcuc']
, [196,9,196,10,'dcuc']
, [203,9,203,10,'dcuc']
, [204,13,204,35,'dcuc']
, [205,13,205,14,'dcuc']
, [206,17,206,24,'dcuc']
, [208,9,208,10,'dcuc']
, [218,13,218,14,'dcuc']
, [219,17,219,24,'dcuc']
, [228,13,228,37,'dcuc']
, [229,13,229,14,'dcuc']
, [230,17,230,53,'dcuc']
, [231,13,231,14,'dcuc']
, [250,13,250,14,'dcuc']
, [251,17,251,24,'dcuc']
, [261,21,261,22,'dcuc']
, [262,25,262,32,'dcuc']
, [262,45,262,50,'dcuc']
, [262,34,262,41,'dcuc']
, [263,25,263,26,'dcuc']
, [264,29,264,84,'dcuc']
, [265,29,265,30,'dcuc']
, [266,33,266,61,'dcuc']
, [267,33,267,55,'dcuc']
, [268,29,268,30,'dcuc']
, [269,25,269,26,'dcuc']
, [262,42,262,44,'dcuc']
, [270,21,270,22,'dcuc']
, [294,13,294,37,'dcuc']
, [295,13,295,14,'dcuc']
, [296,17,296,53,'dcuc']
, [297,13,297,14,'dcuc']
, [304,13,304,14,'dcuc']
, [305,17,305,24,'dcuc']
, [325,13,325,37,'dcuc']
, [326,13,326,14,'dcuc']
, [327,17,327,53,'dcuc']
, [328,13,328,14,'dcuc']
, [343,9,343,10,'dcuc']
, [344,13,344,35,'dcuc']
, [345,13,345,14,'dcuc']
, [346,17,346,24,'dcuc']
, [348,13,348,28,'dcuc']
, [349,9,349,10,'dcuc']
, [409,17,409,41,'dcuc']
, [410,17,410,18,'dcuc']
, [411,21,411,57,'dcuc']
, [412,17,412,18,'dcuc']
, [414,13,414,37,'dcuc']
, [415,13,415,14,'dcuc']
, [416,17,416,53,'dcuc']
, [417,13,417,14,'dcuc']
, [424,13,424,14,'dcuc']
, [425,17,425,24,'dcuc']
, [434,13,434,37,'dcuc']
, [435,13,435,14,'dcuc']
, [436,17,436,53,'dcuc']
, [437,13,437,14,'dcuc']
, [444,13,444,14,'dcuc']
, [445,17,445,24,'dcuc']
, [454,13,454,37,'dcuc']
, [455,13,455,14,'dcuc']
, [456,17,456,53,'dcuc']
, [457,13,457,14,'dcuc']
, [464,13,464,14,'dcuc']
, [465,17,465,24,'dcuc']
, [474,13,474,37,'dcuc']
, [475,13,475,14,'dcuc']
, [476,17,476,53,'dcuc']
, [477,13,477,14,'dcuc']
, [484,13,484,14,'dcuc']
, [485,17,485,24,'dcuc']
, [494,13,494,37,'dcuc']
, [495,13,495,14,'dcuc']
, [496,17,496,53,'dcuc']
, [497,13,497,14,'dcuc']
, [508,13,508,37,'dcuc']
, [509,13,509,14,'dcuc']
, [510,17,510,53,'dcuc']
, [511,13,511,14,'dcuc']
, [529,13,529,37,'dcuc']
, [530,13,530,14,'dcuc']
, [531,17,531,53,'dcuc']
, [532,13,532,14,'dcuc']
, [556,13,556,37,'dcuc']
, [557,13,557,14,'dcuc']
, [558,17,558,53,'dcuc']
, [559,13,559,14,'dcuc']
, [568,13,568,14,'dcuc']
, [569,17,569,30,'dcuc']
, [612,21,612,22,'dcuc']
, [613,25,613,47,'dcuc']
, [614,25,614,26,'dcuc']
, [615,29,615,82,'dcuc']
, [616,29,616,36,'dcuc']
, [619,25,619,143,'dcuc']
, [620,25,620,26,'dcuc']
, [621,29,621,36,'dcuc']
, [624,25,624,74,'dcuc']
, [625,25,625,43,'dcuc']
, [626,25,626,39,'dcuc']
, [627,21,627,22,'dcuc']
, [638,13,638,37,'dcuc']
, [639,13,639,14,'dcuc']
, [640,17,640,53,'dcuc']
, [641,13,641,14,'dcuc']
, [650,9,650,10,'dcuc']
, [651,13,651,38,'dcuc']
, [652,13,652,41,'dcuc']
, [653,13,653,30,'dcuc']
, [654,9,654,10,'dcuc']
, [688,13,688,14,'dcuc']
, [689,17,689,24,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src306" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.Reflection;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Input;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;
using LGP.Modules.OrganizationUnitExplorer.Internal.Modals.Controls;

#endregion

namespace LGP.Modules.OrganizationUnitExplorer.Internal.CustomControls
{
    internal class TreeViewOuElement : TreeViewItem , IOuObserver
    {
        private static TreeViewOuElement RootNode;
        private static TreeView _parent;
        private static readonly List&lt; TreeViewOuElement &gt; Nodes;
        private readonly bool _isRootNode;
        private readonly TreeView _parentTree;
        private Image _image;
        private IOu _ou;
        private StackPanel _panel;
        private TextBlock _spacer;
        private Run _text;
        private TextBlock _textBlock;

        static TreeViewOuElement()
        {
            Nodes = new List&lt; TreeViewOuElement &gt;();
        }


        public TreeViewOuElement( TreeView tree )
        {
            try
            {
                this.Tag = &quot;root&quot;;
                this._isRootNode = true;
                this._parentTree = tree;
                this.AllowDrop = true;

                this._spacer = new TextBlock( new Run( &quot; &quot; ) );
                this._image = Framework.Images.GetImage( &quot;workgroup&quot; , &quot;distros/32&quot; );

                this._image.Width = 14;
                this._text = new Run( Properties.Resources.Domain );

                this._textBlock = new TextBlock( this._text );

                this._panel = new StackPanel
                {
                    Orientation = Orientation.Horizontal , Margin = new Thickness( 2 )
                };

                this._panel.Children.Add( this._image );
                this._panel.Children.Add( this._spacer );
                this._panel.Children.Add( this._textBlock );

                this.Header = this._panel;

                RootNode = this;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public TreeViewOuElement( IOu ou , TreeView tree )
        {
            try
            {
                this._isRootNode = false;
                this._parentTree = tree;
                this.AllowDrop = true;

                this.Tag = &quot;Ou&quot;;
                this._ou = ou;
                this.Prepare();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public TreeViewOuElement( IOu ou , TreeView tree , bool enableActions )
        {
            try
            {
                Nodes.Add( this );
                ou.Attach( this );

                _parent = tree;

                this._isRootNode = false;
                this._parentTree = tree;
                this.AllowDrop = true;

                this.Tag = &quot;Ou&quot;;
                this._ou = ou;
                this.Prepare();

                var resource = Framework.Utils.LoadResource( Assembly.GetExecutingAssembly() , &quot;LGP.Modules.OrganizationUnitExplorer.Internal.ContextMenuItems.OuContextMenu.xaml&quot; );

                var menu = resource as ContextMenu;
                if( menu != null )
                {
                    var item = ( MenuItem ) menu.Items[ 0 ];
                    item.Click += this.AddOuMenuItemClick;
                    item.Icon = Framework.Images.GetImage( &quot;workgroup&quot; , &quot;distros/32&quot; , 12 );

                    item = ( MenuItem ) menu.Items[ 1 ];
                    item.Click += this.RenameOuMenuItemClick;
                    item.Icon = Framework.Images.GetImage( &quot;RenameFolderHS&quot; , &quot;VS2010ImageLibrary&quot; , 12 );

                    item = ( MenuItem ) menu.Items[ 2 ];
                    item.Click += this.MoveOuMenuItemClick;
                    item.Icon = Framework.Images.GetImage( &quot;Move&quot; , &quot;VS2010ImageLibrary&quot; , 12 );

                    item = ( MenuItem ) menu.Items[ 3 ];
                    item.Click += this.DeleteOuMenuItemClick;
                    item.Icon = Framework.Images.GetImage( &quot;DeleteHS&quot; , &quot;VS2010ImageLibrary&quot; , 12 );

                    this.ContextMenu = menu;
                    this.ContextMenuOpening += this.MenuContextMenuOpening;
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #region IOuObserver Members

        /// &lt;summary&gt;
        ///   Update this observer with a refernece to the ou
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;Iou&lt;/param&gt;
        /// &lt;param name = &quot;source&quot;&gt;source observer&lt;/param&gt;
        public void Update( IOu ou , IOuObserver source )
        {
            try
            {
                if( this == source || this._isRootNode )
                {
                    return;
                }

                this._ou = ou;
                this.Prepare();
                this.IsSelected = true;
                this.IsExpanded = true;

                // moved
                this.Move();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Attach objewcts that observer this IOu
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IOuObserver&lt;/param&gt;
        public void Attach( IOuObserver obj )
        {
            if( this._isRootNode )
            {
                return;
            }
        }


        /// &lt;summary&gt;
        ///   Detach objewcts that observer this IOu
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IOuObserver&lt;/param&gt;
        public void Detach( IOuObserver obj )
        {
            if( this._isRootNode )
            {
                return;
            }
        }


        /// &lt;summary&gt;
        ///   Notify observers of this IOu
        /// &lt;/summary&gt;
        public void Notify()
        {
            if( this._isRootNode )
            {
                return;
            }
        }


        /// &lt;summary&gt;
        ///   Dispose this object and all the observers
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;ou&quot;&gt;IOuObserver&lt;/param&gt;
        public void Dispose( IOuObserver ou )
        {
            if( this._isRootNode )
            {
                return;
            }
            try
            {
                Nodes.Remove( this );
                ou.Detach( this );
                var parent = ( TreeViewOuElement ) this.Parent;
                parent.Items.Remove( this );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion

        private void MenuContextMenuOpening( object sender , ContextMenuEventArgs e )
        {
            if( this != this._parentTree.SelectedItem )
            {
                return;
            }

            var menu = this.ContextMenu;
            Framework.ContextMenus.AttachMenuItemRegistrations( ref menu , typeof( IOu ) , this.MenuItemClick );
        }

        private void Move()
        {
            if( this._isRootNode )
            {
                return;
            }
            try
            {
                var parent = ( TreeViewOuElement ) this.Parent;
                var parentOu = parent.GetOu();

                if( parentOu == null )
                {
                    if( this._ou.GetOuId() != this._ou.GetParentOuId() )
                    {
                        foreach( var ele in Nodes )
                        {
                            if( ele.GetOu().GetOuId() == this._ou.GetParentOuId() )
                            {
                                parent.Items.Remove( this );
                                ele.Items.Add( this );
                            }
                        }
                    }

                    return;
                }

                if( this._ou.GetParentOuId() != parent.GetOu().GetOuId() )
                {
                    if( this._ou.GetParentOuId() == this._ou.GetOuId() )
                    {
                        parent.Items.Remove( this );
                        ( ( TreeViewOuElement ) this._parentTree.Items[ 0 ] ).Items.Add( this );
                        return;
                    }

                    foreach( var ele in Nodes )
                    {
                        if( ele.GetOu().GetOuId() == this._ou.GetParentOuId() )
                        {
                            parent.Items.Remove( this );
                            ele.Items.Add( this );
                        }
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void Prepare()
        {
            if( this._isRootNode )
            {
                return;
            }
            try
            {
                this._spacer = new TextBlock( new Run( &quot; &quot; ) );
                this._image = this._ou.GetOuImage( 16 );
                this._image.Width = 14;
                this._text = new Run( this._ou.GetName() );
                this._textBlock = new TextBlock( this._text );
                this._panel = new StackPanel
                {
                    Orientation = Orientation.Horizontal , Margin = new Thickness( 2 )
                };

                this._panel.Children.Add( this._image );
                this._panel.Children.Add( this._spacer );
                this._panel.Children.Add( this._textBlock );

                this.Header = this._panel;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public IOu GetOu()
        {
            if( this._isRootNode )
            {
                return null;
            }
            return this._ou;
        }


        public void Redraw()
        {
            if( this._isRootNode )
            {
                return;
            }
            this.Prepare();
        }


        /// &lt;summary&gt;
        ///   Invoked when an unhandled &lt;see cref = &quot;E:System.Windows.UIElement.MouseRightButtonDown&quot; /&gt;&nbsp;routed event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;e&quot;&gt;The &lt;see cref = &quot;T:System.Windows.Input.MouseButtonEventArgs&quot; /&gt; that contains the event data. The event data reports that the right mouse button was pressed.&lt;/param&gt;
        protected override void OnMouseRightButtonDown( MouseButtonEventArgs e )
        {
            base.OnMouseRightButtonDown( e );

            if( this != this._parentTree.SelectedItem )
            {
                return;
            }

            this.IsSelected = true;
        }


        /// &lt;summary&gt;
        ///   Invoked when an unhandled &lt;see cref = &quot;E:System.Windows.UIElement.PreviewMouseRightButtonDown&quot; /&gt;&nbsp;routed event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;e&quot;&gt;The &lt;see cref = &quot;T:System.Windows.Input.MouseButtonEventArgs&quot; /&gt; that contains the event data. The event data reports that the right mouse button was pressed.&lt;/param&gt;
        protected override void OnPreviewMouseRightButtonDown( MouseButtonEventArgs e )
        {
            base.OnPreviewMouseRightButtonDown( e );

            if( this._text == e.OriginalSource || this._image == e.OriginalSource )
            {
                this.IsSelected = true;
            }
        }


        /// &lt;summary&gt;
        ///   Raises the &lt;see cref = &quot;E:System.Windows.Controls.Control.MouseDoubleClick&quot; /&gt; routed event.
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;e&quot;&gt;The event data.&lt;/param&gt;
        protected override void OnMouseDoubleClick( MouseButtonEventArgs e )
        {
            base.OnMouseDoubleClick( e );

            try
            {
                if( this._isRootNode )
                {
                    return;
                }

                if( this != this._parentTree.SelectedItem )
                {
                    return;
                }

                try
                {
                    var ouViewer = new OuViewer( this._ou );
                    Framework.Panels.AddMainComponent( ouViewer , ouViewer.Name );
                }
                catch( Exception error )
                {
                    Framework.EventBus.Publish( error );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void AddOuMenuItemClick( object sender , RoutedEventArgs e )
        {
            if( this != this._parentTree.SelectedItem )
            {
                return;
            }
            try
            {
                var popup = Framework.Dialog;
                var cou = new CreateOu( OuTreeView.GetInstance() , this._ou , popup );
                popup.SetChild( cou );
                popup.ShowBlocking();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DeleteOuMenuItemClick( object sender , RoutedEventArgs e )
        {
            if( this != this._parentTree.SelectedItem )
            {
                return;
            }
            try
            {
                var popup = Framework.Dialog;
                var cou = new DeleteOu( OuTreeView.GetInstance() , this._ou , popup , false );
                popup.SetChild( cou );
                popup.ShowBlocking();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void RenameOuMenuItemClick( object sender , RoutedEventArgs e )
        {
            if( this != this._parentTree.SelectedItem )
            {
                return;
            }
            try
            {
                var popup = Framework.Dialog;
                var cou = new RenameOu( OuTreeView.GetInstance() , this._ou , popup );
                popup.SetChild( cou );
                popup.ShowBlocking();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void MoveOuMenuItemClick( object sender , RoutedEventArgs e )
        {
            if( this != this._parentTree.SelectedItem )
            {
                return;
            }
            try
            {
                var popup = Framework.Dialog;
                var cou = new MoveOu( OuTreeView.GetInstance() , this._ou , popup );
                popup.SetChild( cou );
                popup.ShowBlocking();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void MenuItemClick( object sender , RoutedEventArgs e )
        {
            try
            {
                var menuitem = sender as MenuItem;
                Framework.ContextMenus.CallBack( menuitem , this.GetOu() );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        public static void CreateEntry( IOu ou )
        {
            try
            {
                var newEle = new TreeViewOuElement( ou , ( ( OuTreeView ) OuTreeView.GetInstance() ).treeView1 , true );

                foreach( var ele in Nodes )
                {
                    if( ele.GetOu().GetOuId() == newEle._ou.GetParentOuId() )
                    {
                        ele.Items.Add( newEle );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// Invoked when an unhandled &lt;see cref=&quot;E:System.Windows.UIElement.PreviewMouseLeftButtonDown&quot;/&gt;&nbsp;routed event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;T:System.Windows.Input.MouseButtonEventArgs&quot;/&gt; that contains the event data. The event data reports that the left mouse button was pressed.&lt;/param&gt;
        protected override void OnMouseLeftButtonDown( MouseButtonEventArgs e )
        {
            base.OnMouseLeftButtonDown( e );

            try
            {
                if( this != this._parentTree.SelectedItem )
                {
                    return;
                }

                if( e.LeftButton == MouseButtonState.Pressed )
                {
                    Framework.DragDrop.StartDrag( this , e );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private bool CheckDropItemTargetIsNotLogicalChild( IOu dropitem , TreeViewOuElement targetitem )
        {
            var parentElement = targetitem.Parent as TreeViewOuElement;

            if( parentElement == null )
            {
                return false;
            }

            if( parentElement.GetOu() == null )
            {
                return false;
            }

            return dropitem.GetOuId() == parentElement.GetOu().GetOuId() || this.CheckDropItemTargetIsNotLogicalChild( dropitem , parentElement );
        }


        /// &lt;summary&gt;
        ///   Invoked when an unhandled &lt;see cref = &quot;E:System.Windows.DragDrop.DragEnter&quot; /&gt;&nbsp;attached event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;e&quot;&gt;The &lt;see cref = &quot;T:System.Windows.DragEventArgs&quot; /&gt; that contains the event data.&lt;/param&gt;
        protected override void OnDrop( DragEventArgs e )
        {
            base.OnDrop( e );
            try
            {
                if( e.Source == this._text || e.Source == this._image )
                {
                    var ele1 = ( TreeViewOuElement ) e.Data.GetData( typeof( TreeViewOuElement ) );
                    if( ele1 != null )
                    {
                        if( this._isRootNode )
                        {
                            ele1.GetOu().SetParentOuId( ele1.GetOu().GetOuId() );
                            return;
                        }

                        if( this._ou.GetOuId() == ele1.GetOu().GetOuId() || this.CheckDropItemTargetIsNotLogicalChild( ele1.GetOu() , this ) )
                        {
                            return;
                        }

                        ele1.GetOu().SetParentOuId( this._ou.GetOuId() );
                        this._ou.Notify();
                    }

                    var ele2 = ( WrapPanelOuElement ) e.Data.GetData( typeof( WrapPanelOuElement ) );
                    if( ele2 != null )
                    {
                        if( this._isRootNode )
                        {
                            ele2.GetOu().SetParentOuId( ele2.GetOu().GetOuId() );
                            return;
                        }

                        if( this._ou.GetOuId() == ele2.GetOu().GetOuId() || this.CheckDropItemTargetIsNotLogicalChild( ele2.GetOu() , this ) )
                        {
                            return;
                        }

                        ele2.GetOu().SetParentOuId( this._ou.GetOuId() );
                        this._ou.Notify();
                        ele2.Update();
                    }

                    var ele3 = ( WrapPanelClientElement ) e.Data.GetData( typeof( WrapPanelClientElement ) );
                    if( ele3 != null )
                    {
                        ele3.GetClient().Setouid( this._ou.GetOuId() );
                        this._ou.Notify();
                        ele3.Update();
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Invoked when an unhandled &lt;see cref = &quot;E:System.Windows.DragDrop.GiveFeedback&quot; /&gt;&nbsp;attached event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;e&quot;&gt;The &lt;see cref = &quot;T:System.Windows.GiveFeedbackEventArgs&quot; /&gt; that contains the event data.&lt;/param&gt;
        protected override void OnGiveFeedback( GiveFeedbackEventArgs e )
        {
            base.OnGiveFeedback( e );
            e.UseDefaultCursors = false;
            e.Handled = true;
        }


        /// &lt;summary&gt;
        ///   Invoked when an unhandled &lt;see cref = &quot;E:System.Windows.DragDrop.DragEnter&quot; /&gt;&nbsp;attached event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;e&quot;&gt;The &lt;see cref = &quot;T:System.Windows.DragEventArgs&quot; /&gt; that contains the event data.&lt;/param&gt;
        protected override void OnDragEnter( DragEventArgs e )
        {
            base.OnDragEnter( e );

            if( e.Source == this._text || e.Source == this._image || e.Source != this )
            {
                return;
            }
            this.IsExpanded = true;
        }


        public static void Dispose()
        {
            var i = Nodes.Count - 1;

            while( i &gt; -1 )
            {
                Nodes[ i ].Dispose( Nodes[ i ].GetOu() );
                i = Nodes.Count - 1;
            }
        }


        public void RefreshNode()
        {
            if( !this._isRootNode )
            {
                return;
            }

            this._panel.Children.Remove( this._textBlock );
            this._text = new Run( Properties.Resources.Domain );
            this._textBlock = new TextBlock( this._text );
            this._panel.Children.Add( this._textBlock );
        }


        public static void Refresh()
        {
            RootNode.RefreshNode();
        }
    }
}</pre></code><script type="text/javascript">
			applyranges('src306', RANGES_306)
		</script>
	</body>
</html>