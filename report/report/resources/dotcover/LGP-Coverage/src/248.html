<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_248 = [
   [30,9,30,10,'dccv']
, [31,13,31,68,'dccv']
, [32,13,32,70,'dccv']
, [33,9,33,10,'dccv']
, [40,9,40,72,'dccv']
, [41,9,41,10,'dccv']
, [43,13,43,14,'dccv']
, [44,17,44,65,'dccv']
, [45,17,45,51,'dccv']
, [46,17,46,47,'dccv']
, [47,17,47,71,'dccv']
, [48,17,48,43,'dccv']
, [50,17,50,95,'dccv']
, [52,17,52,56,'dccv']
, [53,17,53,18,'dccv']
, [54,21,54,96,'dccv']
, [55,17,55,18,'dccv']
, [57,17,57,110,'dccv']
, [58,13,58,14,'dccv']
, [63,9,63,10,'dccv']
, [88,9,88,10,'dccv']
, [90,13,90,14,'dccv']
, [91,17,91,37,'dccv']
, [92,17,92,71,'dccv']
, [93,17,93,43,'dccv']
, [94,17,94,45,'dccv']
, [95,17,95,29,'dccv']
, [96,17,96,38,'dccv']
, [97,17,97,31,'dccv']
, [98,13,98,14,'dccv']
, [103,9,103,10,'dccv']
, [106,9,106,10,'dccv']
, [108,13,108,14,'dccv']
, [109,17,109,73,'dccv']
, [110,17,110,60,'dccv']
, [112,17,112,35,'dccv']
, [113,17,113,18,'dccv']
, [114,21,114,72,'dccv']
, [115,17,115,18,'dccv']
, [117,17,117,44,'dccv']
, [118,13,118,14,'dccv']
, [123,9,123,10,'dccv']
, [126,9,126,10,'dccv']
, [128,13,128,14,'dccv']
, [129,17,129,56,'dccv']
, [131,17,131,37,'dccv']
, [132,17,132,18,'dccv']
, [133,21,133,38,'dccv']
, [134,21,134,82,'dccv']
, [135,21,135,41,'dccv']
, [136,17,136,18,'dccv']
, [137,13,137,14,'dccv']
, [142,9,142,10,'dccv']
, [146,9,146,10,'dccv']
, [148,13,148,14,'dccv']
, [149,17,149,71,'dccv']
, [150,17,150,52,'dccv']
, [151,17,151,38,'dccv']
, [155,13,155,14,'dccv']
, [160,9,160,10,'dccv']
, [178,9,178,10,'dccv']
, [180,13,180,14,'dccv']
, [181,17,181,55,'dccv']
, [182,17,182,18,'dccv']
, [183,21,183,48,'dccv']
, [184,17,184,18,'dccv']
, [185,13,185,14,'dccv']
, [190,9,190,10,'dccv']
, [197,9,197,10,'dccv']
, [199,13,199,14,'dccv']
, [200,17,200,47,'dccv']
, [201,13,201,14,'dccv']
, [206,9,206,10,'dccv']
, [212,9,212,10,'dccv']
, [214,13,214,14,'dccv']
, [215,22,215,32,'dccv']
, [216,17,216,18,'dccv']
, [217,21,217,64,'dccv']
, [218,17,218,18,'dccv']
, [215,60,215,63,'dccv']
, [215,33,215,58,'dccv']
, [219,13,219,14,'dccv']
, [224,9,224,10,'dccv']
, [231,9,231,10,'dccv']
, [233,13,233,14,'dccv']
, [234,17,234,51,'dccv']
, [236,17,236,18,'dccv']
, [237,21,237,58,'dccv']
, [238,21,238,51,'dccv']
, [239,17,239,18,'dccv']
, [235,17,235,32,'dccv']
, [240,17,240,40,'dccv']
, [241,13,241,14,'dccv']
, [246,9,246,10,'dccv']
, [319,9,319,10,'dccv']
, [321,13,321,14,'dccv']
, [322,17,322,54,'dccv']
, [323,17,323,24,'dccv']
, [323,46,323,82,'dccv']
, [323,26,323,42,'dccv']
, [324,17,324,18,'dccv']
, [325,21,325,60,'dccv']
, [326,21,326,22,'dccv']
, [327,25,327,53,'dccv']
, [328,21,328,22,'dccv']
, [329,17,329,18,'dccv']
, [323,43,323,45,'dccv']
, [330,17,330,32,'dccv']
, [337,9,337,10,'dccv']
, [365,13,365,14,'dccv']
, [366,17,366,43,'dccv']
, [367,13,367,14,'dccv']
, [369,13,369,14,'dccv']
, [371,17,371,18,'dccv']
, [372,21,372,48,'dccv']
, [373,21,373,68,'dccv']
, [374,21,374,40,'dccv']
, [375,21,375,35,'dccv']
, [376,21,376,65,'dccv']
, [377,17,377,18,'dccv']
, [382,13,382,14,'dccv']
, [391,9,391,10,'dccv']
, [392,13,392,37,'dccv']
, [393,9,393,10,'dccv']
, [401,9,401,10,'dccv']
, [403,13,403,14,'dccv']
, [404,17,404,74,'dccv']
, [405,17,405,48,'dccv']
, [406,17,406,99,'dccv']
, [407,13,407,14,'dccv']
, [412,9,412,10,'dccv']
, [419,9,419,10,'dccv']
, [420,13,420,39,'dccv']
, [421,9,421,10,'dccv']
, [427,9,427,10,'dccv']
, [428,13,428,39,'dccv']
, [429,9,429,10,'dccv']
, [59,13,59,37,'dcuc']
, [60,13,60,14,'dcuc']
, [61,17,61,53,'dcuc']
, [62,13,62,14,'dcuc']
, [71,9,71,10,'dcuc']
, [73,13,73,14,'dcuc']
, [74,17,74,47,'dcuc']
, [75,17,75,31,'dcuc']
, [76,13,76,14,'dcuc']
, [77,13,77,37,'dcuc']
, [78,13,78,14,'dcuc']
, [79,17,79,53,'dcuc']
, [80,13,80,14,'dcuc']
, [81,9,81,10,'dcuc']
, [99,13,99,37,'dcuc']
, [100,13,100,14,'dcuc']
, [101,17,101,53,'dcuc']
, [102,13,102,14,'dcuc']
, [119,13,119,37,'dcuc']
, [120,13,120,14,'dcuc']
, [121,17,121,53,'dcuc']
, [122,13,122,14,'dcuc']
, [138,13,138,37,'dcuc']
, [139,13,139,14,'dcuc']
, [140,17,140,53,'dcuc']
, [141,13,141,14,'dcuc']
, [152,17,152,18,'dcuc']
, [153,21,153,76,'dcuc']
, [154,17,154,18,'dcuc']
, [156,13,156,37,'dcuc']
, [157,13,157,14,'dcuc']
, [158,17,158,53,'dcuc']
, [159,13,159,14,'dcuc']
, [170,9,170,10,'dcuc']
, [171,9,171,10,'dcuc']
, [186,13,186,37,'dcuc']
, [187,13,187,14,'dcuc']
, [188,17,188,53,'dcuc']
, [189,13,189,14,'dcuc']
, [202,13,202,37,'dcuc']
, [203,13,203,14,'dcuc']
, [204,17,204,53,'dcuc']
, [205,13,205,14,'dcuc']
, [220,13,220,37,'dcuc']
, [221,13,221,14,'dcuc']
, [222,17,222,53,'dcuc']
, [223,13,223,14,'dcuc']
, [242,13,242,37,'dcuc']
, [243,13,243,14,'dcuc']
, [244,17,244,53,'dcuc']
, [245,13,245,14,'dcuc']
, [257,9,257,10,'dcuc']
, [258,13,258,60,'dcuc']
, [259,9,259,10,'dcuc']
, [267,9,267,10,'dcuc']
, [269,13,269,14,'dcuc']
, [270,17,270,89,'dcuc']
, [271,17,271,31,'dcuc']
, [272,17,272,32,'dcuc']
, [274,13,274,37,'dcuc']
, [275,13,275,14,'dcuc']
, [276,17,276,53,'dcuc']
, [277,17,277,29,'dcuc']
, [279,9,279,10,'dcuc']
, [286,9,286,10,'dcuc']
, [288,13,288,14,'dcuc']
, [289,17,289,59,'dcuc']
, [290,17,290,31,'dcuc']
, [291,13,291,14,'dcuc']
, [292,13,292,37,'dcuc']
, [293,13,293,14,'dcuc']
, [294,17,294,53,'dcuc']
, [295,13,295,14,'dcuc']
, [296,9,296,10,'dcuc']
, [302,9,302,10,'dcuc']
, [304,13,304,14,'dcuc']
, [305,17,305,57,'dcuc']
, [306,17,306,31,'dcuc']
, [307,13,307,14,'dcuc']
, [308,13,308,37,'dcuc']
, [309,13,309,14,'dcuc']
, [310,17,310,53,'dcuc']
, [311,13,311,14,'dcuc']
, [312,9,312,10,'dcuc']
, [332,13,332,37,'dcuc']
, [333,13,333,14,'dcuc']
, [334,17,334,53,'dcuc']
, [335,17,335,29,'dcuc']
, [345,9,345,10,'dcuc']
, [346,13,346,59,'dcuc']
, [347,9,347,10,'dcuc']
, [355,9,355,10,'dcuc']
, [356,13,356,58,'dcuc']
, [357,9,357,10,'dcuc']
, [378,17,378,41,'dcuc']
, [379,17,379,18,'dcuc']
, [380,21,380,57,'dcuc']
, [381,17,381,18,'dcuc']
, [408,13,408,37,'dcuc']
, [409,13,409,14,'dcuc']
, [410,17,410,53,'dcuc']
, [411,13,411,14,'dcuc']
, [436,9,436,10,'dcuc']
, [437,13,437,62,'dcuc']
, [438,9,438,10,'dcuc']
, [445,9,445,10,'dcuc']
, [447,13,447,14,'dcuc']
, [448,17,448,77,'dcuc']
, [449,17,449,31,'dcuc']
, [450,13,450,14,'dcuc']
, [451,13,451,37,'dcuc']
, [452,13,452,14,'dcuc']
, [453,17,453,53,'dcuc']
, [454,13,454,14,'dcuc']
, [455,9,455,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src248" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Text.RegularExpressions;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;

#endregion

namespace LGP.Modules.ModuleEditor.Internal
{
    /// &lt;summary&gt;
    /// &lt;/summary&gt;
    public class ModuleFileState : IModule
    {
        private static readonly IModuleGateway ModuleGateway;
        private static readonly Regex ModuleNameRegex;
        private readonly IModule _databaseModuleEntry;
        private readonly ModuleFileGrammerStateHandler _grammerhandler;
        private int _contentsHash;
        private string _fileContents;
        private string _fileLocation;
        private string _moduleName;
        private List&lt; IModuleObserver &gt; _observers;
        private bool _saving;

        static ModuleFileState()
        {
            ModuleNameRegex = new Regex( &quot;package\\s+(.*?)\\s*;&quot; );
            ModuleGateway = Framework.Database.CreateModuleGateway();
        }


        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;fileLocation&quot;&gt;&lt;/param&gt;
        /// &lt;param name = &quot;fileText&quot;&gt;&lt;/param&gt;
        public ModuleFileState( string fileLocation , string fileText )
        {
            try
            {
                this._observers = new List&lt; IModuleObserver &gt;();
                this._fileLocation = fileLocation;
                this._fileContents = fileText;
                this._contentsHash = this._fileContents.GetHashCode();
                this.ScanForPackageName();

                this._databaseModuleEntry = ModuleGateway.GetModuleByName( this._moduleName );

                if( this._databaseModuleEntry == null )
                {
                    this._databaseModuleEntry = ModuleGateway.CreateModule( this._moduleName );
                }

                this._grammerhandler = new ModuleFileGrammerStateHandler( this , this._databaseModuleEntry );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Moves the file to the new location
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;location&quot;&gt;string&lt;/param&gt;
        public void SetModuleLocation( string location )
        {
            try
            {
                this._fileLocation = location;
                this.Notify();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Saves all changes to the file and database
        /// &lt;/summary&gt;
        public void SaveChanges()
        {
            try
            {
                this._saving = true;
                this._contentsHash = this._fileContents.GetHashCode();
                this.ScanForPackageName();
                this._grammerhandler.Save();
                this.Save();
                this._saving = false;
                this.Notify();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void ScanForPackageName()
        {
            try
            {
                var match = ModuleNameRegex.Match( this._fileContents );
                var package = match.Groups[ 1 ].ToString();

                if( this._saving )
                {
                    this._databaseModuleEntry.SetModuleName( package );
                }

                this._moduleName = package;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void Save()
        {
            try
            {
                var client = ModuleHandler.GetClient();

                if( client != null )
                {
                    client.Connect();
                    client.SaveModule( this._fileLocation , this._fileContents );
                    client.Disconnect();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void OnPropertyChanged( string info )
        {
            try
            {
                this._contentsHash = this._fileContents.GetHashCode();
                var handler = this.PropertyChanged;
                if( handler != null )
                {
                    handler( this , new PropertyChangedEventArgs( info ) );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #region Implementation of IModuleObserver

        /// &lt;summary&gt;
        ///   Update this observer with a refernece to the module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;module&quot;&gt;IModule&lt;/param&gt;
        /// &lt;param name = &quot;source&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Update( IModule module , IModuleObserver source )
        {
        }

        /// &lt;summary&gt;
        ///   Attach objewcts that observer this module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Attach( IModuleObserver obj )
        {
            try
            {
                if( !this._observers.Contains( obj ) )
                {
                    this._observers.Add( obj );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Detach objewcts that observer this module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Detach( IModuleObserver obj )
        {
            try
            {
                this._observers.Remove( obj );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Notify observers of this module
        /// &lt;/summary&gt;
        public void Notify()
        {
            try
            {
                for( var x = 0; x &lt; this._observers.Count; x++ )
                {
                    this._observers[ x ].Update( this , this );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Dispose this object and all the observers
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Dispose( IModuleObserver obj )
        {
            try
            {
                var i = this._observers.Count - 1;
                while( i &gt; -1 )
                {
                    this._observers[ i ].Dispose( this );
                    i = this._observers.Count - 1;
                }
                this._observers = null;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion

        #region Implementation of IModule

        /// &lt;summary&gt;
        ///   Returns the module id
        /// &lt;/summary&gt;
        /// &lt;returns&gt;int&lt;/returns&gt;
        public int GetModuleId()
        {
            return this._databaseModuleEntry.GetModuleId();
        }

        /// &lt;summary&gt;
        ///   Adds a grammer to this module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;key&quot;&gt;string&lt;/param&gt;
        /// &lt;param name = &quot;value&quot;&gt;string&lt;/param&gt;
        public IGrammer AddGrammer( string key , string value )
        {
            try
            {
                var grammer = this._grammerhandler.AddGrammer( key , this._moduleName );
                this.Notify();
                return grammer;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }

        /// &lt;summary&gt;
        ///   Deletes a grammer given a key
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;key&quot;&gt;&lt;/param&gt;
        public void DeleteGrammer( string key )
        {
            try
            {
                this._grammerhandler.DeleteGrammer( key );
                this.Notify();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Deletes all the grammers associated with this module
        /// &lt;/summary&gt;
        public void DeleteAllGrammer()
        {
            try
            {
                this._grammerhandler.DeleteAllGrammer();
                this.Notify();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Gets all the grammers for this module
        /// &lt;/summary&gt;
        /// &lt;returns&gt;List ModuleFileGrammerState&lt;/returns&gt;
        public List&lt; IGrammer &gt; GetAllGrammers()
        {
            try
            {
                var grammer = new List&lt; IGrammer &gt;();
                foreach( var grammerstate in this._grammerhandler.GetAllGrammer() )
                {
                    if( grammerstate.IsDeleted() == false )
                    {
                        grammer.Add( grammerstate );
                    }
                }
                return grammer;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }

        /// &lt;summary&gt;
        ///   Gets a grammer given a key
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;key&quot;&gt;grammer lvalue&lt;/param&gt;
        /// &lt;returns&gt;IGrammer&lt;/returns&gt;
        public IGrammer GetGrammer( string key )
        {
            return this._grammerhandler.GetGrammer( key );
        }

        /// &lt;summary&gt;
        ///   Gets a grammer given an id
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;id&quot;&gt;grammer id&lt;/param&gt;
        /// &lt;returns&gt;IGrammer&lt;/returns&gt;
        public IGrammer GetGrammer( int id )
        {
            return this._grammerhandler.GetGrammer( id );
        }

        /// &lt;summary&gt;
        ///   Document associated with this object
        /// &lt;/summary&gt;
        public string FileContents
        {
            get
            {
                return this._fileContents;
            }
            set
            {
                try
                {
                    this._fileContents = value;
                    this._grammerhandler.SynchronizeDbWithStates();
                    this.SaveChanges();
                    this.Notify();
                    this.OnPropertyChanged( &quot;DocumentChanged&quot; );
                }
                catch( Exception error )
                {
                    Framework.EventBus.Publish( error );
                }
            }
        }


        /// &lt;summary&gt;
        ///   Gets the module package name
        /// &lt;/summary&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string GetModuleName()
        {
            return this._moduleName;
        }


        /// &lt;summary&gt;
        ///   Sets the module package name
        /// &lt;/summary&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public void SetModuleName( string packagename )
        {
            try
            {
                var currentpackagename = string.Copy( this._moduleName );
                this._moduleName = packagename;
                this.FileContents = this.FileContents.Replace( currentpackagename , packagename );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Gets the location of the file on the disk
        /// &lt;/summary&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string GetModuleLocation()
        {
            return this._fileLocation;
        }

        /// &lt;summary&gt;
        ///   Gets the file hash
        /// &lt;/summary&gt;
        public int GetHash()
        {
            return this._contentsHash;
        }

        /// &lt;summary&gt;
        ///   Gets the name of the module
        /// &lt;/summary&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string GetName()
        {
            return this._databaseModuleEntry.GetModuleName();
        }

        /// &lt;summary&gt;
        ///   Sets the module name
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;name&quot;&gt;&lt;/param&gt;
        public void SetName( string name )
        {
            try
            {
                this._databaseModuleEntry.SetModuleName( this._moduleName );
                this.Notify();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion

        #region Implementation of INotifyPropertyChanged

        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src248', RANGES_248)
		</script>
	</body>
</html>