<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_34 = [
   [43,9,43,33,'dccv']
, [44,9,44,10,'dccv']
, [46,13,46,14,'dccv']
, [47,17,47,35,'dccv']
, [48,17,48,64,'dccv']
, [49,17,49,69,'dccv']
, [50,17,50,67,'dccv']
, [51,17,51,108,'dccv']
, [53,17,53,39,'dccv']
, [54,13,54,14,'dccv']
, [59,9,59,10,'dccv']
, [67,9,67,10,'dccv']
, [68,13,68,31,'dccv']
, [71,13,71,14,'dccv']
, [72,17,72,89,'dccv']
, [73,13,73,14,'dccv']
, [80,9,80,10,'dccv']
, [88,9,88,10,'dccv']
, [89,13,89,31,'dccv']
, [92,13,92,14,'dccv']
, [93,17,93,61,'dccv']
, [95,17,95,24,'dccv']
, [95,38,95,57,'dccv']
, [95,26,95,34,'dccv']
, [96,17,96,18,'dccv']
, [97,21,97,60,'dccv']
, [98,21,98,22,'dccv']
, [99,25,99,34,'dccv']
, [102,21,102,59,'dccv']
, [104,21,104,67,'dccv']
, [105,21,105,22,'dccv']
, [106,25,106,49,'dccv']
, [107,21,107,22,'dccv']
, [109,21,109,73,'dccv']
, [110,21,110,22,'dccv']
, [111,25,111,56,'dccv']
, [112,21,112,22,'dccv']
, [114,21,114,65,'dccv']
, [115,21,115,22,'dccv']
, [116,25,116,58,'dccv']
, [117,21,117,22,'dccv']
, [119,21,119,66,'dccv']
, [120,21,120,22,'dccv']
, [121,25,121,59,'dccv']
, [122,21,122,22,'dccv']
, [124,21,124,73,'dccv']
, [125,21,125,22,'dccv']
, [126,25,126,68,'dccv']
, [127,25,127,75,'dccv']
, [128,21,128,22,'dccv']
, [130,21,130,67,'dccv']
, [131,21,131,22,'dccv']
, [132,25,132,68,'dccv']
, [133,25,133,71,'dccv']
, [134,21,134,22,'dccv']
, [136,21,136,69,'dccv']
, [137,21,137,22,'dccv']
, [138,25,138,58,'dccv']
, [139,25,139,68,'dccv']
, [140,25,140,67,'dccv']
, [141,21,141,22,'dccv']
, [143,21,143,75,'dccv']
, [144,21,144,22,'dccv']
, [145,25,145,71,'dccv']
, [146,21,146,22,'dccv']
, [148,21,148,72,'dccv']
, [149,21,149,22,'dccv']
, [150,25,150,66,'dccv']
, [151,21,151,22,'dccv']
, [152,17,152,18,'dccv']
, [95,35,95,37,'dccv']
, [153,13,153,14,'dccv']
, [160,9,160,10,'dccv']
, [168,9,168,10,'dccv']
, [169,13,169,43,'dccv']
, [170,9,170,10,'dccv']
, [178,9,178,10,'dccv']
, [179,13,179,45,'dccv']
, [180,9,180,10,'dccv']
, [188,9,188,10,'dccv']
, [189,13,189,30,'dccv']
, [190,9,190,10,'dccv']
, [208,9,208,10,'dccv']
, [209,13,209,46,'dccv']
, [210,9,210,10,'dccv']
, [218,9,218,10,'dccv']
, [219,13,219,37,'dccv']
, [220,9,220,10,'dccv']
, [228,9,228,10,'dccv']
, [229,13,229,47,'dccv']
, [230,9,230,10,'dccv']
, [238,9,238,10,'dccv']
, [239,13,239,44,'dccv']
, [240,9,240,10,'dccv']
, [248,9,248,10,'dccv']
, [249,13,249,35,'dccv']
, [250,9,250,10,'dccv']
, [259,9,259,10,'dccv']
, [261,13,261,14,'dccv']
, [262,17,262,77,'dccv']
, [263,17,263,38,'dccv']
, [270,9,270,10,'dccv']
, [279,9,279,10,'dccv']
, [281,13,281,14,'dccv']
, [282,17,282,77,'dccv']
, [283,17,283,52,'dccv']
, [290,9,290,10,'dccv']
, [299,9,299,10,'dccv']
, [301,13,301,14,'dccv']
, [302,17,302,60,'dccv']
, [303,17,303,28,'dccv']
, [310,9,310,10,'dccv']
, [340,9,340,10,'dccv']
, [341,13,341,42,'dccv']
, [342,9,342,10,'dccv']
, [371,9,371,10,'dccv']
, [372,13,372,49,'dccv']
, [373,9,373,10,'dccv']
, [380,9,380,10,'dccv']
, [381,13,381,46,'dccv']
, [382,9,382,10,'dccv']
, [391,9,391,10,'dccv']
, [392,13,392,70,'dccv']
, [393,9,393,10,'dccv']
, [55,13,55,37,'dcuc']
, [56,13,56,14,'dcuc']
, [57,17,57,53,'dcuc']
, [58,13,58,14,'dcuc']
, [74,13,74,37,'dcuc']
, [75,13,75,14,'dcuc']
, [76,17,76,53,'dcuc']
, [77,17,77,34,'dcuc']
, [78,17,78,44,'dcuc']
, [79,13,79,14,'dcuc']
, [154,13,154,37,'dcuc']
, [155,13,155,14,'dcuc']
, [156,17,156,53,'dcuc']
, [157,17,157,34,'dcuc']
, [158,17,158,44,'dcuc']
, [159,13,159,14,'dcuc']
, [198,9,198,10,'dcuc']
, [199,13,199,31,'dcuc']
, [200,9,200,10,'dcuc']
, [265,13,265,37,'dcuc']
, [266,13,266,14,'dcuc']
, [267,17,267,53,'dcuc']
, [268,17,268,29,'dcuc']
, [285,13,285,37,'dcuc']
, [286,13,286,14,'dcuc']
, [287,17,287,53,'dcuc']
, [288,17,288,29,'dcuc']
, [305,13,305,37,'dcuc']
, [306,13,306,14,'dcuc']
, [307,17,307,53,'dcuc']
, [308,17,308,29,'dcuc']
, [320,9,320,10,'dcuc']
, [322,13,322,14,'dcuc']
, [323,17,323,64,'dcuc']
, [324,17,324,28,'dcuc']
, [326,13,326,37,'dcuc']
, [327,13,327,14,'dcuc']
, [328,17,328,53,'dcuc']
, [329,17,329,29,'dcuc']
, [331,9,331,10,'dcuc']
, [351,9,351,10,'dcuc']
, [353,13,353,14,'dcuc']
, [354,17,354,96,'dcuc']
, [355,17,355,59,'dcuc']
, [356,17,356,46,'dcuc']
, [358,13,358,37,'dcuc']
, [359,13,359,14,'dcuc']
, [360,17,360,53,'dcuc']
, [361,17,361,29,'dcuc']
, [363,9,363,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src34" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Windows.Controls;
using LGP.Components.Factory.Interfaces.Component;
using LGP.Components.Factory.Interfaces.Database;
using LGP.Components.Factory.Interfaces.Infrastructure;
using LGP.Components.Factory.Interfaces.Module;
using IModule = LGP.Components.Factory.Interfaces.Module.IModule;

#endregion

namespace LGP.Components.Factory.Internal
{
    /// &lt;summary&gt;
    /// Class library handler
    /// &lt;/summary&gt;
    public class LibraryHandler : IClassLibraryHandler
    {
        private static LibraryHandler _instance;
        private static bool _hasError;
        private static string _lastError;
        private readonly string _assemblyLocation;
        private readonly List&lt; IComponent &gt; _internalComponents;
        private readonly List&lt; IModule &gt; _moduleComponents;
        private readonly List&lt; Type &gt; _modulePreferencesPanes;

        private Type _applicationMenuType;
        private Type _applicationPanelType;
        private IContextMenus _contextMenusHandler;
        private IDatabase _databaseGateway;
        private Type _databaseGatewayType;
        private Type _dialogType;

        private string[ ] _dllPaths;
        private Type _notificationsType;


        private LibraryHandler()
        {
            try
            {
                _hasError = false;
                this._moduleComponents = new List&lt; IModule &gt;();
                this._internalComponents = new List&lt; IComponent &gt;();
                this._modulePreferencesPanes = new List&lt; Type &gt;();
                this._assemblyLocation = Path.GetDirectoryName( Assembly.GetExecutingAssembly().Location );

                this.LoadDllListing();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #region IClassLibraryHandler Members

        /// &lt;summary&gt;
        ///   Gets a listing of dlls from the application directory
        /// &lt;/summary&gt;
        public void LoadDllListing()
        {
            _hasError = false;

            try
            {
                this._dllPaths = Directory.GetFiles( this._assemblyLocation , &quot;*.dll&quot; );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                _hasError = true;
                _lastError = error.Message;
            }
        }


        /// &lt;summary&gt;
        ///   Loads a dll given a path
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;dllPath&quot;&gt;The path to the dll&lt;/param&gt;
        public void LoadIComponent( string dllPath )
        {
            _hasError = false;

            try
            {
                var assembly = Assembly.LoadFile( dllPath );

                foreach( var type in assembly.GetTypes() )
                {
                    if( !type.IsClass || type.IsNotPublic )
                    {
                        continue;
                    }

                    var interfaces = type.GetInterfaces();

                    if( interfaces.Contains( typeof( IDialog ) ) )
                    {
                        this._dialogType = type;
                    }

                    if( interfaces.Contains( typeof( INotification ) ) )
                    {
                        this._notificationsType = type;
                    }

                    if( interfaces.Contains( typeof( IMenu ) ) )
                    {
                        this._applicationMenuType = type;
                    }

                    if( interfaces.Contains( typeof( IPanel ) ) )
                    {
                        this._applicationPanelType = type;
                    }

                    if( interfaces.Contains( typeof( IContextMenus ) ) )
                    {
                        var obj = Activator.CreateInstance( type );
                        this._contextMenusHandler = ( IContextMenus ) obj;
                    }

                    if( interfaces.Contains( typeof( IModule ) ) )
                    {
                        var obj = Activator.CreateInstance( type );
                        this._moduleComponents.Add( ( IModule ) obj );
                    }

                    if( interfaces.Contains( typeof( IDatabase ) ) )
                    {
                        this._databaseGatewayType = type;
                        var obj = Activator.CreateInstance( type );
                        this._databaseGateway = ( IDatabase ) obj;
                    }

                    if( interfaces.Contains( typeof( IDatabaseModule ) ) )
                    {
                        this._databaseGateway.AddDatabaseType( type );
                    }

                    if( interfaces.Contains( typeof( IPreferences ) ) )
                    {
                        this._modulePreferencesPanes.Add( type );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                _hasError = true;
                _lastError = error.Message;
            }
        }


        /// &lt;summary&gt;
        ///   Get the types that realised the IModule interface
        /// &lt;/summary&gt;
        /// &lt;returns&gt;List of modules&lt;/returns&gt;
        public List&lt; IModule &gt; GetModules()
        {
            return this._moduleComponents;
        }


        /// &lt;summary&gt;
        ///   Get the types that realised the iComponent interface
        /// &lt;/summary&gt;
        /// &lt;returns&gt;List of IComponents&lt;/returns&gt;
        public List&lt; IComponent &gt; GetComponents()
        {
            return this._internalComponents;
        }


        /// &lt;summary&gt;
        ///   Check to see if there was an error
        /// &lt;/summary&gt;
        /// &lt;returns&gt;bool error&lt;/returns&gt;
        public bool HasError()
        {
            return _hasError;
        }


        /// &lt;summary&gt;
        ///   Get the last error occurred
        /// &lt;/summary&gt;
        /// &lt;returns&gt;String error&lt;/returns&gt;
        public string GetError()
        {
            return _lastError;
        }


        /// &lt;summary&gt;
        ///   Get the type that realised the Imenu interface
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Type GetMenuType()
        {
            return this._applicationMenuType;
        }


        /// &lt;summary&gt;
        ///   Get the type that realized the IDialog interface
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Type GetDialogType()
        {
            return this._dialogType;
        }


        /// &lt;summary&gt;
        ///   Get the type that realized the IPanle interface
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Type GetPanelType()
        {
            return this._applicationPanelType;
        }


        /// &lt;summary&gt;
        ///   Get the type that realized the IPanle interface
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Type GetNotifcationType()
        {
            return this._notificationsType;
        }


        /// &lt;summary&gt;
        ///   Return dlls in directory path
        /// &lt;/summary&gt;
        /// &lt;returns&gt;String[] dlls&lt;/returns&gt;
        public string[ ] GetDllPaths()
        {
            return this._dllPaths;
        }


        /// &lt;summary&gt;
        ///   Gets the name of an dll asembly given its path
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;assemblyPath&quot;&gt;Dll path&lt;/param&gt;
        /// &lt;returns&gt;Asembly name&lt;/returns&gt;
        public string GetAssemblyName( string assemblyPath )
        {
            try
            {
                var assembly = AssemblyName.GetAssemblyName( assemblyPath );
                return assembly.Name;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Gets the assembly version
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;assemblyPath&quot;&gt;Dll path&lt;/param&gt;
        /// &lt;returns&gt;Dll version&lt;/returns&gt;
        public string GetAssemblyVersion( string assemblyPath )
        {
            try
            {
                var assembly = AssemblyName.GetAssemblyName( assemblyPath );
                return assembly.Version.ToString();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Create an object of type
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;type&quot;&gt;type of object you would like to create&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Object CreateObject( Type type )
        {
            try
            {
                var obj = Activator.CreateInstance( type );
                return obj;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Create an object of type
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;type&quot;&gt;type of object you would like to create&lt;/param&gt;
        /// &lt;param name = &quot;o&quot;&gt;The contructor parameter&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Object CreateObject( Type type , Menu o )
        {
            try
            {
                var obj = Activator.CreateInstance( type , o );
                return obj;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Gets a previously created database strategy context object
        /// &lt;/summary&gt;
        /// &lt;returns&gt;IDatabaseModule type&lt;/returns&gt;
        /// &lt;exception cref = &quot;Exception&quot;&gt;Exception context strategy null&lt;/exception&gt;
        public IDatabase GetDatabaseContextHandler()
        {
            return this._databaseGateway;
        }


        /// &lt;summary&gt;
        ///   Recreated the database gateway given a new strategy type
        /// &lt;/summary&gt;
        /// &lt;returns&gt;IDatabaseModule type&lt;/returns&gt;
        /// &lt;exception cref = &quot;Exception&quot;&gt;Exception context strategy null&lt;/exception&gt;
        public IDatabase GetDatabaseContextHandler( Type strategyType )
        {
            try
            {
                var obj = Activator.CreateInstance( this._databaseGatewayType , strategyType );
                this._databaseGateway = ( IDatabase ) obj;
                return this._databaseGateway;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return null;
            }
        }


        /// &lt;summary&gt;
        ///   Gets the preferences panes associated with the modules
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public List&lt; Type &gt; GetPreferencesPanes()
        {
            return this._modulePreferencesPanes;
        }

        /// &lt;summary&gt;
        ///   Gets the conext menus handler
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IContextMenus GetConextMenusHandler()
        {
            return this._contextMenusHandler;
        }

        #endregion

        /// &lt;summary&gt;
        /// Gets an instance of the library handler
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static LibraryHandler GetInstance()
        {
            return _instance ?? ( _instance = new LibraryHandler() );
        }
    }
}</pre></code><script type="text/javascript">
			applyranges('src34', RANGES_34)
		</script>
	</body>
</html>