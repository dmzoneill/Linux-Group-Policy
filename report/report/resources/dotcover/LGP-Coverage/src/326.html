<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_326 = [
   [31,9,31,38,'dccv']
, [32,9,32,10,'dccv']
, [34,13,34,14,'dccv']
, [35,17,35,44,'dccv']
, [37,17,37,63,'dccv']
, [39,17,39,117,'dccv']
, [41,17,41,62,'dccv']
, [42,17,45,19,'dccv']
, [47,17,47,74,'dccv']
, [48,17,48,53,'dccv']
, [49,17,49,45,'dccv']
, [51,17,51,53,'dccv']
, [52,13,52,14,'dccv']
, [57,9,57,10,'dccv']
, [60,9,60,10,'dccv']
, [62,13,62,14,'dccv']
, [63,17,63,67,'dccv']
, [64,17,64,18,'dccv']
, [65,21,65,101,'dccv']
, [66,21,66,51,'dccv']
, [67,21,67,22,'dccv']
, [68,25,68,61,'dccv']
, [69,21,69,22,'dccv']
, [70,17,70,18,'dccv']
, [72,17,72,44,'dccv']
, [73,13,73,14,'dccv']
, [77,9,77,10,'dccv']
, [81,9,81,10,'dccv']
, [83,13,83,14,'dccv']
, [84,17,84,24,'dccv']
, [84,35,84,51,'dccv']
, [84,26,84,31,'dccv']
, [85,17,85,18,'dccv']
, [86,21,86,67,'dccv']
, [87,21,87,22,'dccv']
, [88,25,88,37,'dccv']
, [84,32,84,34,'dccv']
, [91,17,91,30,'dccv']
, [98,9,98,10,'dccv']
, [102,9,102,10,'dccv']
, [104,13,104,14,'dccv']
, [105,17,105,36,'dccv']
, [107,17,107,62,'dccv']
, [109,17,109,24,'dccv']
, [109,35,109,42,'dccv']
, [109,26,109,31,'dccv']
, [110,17,110,18,'dccv']
, [111,21,111,72,'dccv']
, [112,21,112,22,'dccv']
, [113,25,113,39,'dccv']
, [114,21,114,22,'dccv']
, [115,17,115,18,'dccv']
, [109,32,109,34,'dccv']
, [118,17,119,17,'dccv']
, [134,22,135,23,'dccv']
, [136,13,136,14,'dccv']
, [141,9,141,10,'dccv']
, [148,9,148,10,'dccv']
, [149,13,149,76,'dccv']
, [150,9,150,10,'dccv']
, [153,9,153,10,'dccv']
, [155,13,155,14,'dccv']
, [156,17,156,62,'dccv']
, [157,17,157,18,'dccv']
, [158,21,158,78,'dccv']
, [159,21,159,83,'dccv']
, [160,17,160,18,'dccv']
, [161,13,161,14,'dccv']
, [166,9,166,10,'dccv']
, [186,9,186,10,'dccv']
, [188,13,188,14,'dccv']
, [189,17,189,61,'dccv']
, [190,17,190,18,'dccv']
, [191,21,191,102,'dccv']
, [192,21,192,83,'dccv']
, [193,17,193,18,'dccv']
, [194,13,194,14,'dccv']
, [199,9,199,10,'dccv']
, [207,9,207,10,'dccv']
, [209,13,209,14,'dccv']
, [210,17,210,44,'dccv']
, [211,13,211,14,'dccv']
, [216,9,216,10,'dccv']
, [222,9,222,10,'dccv']
, [223,13,223,59,'dccv']
, [224,9,224,10,'dccv']
, [231,9,231,10,'dccv']
, [233,13,233,14,'dccv']
, [234,13,234,14,'dccv']
, [238,9,238,10,'dccv']
, [244,9,244,10,'dccv']
, [246,13,246,14,'dccv']
, [247,13,247,14,'dccv']
, [251,9,251,10,'dccv']
, [119,17,119,18,'dccv']
, [120,21,120,33,'dccv']
, [121,21,121,22,'dccv']
, [122,25,122,50,'dccv']
, [124,25,124,32,'dccv']
, [124,43,124,50,'dccv']
, [124,34,124,39,'dccv']
, [125,25,125,26,'dccv']
, [126,29,130,31,'dccv']
, [131,29,131,55,'dccv']
, [132,25,132,26,'dccv']
, [124,40,124,42,'dccv']
, [133,25,133,75,'dccv']
, [134,21,134,22,'dccv']
, [53,13,53,37,'dcuc']
, [54,13,54,14,'dcuc']
, [55,17,55,53,'dcuc']
, [56,13,56,14,'dcuc']
, [74,13,74,31,'dcuc']
, [75,13,75,14,'dcuc']
, [76,13,76,14,'dcuc']
, [90,17,90,18,'dcuc']
, [93,13,93,37,'dcuc']
, [94,13,94,14,'dcuc']
, [95,17,95,53,'dcuc']
, [96,17,96,30,'dcuc']
, [137,13,137,37,'dcuc']
, [138,13,138,14,'dcuc']
, [139,17,139,53,'dcuc']
, [140,13,140,14,'dcuc']
, [162,13,162,37,'dcuc']
, [163,13,163,14,'dcuc']
, [164,17,164,53,'dcuc']
, [165,13,165,14,'dcuc']
, [169,9,169,10,'dcuc']
, [171,13,171,14,'dcuc']
, [172,17,172,62,'dcuc']
, [173,17,173,18,'dcuc']
, [174,21,174,102,'dcuc']
, [175,21,175,83,'dcuc']
, [176,17,176,18,'dcuc']
, [177,13,177,14,'dcuc']
, [178,13,178,37,'dcuc']
, [179,13,179,14,'dcuc']
, [180,17,180,53,'dcuc']
, [181,13,181,14,'dcuc']
, [182,9,182,10,'dcuc']
, [195,13,195,37,'dcuc']
, [196,13,196,14,'dcuc']
, [197,17,197,53,'dcuc']
, [198,13,198,14,'dcuc']
, [212,13,212,37,'dcuc']
, [213,13,213,14,'dcuc']
, [214,17,214,53,'dcuc']
, [215,13,215,14,'dcuc']
, [235,13,235,31,'dcuc']
, [236,13,236,14,'dcuc']
, [237,13,237,14,'dcuc']
, [248,13,248,31,'dcuc']
, [249,13,249,14,'dcuc']
, [250,13,250,14,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src326" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Timers;
using System.Windows;
using System.Windows.Input;
using System.Windows.Threading;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Module;
using LGP.Components.Factory.Interfaces.Network;
using LGP.Components.Factory.Internal.ServerControl;

#endregion

namespace LGP.Modules.ServerControl
{
    /// &lt;summary&gt;
    /// Interaction logic for ConnectionController.xaml
    /// &lt;/summary&gt;
    public partial class ConnectionController : IUserControl
    {
        private static ConnectionController _instance;
        private readonly Timer _refreshTicker;
        private readonly List&lt; IServerInfo &gt; _serverList;

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        public ConnectionController()
        {
            try
            {
                this.InitializeComponent();

                this.Tag = Properties.Resources.ServerControl;

                this.ServerImage.Source = Framework.Images.GetImage( &quot;Networkgroup&quot; , &quot;VS2010ImageLibrary&quot; ).Source;

                this._serverList = new List&lt; IServerInfo &gt;();
                this._refreshTicker = new Timer
                {
                    Enabled = true
                };

                this._refreshTicker.Elapsed += this.RefreshTickerElapsed;
                this._refreshTicker.Interval = 2000;
                this._refreshTicker.Start();

                Framework.ShutDown += this.Shutdown;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void Shutdown( object sender , CancelEventArgs e )
        {
            try
            {
                if( this.ConnectionViewerContainer.Child != null )
                {
                    var connectionViewer = this.ConnectionViewerContainer.Child as ConnectionViewer;
                    if( connectionViewer != null )
                    {
                        connectionViewer.StopStressTester();
                    }
                }

                this._refreshTicker.Stop();
            }
            catch( Exception )
            {
            }
        }


        private bool InspectItems( string server )
        {
            try
            {
                foreach( var t in this._serverList )
                {
                    if( t.ServerAddress.CompareTo( server ) == 0 )
                    {
                        return true;
                    }
                }
                return false;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return false;
            }
        }


        private void RefreshTickerElapsed( object sender , ElapsedEventArgs e )
        {
            try
            {
                var update = false;

                var servers = Framework.Network.GetServers();

                foreach( var t in servers )
                {
                    if( this.InspectItems( t.ServerAddress ) == false )
                    {
                        update = true;
                    }
                }


                this.ServerListBox.Dispatcher.BeginInvoke( DispatcherPriority.Normal , ( Action ) ( delegate
                {
                    if( update )
                    {
                        this._serverList.Clear();

                        foreach( var t in servers )
                        {
                            var n = new ServerInfo
                            {
                                LastSeen = t.LastSeen ,
                                ServerAddress = t.ServerAddress
                            };
                            this._serverList.Add( n );
                        }
                        this.ServerListBox.DataContext = this._serverList;
                    }
                } ) );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        /// Gets the instance of this usercontrol
        /// &lt;/summary&gt;
        /// &lt;returns&gt;ConnectionController&lt;/returns&gt;
        public static ConnectionController GetInstance()
        {
            return _instance ?? ( _instance = new ConnectionController() );
        }

        private void ConnectServerButtonClick( object sender , RoutedEventArgs e )
        {
            try
            {
                if( this.textBox1.Text.CompareTo( &quot;&quot; ) != 0 )
                {
                    Framework.Network.SetServerAddress( this.textBox1.Text );
                    this.ConnectionViewerContainer.Child = new ConnectionViewer();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void SelectServerButtonClick( object sender , RoutedEventArgs e )
        {
            try
            {
                if( this.ServerListBox.SelectedItem != null )
                {
                    Framework.Network.SetServerAddress( this.ServerListBox.SelectedItem.ToString() );
                    this.ConnectionViewerContainer.Child = new ConnectionViewer();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void ServerListNodeDoubleClick( object sender , MouseButtonEventArgs e )
        {
            try
            {
                if( this.ServerListBox.SelectedIndex != -1 )
                {
                    Framework.Network.SetServerAddress( this.ServerListBox.SelectedItem.ToString() );
                    this.ConnectionViewerContainer.Child = new ConnectionViewer();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #region Implementation of IUserControl

        /// &lt;summary&gt;
        ///   Aks the UserControl to do some clean up!
        /// &lt;/summary&gt;
        public void Dispose()
        {
            try
            {
                this._refreshTicker.Stop();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        /// Asks the Usercontrol to refresh itself
        /// &lt;/summary&gt;
        public void Refresh()
        {
            this.Tag = Properties.Resources.ServerControl;
        }


        /// &lt;summary&gt;
        /// When the control is no longer in focus, asks it to pause ( heavy duty non critical, ie threads updating graphs )
        /// &lt;/summary&gt;
        public void Pause()
        {
            try
            {
            }
            catch( Exception )
            {
            }
        }

        /// &lt;summary&gt;
        /// When the tab comes back into focus, resume ( heavy duty non critical, ie threads updating graphs )
        /// &lt;/summary&gt;
        public void Resume()
        {
            try
            {
            }
            catch( Exception )
            {
            }
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src326', RANGES_326)
		</script>
	</body>
</html>