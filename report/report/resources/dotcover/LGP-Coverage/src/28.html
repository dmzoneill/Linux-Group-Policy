<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_28 = [
   [45,9,45,66,'dccv']
, [46,9,46,10,'dccv']
, [48,13,48,14,'dccv']
, [49,17,49,45,'dccv']
, [51,17,51,45,'dccv']
, [52,17,55,19,'dccv']
, [56,17,56,49,'dccv']
, [57,13,57,14,'dccv']
, [62,9,62,10,'dccv']
, [85,9,85,10,'dccv']
, [87,13,87,14,'dccv']
, [88,17,88,81,'dccv']
, [89,17,89,40,'dccv']
, [90,17,90,40,'dccv']
, [98,9,98,10,'dccv']
, [105,9,105,10,'dccv']
, [107,13,107,14,'dccv']
, [108,17,108,45,'dccv']
, [109,17,109,41,'dccv']
, [110,17,110,41,'dccv']
, [118,9,118,10,'dccv']
, [158,9,158,10,'dccv']
, [160,13,160,14,'dccv']
, [161,17,161,31,'dccv']
, [162,17,162,84,'dccv']
, [163,17,163,81,'dccv']
, [164,17,164,64,'dccv']
, [165,17,165,28,'dccv']
, [167,17,167,90,'dccv']
, [168,17,168,62,'dccv']
, [169,17,169,56,'dccv']
, [170,17,170,32,'dccv']
, [171,13,171,14,'dccv']
, [176,9,176,10,'dccv']
, [183,9,183,10,'dccv']
, [185,13,185,14,'dccv']
, [186,17,186,31,'dccv']
, [187,17,187,84,'dccv']
, [188,17,188,81,'dccv']
, [189,17,189,62,'dccv']
, [190,17,190,28,'dccv']
, [192,17,192,90,'dccv']
, [193,17,193,62,'dccv']
, [194,17,194,56,'dccv']
, [195,17,195,32,'dccv']
, [196,13,196,14,'dccv']
, [201,9,201,10,'dccv']
, [208,9,208,10,'dccv']
, [210,13,210,14,'dccv']
, [211,17,211,31,'dccv']
, [212,17,212,84,'dccv']
, [213,17,213,81,'dccv']
, [214,17,214,61,'dccv']
, [215,17,215,28,'dccv']
, [217,17,217,90,'dccv']
, [218,17,218,62,'dccv']
, [219,17,219,56,'dccv']
, [220,17,220,32,'dccv']
, [221,13,221,14,'dccv']
, [226,9,226,10,'dccv']
, [233,9,233,10,'dccv']
, [235,13,235,14,'dccv']
, [236,17,236,31,'dccv']
, [237,17,237,84,'dccv']
, [238,17,238,81,'dccv']
, [239,17,239,62,'dccv']
, [240,17,240,28,'dccv']
, [242,17,242,90,'dccv']
, [243,17,243,62,'dccv']
, [244,17,244,56,'dccv']
, [245,17,245,32,'dccv']
, [246,13,246,14,'dccv']
, [251,9,251,10,'dccv']
, [258,9,258,10,'dccv']
, [260,13,260,14,'dccv']
, [261,17,261,31,'dccv']
, [262,17,262,84,'dccv']
, [263,17,263,81,'dccv']
, [264,17,264,61,'dccv']
, [265,17,265,61,'dccv']
, [266,17,266,100,'dccv']
, [267,17,267,28,'dccv']
, [269,17,269,90,'dccv']
, [270,17,270,62,'dccv']
, [271,17,271,56,'dccv']
, [272,17,272,32,'dccv']
, [273,13,273,14,'dccv']
, [278,9,278,10,'dccv']
, [285,9,285,10,'dccv']
, [287,13,287,14,'dccv']
, [288,17,288,31,'dccv']
, [289,17,289,84,'dccv']
, [290,17,290,81,'dccv']
, [291,17,291,63,'dccv']
, [292,17,292,60,'dccv']
, [293,17,293,28,'dccv']
, [295,17,295,90,'dccv']
, [296,17,296,62,'dccv']
, [297,17,297,56,'dccv']
, [298,17,298,32,'dccv']
, [299,13,299,14,'dccv']
, [304,9,304,10,'dccv']
, [309,9,309,10,'dccv']
, [311,13,311,14,'dccv']
, [312,17,312,62,'dccv']
, [314,17,314,93,'dccv']
, [315,17,315,47,'dccv']
, [318,17,318,44,'dccv']
, [321,17,321,18,'dccv']
, [322,21,322,74,'dccv']
, [323,21,323,53,'dccv']
, [326,21,326,35,'dccv']
, [330,21,330,22,'dccv']
, [331,25,331,75,'dccv']
, [332,21,332,22,'dccv']
, [329,21,329,82,'dccv']
, [334,21,334,65,'dccv']
, [336,21,336,49,'dccv']
, [338,21,338,36,'dccv']
, [339,17,339,18,'dccv']
, [320,17,320,30,'dccv']
, [58,13,58,37,'dcuc']
, [59,13,59,14,'dcuc']
, [60,17,60,53,'dcuc']
, [61,13,61,14,'dcuc']
, [76,9,76,10,'dcuc']
, [77,13,77,36,'dcuc']
, [78,9,78,10,'dcuc']
, [92,13,92,37,'dcuc']
, [93,13,93,14,'dcuc']
, [94,17,94,53,'dcuc']
, [95,17,95,41,'dcuc']
, [96,17,96,40,'dcuc']
, [112,13,112,37,'dcuc']
, [113,13,113,14,'dcuc']
, [114,17,114,53,'dcuc']
, [115,17,115,41,'dcuc']
, [116,17,116,40,'dcuc']
, [126,9,126,10,'dcuc']
, [128,13,128,14,'dcuc']
, [129,17,129,31,'dcuc']
, [130,17,130,84,'dcuc']
, [132,22,132,32,'dcuc']
, [133,17,133,18,'dcuc']
, [134,21,134,98,'dcuc']
, [135,17,135,18,'dcuc']
, [132,56,132,59,'dcuc']
, [132,33,132,54,'dcuc']
, [136,17,136,125,'dcuc']
, [137,17,137,28,'dcuc']
, [139,17,139,90,'dcuc']
, [140,17,140,62,'dcuc']
, [141,17,141,56,'dcuc']
, [142,17,142,32,'dcuc']
, [144,17,144,29,'dcuc']
, [146,13,146,37,'dcuc']
, [147,13,147,14,'dcuc']
, [148,17,148,53,'dcuc']
, [149,17,149,30,'dcuc']
, [151,9,151,10,'dcuc']
, [172,13,172,37,'dcuc']
, [173,13,173,14,'dcuc']
, [174,17,174,53,'dcuc']
, [175,13,175,14,'dcuc']
, [197,13,197,37,'dcuc']
, [198,13,198,14,'dcuc']
, [199,17,199,53,'dcuc']
, [200,13,200,14,'dcuc']
, [222,13,222,37,'dcuc']
, [223,13,223,14,'dcuc']
, [224,17,224,53,'dcuc']
, [225,13,225,14,'dcuc']
, [247,13,247,37,'dcuc']
, [248,13,248,14,'dcuc']
, [249,17,249,53,'dcuc']
, [250,13,250,14,'dcuc']
, [274,13,274,37,'dcuc']
, [275,13,275,14,'dcuc']
, [276,17,276,53,'dcuc']
, [277,13,277,14,'dcuc']
, [300,13,300,37,'dcuc']
, [301,13,301,14,'dcuc']
, [302,17,302,53,'dcuc']
, [303,13,303,14,'dcuc']
, [341,13,341,37,'dcuc']
, [342,13,342,14,'dcuc']
, [343,17,343,53,'dcuc']
, [344,13,344,14,'dcuc']
, [345,9,345,10,'dcuc']
, [352,9,352,10,'dcuc']
, [354,13,354,14,'dcuc']
, [355,17,355,49,'dcuc']
, [356,17,356,46,'dcuc']
, [357,13,357,14,'dcuc']
, [358,13,358,37,'dcuc']
, [359,13,359,14,'dcuc']
, [360,17,360,53,'dcuc']
, [361,13,361,14,'dcuc']
, [362,9,362,10,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src28" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using LGP.Components.Factory.Interfaces.Network;

#endregion

namespace LGP.Components.Factory.Internal.ServerControl
{

    #region Delegates

    /// &lt;summary&gt;
    /// 
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt;
    public delegate void DataReceived( string data );

    #endregion

    /// &lt;summary&gt;
    /// &lt;/summary&gt;
    internal class ServerController : IServerController
    {
        private readonly int _clientPort;
        private readonly string _serverAddr;
        private readonly Thread _tcpListenerThread;

        private bool _connected;

        private TcpListener _receivingClient;
        private TcpClient _sendingClient;


        /// &lt;summary&gt;
        ///   Constructor
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;serverIp&quot;&gt;&lt;/param&gt;
        /// &lt;param name = &quot;clientId&quot;&gt;&lt;/param&gt;
        public ServerController( string serverIp , int clientId )
        {
            try
            {
                this._clientPort = clientId;

                this._serverAddr = serverIp;
                this._tcpListenerThread = new Thread( this.Listener )
                {
                    IsBackground = true
                };
                this._tcpListenerThread.Start();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #region IServerController Members

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public event DataReceived OnDataReceived;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool IsConnected()
        {
            return this._connected;
        }


        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Connect()
        {
            try
            {
                this._sendingClient = new TcpClient( this._serverAddr , 50000 );
                this._connected = true;
                return this._connected;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                this._connected = false;
                return this._connected;
            }
        }


        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Disconnect()
        {
            try
            {
                this._sendingClient.Close();
                this._connected = false;
                return !this._connected;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                this._connected = false;
                return this._connected;
            }
        }


        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;message&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool SendMesssage( List&lt; KeyValuePair&lt; string , string &gt; &gt; message )
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;

                for( var h = 0; h &lt; message.Count - 1; h++ )
                {
                    msg += &quot;\&quot;&quot; + message[ h ].Key + &quot;\&quot; : &quot; + &quot;\&quot;&quot; + message[ h ].Value + &quot;\&quot;,&quot;;
                }
                msg += &quot;\&quot;&quot; + message[ message.Count - 1 ].Key + &quot;\&quot; : &quot; + &quot;\&quot;&quot; + message[ message.Count - 1 ].Value + &quot;\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();

                return true;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
                return false;
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void SendPolicyUpdated()
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;admin\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;request\&quot; : &quot; + &quot;\&quot;updatepolicies\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void SendPushPolicies()
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;admin\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;request\&quot; : &quot; + &quot;\&quot;pushpolicies\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void SendPushModules()
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;admin\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;request\&quot; : &quot; + &quot;\&quot;pushmodules\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void FetchModules()
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;admin\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;request\&quot; : &quot; + &quot;\&quot;fetchmodules\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void SaveModule( string name , string contents )
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;admin\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;request\&quot; : &quot; + &quot;\&quot;savemodule\&quot;,&quot;;
                msg += &quot;\&quot;moduleName\&quot; : \&quot;&quot; + name + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;moduleContents\&quot; : \&quot;&quot; + Framework.Utils.Base64Encode( contents ) + &quot;\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        public void DeleteModule( string name )
        {
            try
            {
                var msg = &quot;{&quot;;
                msg += &quot;\&quot;peerPort\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;admin\&quot; : &quot; + &quot;\&quot;&quot; + ( this._clientPort + 1 ) + &quot;\&quot;,&quot;;
                msg += &quot;\&quot;request\&quot; : &quot; + &quot;\&quot;deletemodule\&quot;,&quot;;
                msg += &quot;\&quot;moduleName\&quot; : \&quot;&quot; + name + &quot;\&quot;&quot;;
                msg += &quot;}&quot;;

                var data = Encoding.UTF8.GetBytes( Framework.Utils.Base64Encode( msg ) );
                var stream = this._sendingClient.GetStream();
                stream.Write( data , 0 , data.Length );
                stream.Flush();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        public void Listener()
        {
            try
            {
                var localAddr = IPAddress.Parse( &quot;0.0.0.0&quot; );

                this._receivingClient = new TcpListener( localAddr , this._clientPort + 1 );
                this._receivingClient.Start();

                // Buffer for reading data
                var bytes = new Byte[1024];

                while( true )
                {
                    var client = this._receivingClient.AcceptTcpClient();
                    var stream = client.GetStream();

                    int i;
                    var data = &quot;&quot;;


                    while( ( i = stream.Read( bytes , 0 , bytes.Length ) ) != 0 )
                    {
                        data += Encoding.ASCII.GetString( bytes , 0 , i );
                    }

                    data = Framework.Utils.Base64Decode( data );

                    this.OnDataReceived( data );

                    client.Close();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Shuts down the listener
        /// &lt;/summary&gt;
        public void Shutdown()
        {
            try
            {
                this._tcpListenerThread.Abort();
                this._receivingClient.Stop();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src28', RANGES_28)
		</script>
	</body>
</html>