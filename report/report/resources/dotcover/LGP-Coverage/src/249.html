<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_249 = [
   [54,9,54,10,'dccv']
, [56,13,56,14,'dccv']
, [57,17,57,67,'dccv']
, [58,13,58,14,'dccv']
, [63,9,63,10,'dccv']
, [73,9,73,112,'dccv']
, [74,9,74,10,'dccv']
, [76,13,76,14,'dccv']
, [77,17,77,39,'dccv']
, [78,17,78,41,'dccv']
, [79,17,79,41,'dccv']
, [80,17,80,39,'dccv']
, [81,17,81,45,'dccv']
, [83,17,86,19,'dccv']
, [87,17,90,19,'dccv']
, [91,17,94,19,'dccv']
, [95,17,98,19,'dccv']
, [99,17,102,19,'dccv']
, [104,17,104,41,'dccv']
, [105,17,105,46,'dccv']
, [106,17,106,40,'dccv']
, [107,17,107,36,'dccv']
, [108,17,108,29,'dccv']
, [109,17,109,47,'dccv']
, [111,17,111,60,'dccv']
, [112,17,112,72,'dccv']
, [113,13,113,14,'dccv']
, [118,9,118,10,'dccv']
, [127,13,127,14,'dccv']
, [128,17,128,39,'dccv']
, [129,13,129,14,'dccv']
, [131,13,131,14,'dccv']
, [132,17,132,40,'dccv']
, [133,17,133,61,'dccv']
, [134,13,134,14,'dccv']
, [144,13,144,14,'dccv']
, [145,17,145,36,'dccv']
, [146,13,146,14,'dccv']
, [156,13,156,14,'dccv']
, [157,17,157,37,'dccv']
, [158,13,158,14,'dccv']
, [168,13,168,14,'dccv']
, [169,17,169,34,'dccv']
, [170,13,170,14,'dccv']
, [180,13,180,14,'dccv']
, [181,17,181,34,'dccv']
, [182,13,182,14,'dccv']
, [191,13,191,14,'dccv']
, [192,17,192,40,'dccv']
, [193,13,193,14,'dccv']
, [206,9,206,10,'dccv']
, [208,13,208,14,'dccv']
, [209,17,209,54,'dccv']
, [210,17,210,71,'dccv']
, [211,17,211,66,'dccv']
, [212,17,212,68,'dccv']
, [213,17,213,63,'dccv']
, [214,17,214,73,'dccv']
, [215,17,215,65,'dccv']
, [216,17,216,59,'dccv']
, [217,17,217,73,'dccv']
, [218,17,218,74,'dccv']
, [219,17,219,55,'dccv']
, [221,17,221,54,'dccv']
, [222,17,222,71,'dccv']
, [223,17,223,66,'dccv']
, [224,17,224,68,'dccv']
, [225,17,225,63,'dccv']
, [226,17,226,73,'dccv']
, [227,17,227,65,'dccv']
, [228,17,228,59,'dccv']
, [229,17,229,73,'dccv']
, [230,17,230,74,'dccv']
, [231,17,231,55,'dccv']
, [233,17,236,19,'dccv']
, [237,17,237,85,'dccv']
, [239,17,242,19,'dccv']
, [243,17,243,93,'dccv']
, [245,17,245,136,'dccv']
, [247,17,247,92,'dccv']
, [249,17,249,136,'dccv']
, [251,17,251,92,'dccv']
, [252,13,252,14,'dccv']
, [257,9,257,10,'dccv']
, [260,9,260,10,'dccv']
, [261,13,261,55,'dccv']
, [262,9,262,10,'dccv']
, [271,9,271,10,'dccv']
, [273,13,273,14,'dccv']
, [274,17,274,90,'dccv']
, [275,17,275,95,'dccv']
, [277,17,277,90,'dccv']
, [278,17,278,95,'dccv']
, [280,17,283,19,'dccv']
, [284,17,284,77,'dccv']
, [285,17,285,44,'dccv']
, [286,13,286,14,'dccv']
, [291,9,291,10,'dccv']
, [294,9,294,10,'dccv']
, [296,13,296,14,'dccv']
, [297,17,297,95,'dccv']
, [298,17,298,95,'dccv']
, [299,13,299,14,'dccv']
, [304,9,304,10,'dccv']
, [307,9,307,10,'dccv']
, [309,13,309,14,'dccv']
, [310,17,313,19,'dccv']
, [314,17,314,111,'dccv']
, [315,17,315,111,'dccv']
, [317,17,320,21,'dccv']
, [321,17,324,21,'dccv']
, [325,17,328,21,'dccv']
, [329,17,332,21,'dccv']
, [333,17,336,21,'dccv']
, [337,13,337,14,'dccv']
, [342,9,342,10,'dccv']
, [346,9,346,10,'dccv']
, [348,13,348,14,'dccv']
, [349,17,349,71,'dccv']
, [350,17,350,92,'dccv']
, [351,17,351,92,'dccv']
, [352,17,352,83,'dccv']
, [353,17,353,83,'dccv']
, [354,17,354,81,'dccv']
, [355,17,355,81,'dccv']
, [356,13,356,14,'dccv']
, [361,9,361,10,'dccv']
, [365,9,365,10,'dccv']
, [367,13,367,14,'dccv']
, [368,17,368,83,'dccv']
, [369,17,369,66,'dccv']
, [370,17,370,64,'dccv']
, [371,17,371,66,'dccv']
, [372,17,372,59,'dccv']
, [373,13,373,14,'dccv']
, [378,9,378,10,'dccv']
, [382,9,382,10,'dccv']
, [384,13,384,14,'dccv']
, [385,17,385,52,'dccv']
, [386,17,386,38,'dccv']
, [390,13,390,14,'dccv']
, [395,9,395,10,'dccv']
, [399,9,399,10,'dccv']
, [401,13,401,14,'dccv']
, [402,17,405,19,'dccv']
, [407,17,407,63,'dccv']
, [408,17,408,65,'dccv']
, [409,13,409,14,'dccv']
, [414,9,414,10,'dccv']
, [418,9,418,10,'dccv']
, [420,13,420,14,'dccv']
, [421,17,421,63,'dccv']
, [422,17,422,65,'dccv']
, [423,13,423,14,'dccv']
, [428,9,428,10,'dccv']
, [432,9,432,10,'dccv']
, [434,13,434,14,'dccv']
, [435,17,435,87,'dccv']
, [436,17,436,40,'dccv']
, [437,17,437,18,'dccv']
, [438,21,438,51,'dccv']
, [440,21,440,85,'dccv']
, [441,21,441,22,'dccv']
, [442,25,442,64,'dccv']
, [443,25,443,26,'dccv']
, [444,29,444,62,'dccv']
, [445,29,445,51,'dccv']
, [446,25,446,26,'dccv']
, [448,25,448,50,'dccv']
, [450,25,450,86,'dccv']
, [451,25,451,86,'dccv']
, [452,21,452,22,'dccv']
, [458,17,458,18,'dccv']
, [459,13,459,14,'dccv']
, [464,9,464,10,'dccv']
, [467,9,467,10,'dccv']
, [469,13,469,14,'dccv']
, [470,17,470,60,'dccv']
, [472,17,472,90,'dccv']
, [474,17,474,79,'dccv']
, [476,17,476,24,'dccv']
, [476,41,476,51,'dccv']
, [476,26,476,37,'dccv']
, [477,17,477,18,'dccv']
, [478,21,478,76,'dccv']
, [479,21,479,22,'dccv']
, [480,25,480,69,'dccv']
, [481,21,481,22,'dccv']
, [482,17,482,18,'dccv']
, [476,38,476,40,'dccv']
, [483,13,483,14,'dccv']
, [488,9,488,10,'dccv']
, [492,9,492,10,'dccv']
, [494,13,494,14,'dccv']
, [495,17,495,47,'dccv']
, [496,17,496,18,'dccv']
, [497,21,497,102,'dccv']
, [498,21,498,66,'dccv']
, [500,21,500,61,'dccv']
, [503,21,503,22,'dccv']
, [504,25,504,69,'dccv']
, [505,25,505,26,'dccv']
, [506,29,506,43,'dccv']
, [507,29,507,66,'dccv']
, [508,25,508,26,'dccv']
, [509,21,509,22,'dccv']
, [502,21,502,43,'dccv']
, [511,21,511,36,'dccv']
, [512,21,512,40,'dccv']
, [513,17,513,18,'dccv']
, [514,13,514,14,'dccv']
, [519,9,519,10,'dccv']
, [523,9,523,10,'dccv']
, [525,13,525,14,'dccv']
, [526,17,526,56,'dccv']
, [527,17,527,18,'dccv']
, [528,21,528,102,'dccv']
, [529,21,529,66,'dccv']
, [530,21,530,114,'dccv']
, [531,21,531,36,'dccv']
, [532,21,532,40,'dccv']
, [533,17,533,18,'dccv']
, [534,13,534,14,'dccv']
, [539,9,539,10,'dccv']
, [542,9,542,10,'dccv']
, [543,13,543,53,'dccv']
, [544,9,544,10,'dccv']
, [554,9,554,10,'dccv']
, [556,13,556,14,'dccv']
, [557,17,557,89,'dccv']
, [558,17,558,37,'dccv']
, [561,17,561,53,'dccv']
, [562,17,562,40,'dccv']
, [565,17,565,18,'dccv']
, [566,21,566,70,'dccv']
, [567,21,567,102,'dccv']
, [568,21,568,22,'dccv']
, [569,25,569,32,'dccv']
, [570,21,570,22,'dccv']
, [572,21,572,22,'dccv']
, [573,25,573,81,'dccv']
, [574,25,574,29,'dccv']
, [575,21,575,22,'dccv']
, [576,17,576,18,'dccv']
, [564,17,564,62,'dccv']
, [578,17,578,44,'dccv']
, [579,17,579,18,'dccv']
, [580,21,583,23,'dccv']
, [584,21,585,21,'dccv']
, [586,55,587,23,'dccv']
, [589,21,589,85,'dccv']
, [591,26,591,36,'dccv']
, [592,21,592,22,'dccv']
, [593,25,593,77,'dccv']
, [594,25,594,26,'dccv']
, [595,29,595,102,'dccv']
, [596,25,596,26,'dccv']
, [597,21,597,22,'dccv']
, [591,65,591,68,'dccv']
, [591,37,591,63,'dccv']
, [599,26,599,36,'dccv']
, [600,21,600,22,'dccv']
, [601,25,601,80,'dccv']
, [602,25,602,26,'dccv']
, [603,29,603,105,'dccv']
, [604,25,604,26,'dccv']
, [605,21,605,22,'dccv']
, [599,68,599,71,'dccv']
, [599,37,599,66,'dccv']
, [607,21,607,41,'dccv']
, [608,21,608,22,'dccv']
, [609,25,609,55,'dccv']
, [610,21,610,22,'dccv']
, [611,17,611,18,'dccv']
, [613,17,613,72,'dccv']
, [614,13,614,14,'dccv']
, [619,9,619,10,'dccv']
, [623,9,623,10,'dccv']
, [624,13,624,36,'dccv']
, [625,9,625,10,'dccv']
, [633,9,633,10,'dccv']
, [635,13,635,14,'dccv']
, [636,17,636,74,'dccv']
, [637,17,637,18,'dccv']
, [638,21,638,63,'dccv']
, [639,21,639,22,'dccv']
, [640,25,640,85,'dccv']
, [641,21,641,22,'dccv']
, [642,17,642,18,'dccv']
, [643,13,643,14,'dccv']
, [648,9,648,10,'dccv']
, [674,9,674,10,'dccv']
, [675,13,675,39,'dccv']
, [676,9,676,10,'dccv']
, [686,9,686,10,'dccv']
, [688,13,688,14,'dccv']
, [689,17,689,39,'dccv']
, [691,17,691,88,'dccv']
, [692,17,692,73,'dccv']
, [694,17,694,98,'dccv']
, [695,17,695,18,'dccv']
, [696,21,696,153,'dccv']
, [697,21,697,76,'dccv']
, [698,21,698,69,'dccv']
, [699,17,699,18,'dccv']
, [700,13,700,14,'dccv']
, [705,9,705,10,'dccv']
, [756,9,756,10,'dccv']
, [758,13,758,14,'dccv']
, [759,17,759,42,'dccv']
, [760,17,760,18,'dccv']
, [761,21,761,49,'dccv']
, [762,21,762,41,'dccv']
, [763,17,763,18,'dccv']
, [764,13,764,14,'dccv']
, [769,9,769,10,'dccv']
, [585,21,585,22,'dccv']
, [586,25,586,55,'dccv']
, [59,13,59,37,'dcuc']
, [60,13,60,14,'dcuc']
, [61,17,61,53,'dcuc']
, [62,13,62,14,'dcuc']
, [114,13,114,37,'dcuc']
, [115,13,115,14,'dcuc']
, [116,17,116,53,'dcuc']
, [117,13,117,14,'dcuc']
, [253,13,253,37,'dcuc']
, [254,13,254,14,'dcuc']
, [255,17,255,53,'dcuc']
, [256,13,256,14,'dcuc']
, [265,9,265,10,'dcuc']
, [266,13,266,55,'dcuc']
, [267,9,267,10,'dcuc']
, [287,13,287,37,'dcuc']
, [288,13,288,14,'dcuc']
, [289,17,289,53,'dcuc']
, [290,13,290,14,'dcuc']
, [300,13,300,37,'dcuc']
, [301,13,301,14,'dcuc']
, [302,17,302,53,'dcuc']
, [303,13,303,14,'dcuc']
, [338,13,338,37,'dcuc']
, [339,13,339,14,'dcuc']
, [340,17,340,53,'dcuc']
, [341,13,341,14,'dcuc']
, [357,13,357,37,'dcuc']
, [358,13,358,14,'dcuc']
, [359,17,359,53,'dcuc']
, [360,13,360,14,'dcuc']
, [374,13,374,37,'dcuc']
, [375,13,375,14,'dcuc']
, [376,17,376,53,'dcuc']
, [377,13,377,14,'dcuc']
, [387,17,387,18,'dcuc']
, [388,21,388,76,'dcuc']
, [389,17,389,18,'dcuc']
, [391,13,391,37,'dcuc']
, [392,13,392,14,'dcuc']
, [393,17,393,53,'dcuc']
, [394,13,394,14,'dcuc']
, [410,13,410,37,'dcuc']
, [411,13,411,14,'dcuc']
, [412,17,412,53,'dcuc']
, [413,13,413,14,'dcuc']
, [424,13,424,37,'dcuc']
, [425,13,425,14,'dcuc']
, [426,17,426,53,'dcuc']
, [427,13,427,14,'dcuc']
, [454,21,454,22,'dcuc']
, [455,25,455,127,'dcuc']
, [456,25,456,127,'dcuc']
, [457,21,457,22,'dcuc']
, [460,13,460,37,'dcuc']
, [461,13,461,14,'dcuc']
, [462,17,462,53,'dcuc']
, [463,13,463,14,'dcuc']
, [484,13,484,37,'dcuc']
, [485,13,485,14,'dcuc']
, [486,17,486,53,'dcuc']
, [487,13,487,14,'dcuc']
, [515,13,515,37,'dcuc']
, [516,13,516,14,'dcuc']
, [517,17,517,53,'dcuc']
, [518,13,518,14,'dcuc']
, [535,13,535,37,'dcuc']
, [536,13,536,14,'dcuc']
, [537,17,537,53,'dcuc']
, [538,13,538,14,'dcuc']
, [548,9,548,10,'dcuc']
, [549,13,549,53,'dcuc']
, [550,9,550,10,'dcuc']
, [615,13,615,37,'dcuc']
, [616,13,616,14,'dcuc']
, [617,17,617,53,'dcuc']
, [618,13,618,14,'dcuc']
, [628,9,628,10,'dcuc']
, [629,13,629,36,'dcuc']
, [630,9,630,10,'dcuc']
, [644,13,644,37,'dcuc']
, [645,13,645,14,'dcuc']
, [646,17,646,53,'dcuc']
, [647,13,647,14,'dcuc']
, [655,9,655,10,'dcuc']
, [657,13,657,14,'dcuc']
, [658,17,658,98,'dcuc']
, [659,17,659,61,'dcuc']
, [660,17,660,61,'dcuc']
, [661,13,661,14,'dcuc']
, [662,13,662,37,'dcuc']
, [663,13,663,14,'dcuc']
, [664,17,664,53,'dcuc']
, [665,13,665,14,'dcuc']
, [666,9,666,10,'dcuc']
, [701,13,701,37,'dcuc']
, [702,13,702,14,'dcuc']
, [703,17,703,53,'dcuc']
, [704,13,704,14,'dcuc']
, [712,9,712,10,'dcuc']
, [714,13,714,14,'dcuc']
, [715,13,715,14,'dcuc']
, [716,13,716,37,'dcuc']
, [717,13,717,14,'dcuc']
, [718,17,718,53,'dcuc']
, [719,13,719,14,'dcuc']
, [720,9,720,10,'dcuc']
, [727,9,727,10,'dcuc']
, [729,13,729,14,'dcuc']
, [730,13,730,14,'dcuc']
, [731,13,731,37,'dcuc']
, [732,13,732,14,'dcuc']
, [733,17,733,53,'dcuc']
, [734,13,734,14,'dcuc']
, [735,9,735,10,'dcuc']
, [741,9,741,10,'dcuc']
, [743,13,743,14,'dcuc']
, [744,13,744,14,'dcuc']
, [745,13,745,37,'dcuc']
, [746,13,746,14,'dcuc']
, [747,17,747,53,'dcuc']
, [748,13,748,14,'dcuc']
, [749,9,749,10,'dcuc']
, [765,13,765,37,'dcuc']
, [766,13,766,14,'dcuc']
, [767,17,767,53,'dcuc']
, [768,13,768,14,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src249" class="dotCoverSource"><pre>#region

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.IO;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Input;
using System.Windows.Threading;
using System.Xml;
using ICSharpCode.AvalonEdit;
using ICSharpCode.AvalonEdit.CodeCompletion;
using ICSharpCode.AvalonEdit.Document;
using ICSharpCode.AvalonEdit.Folding;
using ICSharpCode.AvalonEdit.Highlighting;
using ICSharpCode.AvalonEdit.Highlighting.Xshd;
using ICSharpCode.AvalonEdit.Rendering;
using LGP.Components.Factory;
using LGP.Components.Factory.Interfaces.Database;
using LGP.Modules.ModuleEditor.Internal.AvalonEditHelpers;

#endregion

namespace LGP.Modules.ModuleEditor.Internal
{
    /// &lt;summary&gt;
    /// &lt;/summary&gt;
    public class ModuleDocument : INotifyPropertyChanged , IModuleObserver
    {
        private static readonly BraceFoldingStrategy BraceFoldingStrategy;
        private static List&lt; string &gt; _perlMethodNames;
        private static IHighlightingDefinition _perlHighlighterDefintion;
        private readonly Label _col;
        private readonly TextEditor _editor1;
        private readonly TextEditor _editor2;
        private readonly Label _length;
        private readonly Label _lines;
        private readonly ModuleEditor _parent;
        private readonly Label _row;
        private readonly Label _selection;
        private CompletionWindow _completionWindow;
        private TextDocument _document;
        private FoldingManager _foldingManager1;
        private FoldingManager _foldingManager2;
        private int _hashContents;
        private IModule _module;
        private List&lt; string &gt; _perlVariables;


        static ModuleDocument()
        {
            try
            {
                BraceFoldingStrategy = new BraceFoldingStrategy();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Constructor
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;parent&quot;&gt;ModuleEditor&lt;/param&gt;
        /// &lt;param name = &quot;module&quot;&gt;Document to bind&lt;/param&gt;
        /// &lt;param name = &quot;avalon1&quot;&gt;TextEditor&lt;/param&gt;
        /// &lt;param name = &quot;avalon2&quot;&gt;TextEditor&lt;/param&gt;
        public ModuleDocument( IModule module , ModuleEditor parent , TextEditor avalon1 , TextEditor avalon2 )
        {
            try
            {
                this._parent = parent;
                this._editor1 = avalon1;
                this._editor2 = avalon2;
                this._module = module;
                this._module.Attach( this );

                this._col = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._length = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._lines = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._row = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };
                this._selection = new Label
                {
                    Margin = new Thickness( 0 ) , Padding = new Thickness( 0 ) , FontSize = 12 , Height = 28 , Content = &quot;0&quot;
                };

                this.SetUpLookAndFeel();
                this.PrepareEditorContents();
                this.LoadHighlighter();
                this.SetHandlers();
                this.Bind();
                this.PrepareFoldingStrategy();

                this._document.UndoStack = new UndoStack();
                this._hashContents = this._document.Text.GetHashCode();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Document associated with this object
        /// &lt;/summary&gt;
        public TextDocument Document
        {
            get
            {
                return this._document;
            }
            set
            {
                this._document = value;
                this.OnPropertyChanged( &quot;DocumentChanged&quot; );
            }
        }


        /// &lt;summary&gt;
        ///   Get the lines count
        /// &lt;/summary&gt;
        public Label LineCount
        {
            get
            {
                return this._lines;
            }
        }


        /// &lt;summary&gt;
        ///   Get the module lenght
        /// &lt;/summary&gt;
        public Label FileLength
        {
            get
            {
                return this._length;
            }
        }


        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public Label CaretRow
        {
            get
            {
                return this._row;
            }
        }


        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public Label CaretCol
        {
            get
            {
                return this._col;
            }
        }

        /// &lt;summary&gt;
        ///   Get the caret row
        /// &lt;/summary&gt;
        public Label SelectionLength
        {
            get
            {
                return this._selection;
            }
        }

        #region INotifyPropertyChanged Members

        /// &lt;summary&gt;
        ///   Event for the document change
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        #endregion

        private void SetUpLookAndFeel()
        {
            try
            {
                this._editor1.ShowLineNumbers = true;
                this._editor1.Options.AllowScrollBelowDocument = true;
                this._editor1.Options.ConvertTabsToSpaces = true;
                this._editor1.Options.EnableEmailHyperlinks = true;
                this._editor1.Options.EnableHyperlinks = true;
                this._editor1.Options.EnableRectangularSelection = true;
                this._editor1.Options.EnableTextDragDrop = true;
                this._editor1.Options.IndentationSize = 4;
                this._editor1.Options.InheritWordWrapIndentation = true;
                this._editor1.Options.ShowBoxForControlCharacters = true;
                this._editor1.Options.ShowTabs = true;

                this._editor2.ShowLineNumbers = true;
                this._editor2.Options.AllowScrollBelowDocument = true;
                this._editor2.Options.ConvertTabsToSpaces = true;
                this._editor2.Options.EnableEmailHyperlinks = true;
                this._editor2.Options.EnableHyperlinks = true;
                this._editor2.Options.EnableRectangularSelection = true;
                this._editor2.Options.EnableTextDragDrop = true;
                this._editor2.Options.IndentationSize = 4;
                this._editor2.Options.InheritWordWrapIndentation = true;
                this._editor2.Options.ShowBoxForControlCharacters = true;
                this._editor2.Options.ShowTabs = true;

                var myBinding = new Binding( &quot;WordWrap&quot; )
                {
                    Source = this._editor1
                };
                this._editor2.SetBinding( TextEditor.WordWrapProperty , myBinding );

                var myBinding2 = new Binding( &quot;ShowLineNumbers&quot; )
                {
                    Source = this._editor1
                };
                this._editor2.SetBinding( TextEditor.ShowLineNumbersProperty , myBinding2 );

                this._editor1.TextArea.TextView.BackgroundRenderers.Add( new HighlightCurrentLineBackgroundRenderer( this._editor1 ) );

                this._editor1.TextArea.Caret.PositionChanged += this.CaretPositionChanged1;

                this._editor2.TextArea.TextView.BackgroundRenderers.Add( new HighlightCurrentLineBackgroundRenderer( this._editor2 ) );

                this._editor2.TextArea.Caret.PositionChanged += this.CaretPositionChanged2;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void CaretPositionChanged1( object sender , EventArgs e )
        {
            this.CaretChangedUpdater( this._editor1 );
        }

        private void CaretPositionChanged2( object sender , EventArgs e )
        {
            this.CaretChangedUpdater( this._editor2 );
        }


        private void PrepareFoldingStrategy()
        {
            try
            {
                this._foldingManager1 = FoldingManager.Install( this._editor1.TextArea );
                BraceFoldingStrategy.UpdateFoldings( this._foldingManager1 , this._document );

                this._foldingManager2 = FoldingManager.Install( this._editor2.TextArea );
                BraceFoldingStrategy.UpdateFoldings( this._foldingManager2 , this._document );

                var foldingUpdateTimer = new DispatcherTimer
                {
                    Interval = TimeSpan.FromSeconds( 3 )
                };
                foldingUpdateTimer.Tick += this.BraceFoldingUpdateTimerTick;
                foldingUpdateTimer.Start();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void BraceFoldingUpdateTimerTick( object sender , EventArgs e )
        {
            try
            {
                BraceFoldingStrategy.UpdateFoldings( this._foldingManager1 , this._document );
                BraceFoldingStrategy.UpdateFoldings( this._foldingManager2 , this._document );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void Bind()
        {
            try
            {
                var documentBinding = new Binding( &quot;Document&quot; )
                {
                    Source = this
                };
                BindingOperations.SetBinding( this._editor1 , TextEditor.DocumentProperty , documentBinding );
                BindingOperations.SetBinding( this._editor2 , TextEditor.DocumentProperty , documentBinding );

                BindingOperations.SetBinding( this._parent.FileLine , ContentControl.ContentProperty , new Binding( &quot;CaretRow&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileColumn , ContentControl.ContentProperty , new Binding( &quot;CaretCol&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileSelection , ContentControl.ContentProperty , new Binding( &quot;SelectionLength&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileLength , ContentControl.ContentProperty , new Binding( &quot;FileLength&quot; )
                {
                    Source = this
                } );
                BindingOperations.SetBinding( this._parent.FileLines , ContentControl.ContentProperty , new Binding( &quot;LineCount&quot; )
                {
                    Source = this
                } );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void SetHandlers()
        {
            try
            {
                this.Document.TextChanged += this.DocumentTextChanged;
                this._editor1.TextArea.Caret.PositionChanged += this.CaretPositionChanged1;
                this._editor2.TextArea.Caret.PositionChanged += this.CaretPositionChanged2;
                this._editor1.TextArea.TextEntering += this.TextAreaTextEntering1;
                this._editor2.TextArea.TextEntering += this.TextAreaTextEntering2;
                this._editor1.TextArea.TextEntered += this.TextAreaTextEntered1;
                this._editor2.TextArea.TextEntered += this.TextAreaTextEntered2;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void CaretChangedUpdater( TextEditor editor )
        {
            try
            {
                editor.TextArea.TextView.InvalidateLayer( KnownLayer.Background );
                this._col.Content = editor.TextArea.Caret.Column;
                this._row.Content = editor.TextArea.Caret.Line;
                this._selection.Content = editor.SelectionLength;
                this._length.Content = editor.Text.Length;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void OnPropertyChanged( string info )
        {
            try
            {
                var handler = this.PropertyChanged;
                if( handler != null )
                {
                    handler( this , new PropertyChangedEventArgs( info ) );
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void PrepareEditorContents()
        {
            try
            {
                this.Document = new TextDocument
                {
                    Text = this._module.FileContents
                };

                this._lines.Content = this.Document.LineCount;
                this._length.Content = this.Document.TextLength;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void DocumentTextChanged( object sender , EventArgs e )
        {
            try
            {
                this._lines.Content = this.Document.LineCount;
                this._length.Content = this.Document.TextLength;
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void LoadHighlighter()
        {
            try
            {
                var extension = Path.GetExtension( this._module.GetModuleLocation() );
                if( extension != null )
                {
                    var ext = extension.ToLower();

                    if( ext.CompareTo( &quot;.pl&quot; ) == 0 || ext.CompareTo( &quot;.pm&quot; ) == 0 )
                    {
                        if( _perlHighlighterDefintion == null )
                        {
                            this.LoadPerlSyntaxHighlighter();
                            LoadPerlMethodNames();
                        }

                        this.ScanVariableNames();

                        this._editor1.SyntaxHighlighting = _perlHighlighterDefintion;
                        this._editor2.SyntaxHighlighting = _perlHighlighterDefintion;
                    }
                    else
                    {
                        this._editor1.SyntaxHighlighting = HighlightingManager.Instance.GetDefinitionByExtension( extension );
                        this._editor2.SyntaxHighlighting = HighlightingManager.Instance.GetDefinitionByExtension( extension );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void ScanVariableNames()
        {
            try
            {
                this._perlVariables = new List&lt; string &gt;();

                var variableRegex = new Regex( &quot;(\\${1,2}|\\$?@|\\$?%)([A-Za-z0-9_]+)&quot; );

                var collection = variableRegex.Matches( this._document.Text );

                foreach( Match match in collection )
                {
                    if( !this._perlVariables.Contains( match.ToString() ) )
                    {
                        this._perlVariables.Add( match.ToString() );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private static void LoadPerlMethodNames()
        {
            try
            {
                if( _perlMethodNames == null )
                {
                    var fileStream = new FileStream( &quot;perl.xshd&quot; , FileMode.Open , FileAccess.Read );
                    var reader = new XmlTextReader( fileStream );

                    _perlMethodNames = new List&lt; string &gt;();

                    while( reader.Read() )
                    {
                        if( reader.NodeType == XmlNodeType.Element )
                        {
                            reader.Read();
                            _perlMethodNames.Add( reader.Value );
                        }
                    }

                    reader.Close();
                    fileStream.Close();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void LoadPerlSyntaxHighlighter()
        {
            try
            {
                if( _perlHighlighterDefintion == null )
                {
                    var fileStream = new FileStream( &quot;perl.xshd&quot; , FileMode.Open , FileAccess.Read );
                    var reader = new XmlTextReader( fileStream );
                    _perlHighlighterDefintion = HighlightingLoader.Load( reader , HighlightingManager.Instance );
                    reader.Close();
                    fileStream.Close();
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        private void TextAreaTextEntered1( object sender , TextCompositionEventArgs e )
        {
            this.HandleTextEntered( this._editor1 );
        }


        private void TextAreaTextEntered2( object sender , TextCompositionEventArgs e )
        {
            this.HandleTextEntered( this._editor2 );
        }


        private void HandleTextEntered( TextEditor editor )
        {
            try
            {
                var currentline = editor.Document.GetLineByOffset( editor.CaretOffset );
                var startswith = &quot;&quot;;
                const char space = &#39; &#39;;

                var currentPos = editor.CaretOffset;
                var i = currentPos - 1;

                while( i &gt; -1 &amp;&amp; i &gt; currentline.Offset - 1 )
                {
                    var previousChar = this._document.GetCharAt( i );
                    if( previousChar.CompareTo( space ) == 0 || previousChar.CompareTo( &#39;\t&#39; ) == 0 )
                    {
                        i = -2;
                    }
                    else
                    {
                        startswith = this._document.GetCharAt( i ) + startswith;
                        i--;
                    }
                }

                if( startswith.Length &gt; 0 )
                {
                    this._completionWindow = new CompletionWindow( editor.TextArea )
                    {
                        WindowStyle = WindowStyle.None , Background = null , AllowsTransparency = true
                    };
                    this._completionWindow.Closed += delegate
                    {
                        this._completionWindow = null;
                    };

                    var data = this._completionWindow.CompletionList.CompletionData;

                    for( var h = 0; h &lt; _perlMethodNames.Count; h++ )
                    {
                        if( _perlMethodNames[ h ].StartsWith( startswith ) )
                        {
                            data.Add( new CompletionData( _perlMethodNames[ h ] , startswith , 0 ) );
                        }
                    }

                    for( var h = 0; h &lt; this._perlVariables.Count; h++ )
                    {
                        if( this._perlVariables[ h ].StartsWith( startswith ) )
                        {
                            data.Add( new CompletionData( this._perlVariables[ h ] , startswith , 1 ) );
                        }
                    }

                    if( data.Count &gt; 0 )
                    {
                        this._completionWindow.Show();
                    }
                }

                this._hashContents = this._document.Text.GetHashCode();
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        private void TextAreaTextEntering1( object sender , TextCompositionEventArgs e )
        {
            this.TextEntering( e );
        }

        private void TextAreaTextEntering2( object sender , TextCompositionEventArgs e )
        {
            this.TextEntering( e );
        }

        private void TextEntering( TextCompositionEventArgs e )
        {
            try
            {
                if( e.Text.Length &gt; 0 &amp;&amp; this._completionWindow != null )
                {
                    if( !char.IsLetterOrDigit( e.Text[ 0 ] ) )
                    {
                        this._completionWindow.CompletionList.RequestInsertion( e );
                    }
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;text&quot;&gt;&lt;/param&gt;
        public void GoTo( string text )
        {
            try
            {
                var location = this._document.GetLocation( this._document.Text.IndexOf( text ) );
                this._editor1.ScrollToLine( location.Line );
                this._editor2.ScrollToLine( location.Line );
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }


        /// &lt;summary&gt;
        ///   Gets the has of the document
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public int GetHash()
        {
            return this._hashContents;
        }

        #region Implementation of IModuleObserver

        /// &lt;summary&gt;
        ///   Update this observer with a refernece to the module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;module&quot;&gt;IModule&lt;/param&gt;
        /// &lt;param name = &quot;source&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Update( IModule module , IModuleObserver source )
        {
            try
            {
                this._module = module;

                var replacePackage = new Regex( &quot;package\\s+([A-Za-z0-9_]+)(\\s+)?;&quot; );
                var match = replacePackage.Match( this._document.Text );

                if( this._module.GetModuleName().CompareTo( match.Groups[ 1 ].ToString() ) != 0 )
                {
                    this._document.Text = this._document.Text.Replace( match.Groups[ 0 ].ToString() , &quot;package &quot; + this._module.GetModuleName() + &quot;;&quot; );
                    this._hashContents = this._document.Text.GetHashCode();
                    this._module.FileContents = this._document.Text;
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Attach objewcts that observer this module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Attach( IModuleObserver obj )
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Detach objewcts that observer this module
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Detach( IModuleObserver obj )
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Notify observers of this module
        /// &lt;/summary&gt;
        public void Notify()
        {
            try
            {
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        /// &lt;summary&gt;
        ///   Dispose this object and all the observers
        /// &lt;/summary&gt;
        /// &lt;param name = &quot;obj&quot;&gt;IModuleObserver&lt;/param&gt;
        public void Dispose( IModuleObserver obj )
        {
            try
            {
                if (this._module != null)
                {
                    this._module.Detach( this );
                    this._module = null;
                }
            }
            catch( Exception error )
            {
                Framework.EventBus.Publish( error );
            }
        }

        #endregion
    }
}</pre></code><script type="text/javascript">
			applyranges('src249', RANGES_249)
		</script>
	</body>
</html>